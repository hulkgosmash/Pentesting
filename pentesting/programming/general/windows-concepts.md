# Windows Concepts

## indows On Windows

Most Windows-based machines use the 64-bit version of the Windows operating system. However, many applications are still 32-bit.

To facilitate this, Microsoft introduced the concept of _Windows On Windows 64-bit_ (_WOW64_) which allows a 64-bit version of Windows to execute 32-bit applications with almost no loss of efficiency.

WOW64 utilizes four 64-bit libraries (Ntdll.dll, Wow64.dll, Wow64Win.dll and Wow64Cpu.dll) to emulate the execution of 32-bit code and perform translations between the application and the kernel.

On 32-bit versions of Windows, most native Windows applications and libraries are stored in C:\Windows\System32. On 64-bit versions of Windows, 64-bit native programs and DLLs are stored in C:\Windows\System32 and 32-bit versions are stored in C:\Windows\SysWOW64.

As penetration testers, we must remain aware of the architecture or _bitness_ of our targets, since this dictates the type of shellcode and other compiled code that we can use.

## Win32 APIs

The Windows operating system, and its various applications are written in a variety of programming languages ranging from assembly to C# but many of those make use of the Windows-provided built-in _application programming interfaces_ (or _APIs_).

These interfaces, known as the _Win32 API_, offer developers pre-built functionality. The APIs themselves are designed to be invoked from C and are documented with C-style data types but as we will discover throughout this course, they can be used with multiple other languages.

Many of the Win32 APIs are documented by Microsoft. One simple example is the _GetUserNameA_ API exported by Advapi32.dll which retrieves the name of the user executing the function.

The syntax section of the documentation shows the _function prototype_[3](https://portal.offensive-security.com/courses/pen-300/books-and-videos/modal/modules/operating-system-and-programming-theory/windows-concepts/win32-apis#fn3) that details the number and type of arguments along with the return type:

```c
BOOL GetUserNameA(
  LPSTR   lpBuffer,
  LPDWORD pcbBuffer
);
```

In this example, the API requires two arguments. The first is an output buffer of type _LPSTR_ which is the Microsoft term for a character array. The second argument is a pointer to a _DWORD_ which is a 32-bit unsigned integer. The return value from the API is a boolean.

We will make extensive use of various Win32 APIs and their associated Microsoft data types throughout this course. As we use these APIs we must keep in mind two particular details. First, we must determine if the process is 32-bit or 64-bit since some arguments and their size depend on the bitness. Second, we must distinguish between the use of _ASCII_ and _Unicode_ (which Microsoft sometimes refers to as _UTF-16_). Since ASCII characters use one byte and Unicode uses at least two, many of the Win32 APIs are available in two distinct versions.

Listing 2 above shows the prototype for _GetUserNameA_, where the suffix "A" indicates the ASCII version of the API. Listing 3 below shows the prototype for _GetUserNameW_, in which the "W" suffix (for "wide char") indicates Unicode:

```c
BOOL GetUserNameW(
  LPWSTR  lpBuffer,
  LPDWORD pcbBuffer
);
```

The first argument type is now of type _LPWSTR_ which is a UNICODE character array.

We will be using the Win32 APIs extensively in this course.

## Windows Registry

Many programming languages support the concept of local and global variables, where local variables are limited in scope and global variables are usable anywhere in the code. An operating system needs global variables in much the same manner. Windows uses the _registry_ to store many of these.

In this section, we'll discuss the registry since it contains important information that can be abused during attacks, and some modifications may allow us to bypass specific defenses.

The registry is effectively a database that consists of a massive number of keys with associated values. These keys are sorted hierarchically using subkeys.

At the root, multiple _registry hives_ contain logical divisions of registry keys. Information related to the current user is stored in the _HKEY\_CURRENT\_USER_ (_HKCU_) hive, while information related to the operating system itself is stored in the _HKEY\_LOCAL\_MACHINE_ (_HKLM_) hive.

We can interface with the registry both programmatically through the Win32 APIs as well as through the GUI with tools like the Registry Editor (_regedit_) shown in Figure 1.

<figure><img src="../../../.gitbook/assets/7O6sknRCBpo-ospt_reg_regedit.png" alt=""><figcaption><p>Registry editor in Windows</p></figcaption></figure>

Since a 64-bit version of Windows can execute 32-bit applications each registry hive contains a duplicate section called _Wow6432Node_ which stores the appropriate 32-bit settings.

The registry is used extensively by the operating system and a variety of applications. As penetration testers, we can obtain various reconnaissance information from it or modify it to improve attacks or perform evasion.
