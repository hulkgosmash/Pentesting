# Cracking .NET Software Protection

### How to protect .NET programs

• Anti IL Dasm Protection

• Anti Tamper Protection

• Constants Protection

• Control Flow Protection

• Anti Dump Protection

• Anti Debug Protection • Invalid Metadata Protection

• Reference Proxy Protection • Resources Protection

• Name Protection

### Obfuscation

Confuserex

[https://yck1509.github.io/ConfuserEx/](https://yck1509.github.io/ConfuserEx/)

### De-Obfuscation

* De4dot
* UnconfuserEx Tools ( 9 tools)
* dnSpy

### Protect Software with Confuser v1.9

1. Open Confuser v.1.9.0.0
2. Drag and drop a file onto it

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

3. Click on **Options** then select **Use Packer**

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

4. Click on **Basic Settings** and set the **Preset** to **Maximum**

<figure><img src="../../../.gitbook/assets/image (4) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

5. Click on **Advanced Setttings** then select the binary. Set the drop down box to **Maximum** then click **Apply to Members**

<figure><img src="../../../.gitbook/assets/image (5) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

6. Click on **Confuse!**

<figure><img src="../../../.gitbook/assets/image (6) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

7. Binary will be saved in a subdirectory called **Confused**

### Deobfuscating Confuser 19

1. Run de4dot to unobfuscate the binary

`de4dot CrackMe18.exe`

<figure><img src="../../../.gitbook/assets/image (124).png" alt=""><figcaption></figcaption></figure>

2. View file in dnSpy and find that stringss are visible now

<figure><img src="../../../.gitbook/assets/image (125).png" alt=""><figcaption></figcaption></figure>

### Protecting software with ConfuserEx

1. Open ConfuserEx
2. Drag and drop a file onto it

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

3. Select **Settings** then check **Packer** box and select **Compressor**. Highlight the module that was selected earlier then select the **+** button so that the Rule true shows up as true. Then click on the **edit** button.&#x20;

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

4. Select the **Preset** drop down box and select the option **Maximum**. Click on the box for **Inherit protections** then click on Done.&#x20;

<figure><img src="../../../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

5. Click on Protect! tab then click Protect!.&#x20;

<figure><img src="../../../.gitbook/assets/image (4) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

6. Binary will be saved in a subdirectory called **Confused**

### Unpacking confuserEx protection

#### Using dnSpy

1. Open Binary in dnSpy then right click on the **\<Module>** and select **Go to \<Module> .cctor**

<figure><img src="../../../.gitbook/assets/image (137).png" alt=""><figcaption></figcaption></figure>

2. Search for **.free** in the searchbox to find the **gchandle.Free** function. Then set a Breakpoint on **gchandle.free**

<figure><img src="../../../.gitbook/assets/image (129).png" alt=""><figcaption></figcaption></figure>

3. Click **Start** then **OK** to run program
4. Click on the module tab. Then right click on koi and select save module.&#x20;

<figure><img src="../../../.gitbook/assets/image (131).png" alt=""><figcaption></figcaption></figure>

5. Right click and **Remove** the Binary from dnSpy
6. Open the `koi.exe` that was just dumped with dnSpy. Right click on the binary and the select **Go to \<Module> .cctor**

<figure><img src="../../../.gitbook/assets/image (132).png" alt=""><figcaption></figcaption></figure>

7. Set a breakpoint at the second module.&#x20;

<figure><img src="../../../.gitbook/assets/image (133).png" alt=""><figcaption></figcaption></figure>

8. Click on **Start** to run the program then click **OK**
9. Click on the modules tab right click on `koi.exe` and select **Save Module**
10. &#x20;Stop the debugger and then right click and remove the binary
11. Open the second `koi.exe` file in dnSpy. Right click on the binary and the select **Go to \<Module> .cctor**
12. Right click on the static module and select **Edit IL Instructions...**

<figure><img src="../../../.gitbook/assets/image (134).png" alt=""><figcaption></figcaption></figure>

13. Right click on the first module instruction and select **NOP Instruction** then click **OK**

<figure><img src="../../../.gitbook/assets/image (135).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (136).png" alt=""><figcaption></figcaption></figure>

14. Right click to remove the binary then when prompted click **Save**
15. Run the `ConfuserExConstandDecryptor.exe` select **Browse for assembly** and select the most recently saved file. Then click **Decrypt** then **Exit**. A new file will be automatically saved in the same directory as the selected file.

<figure><img src="../../../.gitbook/assets/image (138).png" alt=""><figcaption></figcaption></figure>

16. Run `ConfuserExCallFixer.exe` select **Browse for assembly** and select the most recently saved file. Then click **Patch** then **Exit**.&#x20;

<figure><img src="../../../.gitbook/assets/image (139).png" alt=""><figcaption></figcaption></figure>

17. Run `ConfuserExDupPopPatcher.exe` select **Browse for assembly** and select the most recently saved file. Then click **Patch** then **Exit**.

<figure><img src="../../../.gitbook/assets/image (140).png" alt=""><figcaption></figcaption></figure>

18. Run `ConfuserExFixer.exe` select **Browse for assembly** and select the most recently saved file. Then click on **Fix assembly** then **Exit**.&#x20;

<figure><img src="../../../.gitbook/assets/image (141).png" alt=""><figcaption></figcaption></figure>

19. &#x20;Run `ConfuserExSwitchKiller.exe` select **Browse for assembly** and select the most recently saved file. Then click on **Deobfuscate**.&#x20;
20. &#x20;Run `ConfuserExMethodsDecrypter.exe` from the `ConfuserEx Unpack` folder. Open the latest saved file then select **Decrypt**.&#x20;

<figure><img src="../../../.gitbook/assets/image (142).png" alt=""><figcaption></figcaption></figure>

21. Open a command prompt and run de4dot with the latest saved file. `de4dot crackme18.exe`

<figure><img src="../../../.gitbook/assets/image (143).png" alt=""><figcaption></figcaption></figure>

22. Open the newly saved file with dnSpy. Expand the binary and right click on koi and select **Edit Module**.&#x20;

<figure><img src="../../../.gitbook/assets/image (144).png" alt=""><figcaption></figcaption></figure>

23. For the entry point select **Managed**. Then click the box beside it.&#x20;

<figure><img src="../../../.gitbook/assets/image (146).png" alt=""><figcaption></figcaption></figure>

24. Select the **smethod\_0** located under **Class5** then click **OK.** Click **OK** again.&#x20;

<figure><img src="../../../.gitbook/assets/image (147).png" alt=""><figcaption></figcaption></figure>

25. Don't close dnSpy yet. Right click on PE section and select **Go to \<Module> .cctor**.

<figure><img src="../../../.gitbook/assets/image (148).png" alt=""><figcaption></figcaption></figure>

26. Right click on the Module and select **Edit IL Instructions**.

<figure><img src="../../../.gitbook/assets/image (149).png" alt=""><figcaption></figcaption></figure>

27. Right click every instruction and select **NOP Instruction**. Then click **OK**.&#x20;

<figure><img src="../../../.gitbook/assets/image (150).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (151).png" alt=""><figcaption></figcaption></figure>

28. Right click the binary in the main dnSpy windows and select Remove. Then when prompted save the file somewhere.&#x20;
29. Test the file here if it fails to run then we need to debug it in dnSpy. After opening the file in dnSpy click **Start** then **OK** to find the error messasge.&#x20;

<figure><img src="../../../.gitbook/assets/image (152).png" alt=""><figcaption></figcaption></figure>

30. Navigate to the Resources folder and right click on the file mentioned in the error message and select Edit Resource.&#x20;

<figure><img src="../../../.gitbook/assets/image (154).png" alt=""><figcaption></figcaption></figure>

31. Rename the file to what it expects then click on **OK**.&#x20;

<figure><img src="../../../.gitbook/assets/image (155).png" alt=""><figcaption></figcaption></figure>

32. Back in the main dnSpy windows right click on the binary and select remove and when prompted save the file.&#x20;
