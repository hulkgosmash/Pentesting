# 8. Reverse Engineering for Bugs

## Enumerating an Application

1. Load tcpview from sysinternal, In Options -> Resolve Addresses disable this option.&#x20;

## Interacting with Tivoli Storage Manager

### Hook the receive data API

Open WinDbg with administrator permissions and attach it to the FastBackServer.exe process. Next, we'll set a breakpoint on the Win32 _recv_ API located in Wsock32.dll, as shown in Listing 2.

```bash
# Set a breakpoint in WinDBG
bp vsock32!recv
# Dump 5 DWords from the stack at the address pointed to by ESP
dd esp L5
```

### PoC Code

```python
import socket
import sys

buf = bytearray([0x41]*100)

def main():
	if len(sys.argv) != 2:
		print("Usage: %s <ip_address>\n" % (sys.argv[0]))
		sys.exit(1)
	
	server = sys.argv[1]
	port = 11460

	s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	s.connect((server, port))

	s.send(buf)
	s.close()

	print("[+] Packet sent")
	sys.exit(0)


if __name__ == "__main__":
 	main()
```

<figure><img src="../../../../.gitbook/assets/image (5).png" alt=""><figcaption><p>Function prototype for recv</p></figcaption></figure>

### Process

{% code overflow="wrap" %}
```bash
# Run PoC
python PoC.py 192.168.223.10
# Dump 5 DWords from the stack add the address pointed to by ESP
dd esp L5
0d81fb58  00581ae8 00000adc 04f95058 00004400
0d81fb68  00000000
# Based on the output, any data received will be copied into the buffer located at 0x04f95058 with the maximum length of 0x4400 bytes.
# Continue the execution to the end of the recv function and examine the execution result stored in EAX.
pt
eax=00000064 ebx=0604a808 ecx=621f146d edx=77031670 esi=0604a808 edi=00669360
eip=67e71eeb esp=0d85fb58 ebp=0d85fe94 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
WSOCK32!recv+0x5b:
# Translate this to its decimal value of 100
? 0x64
Evaluate expression: 100 = 00000064
# Dump the content of the input buffer
dd 00df8058 
00df8058  41414141 41414141 41414141 41414141
00df8068  41414141 41414141 41414141 41414141
00df8078  41414141 41414141 41414141 41414141
00df8088  41414141 41414141 41414141 41414141
00df8098  41414141 41414141 41414141 41414141
00df80a8  41414141 41414141 41414141 41414141
00df80b8  41414141 00000000 00000000 00000000
00df80c8  00000000 00000000 00000000 00000000
```
{% endcode %}

### Synchronizing WinDbg and IDA Pro

{% code overflow="wrap" %}
```bash
# Determine which PE file to examine. The recv function might have been called by the FastBackServer executable itself or a DLL loaded into its memory space. We can use WinDbg to understand this by dumping the FastBackServer call stack (k):
k
 # ChildEBP RetAddr  
WARNING: Stack unwind information not available. Following frames may be wrong.
00 0d81fe94 0058164e WSOCK32!recv+0x5b
01 0d81feb0 005815d3 FastBackServer!FX_AGENT_CopyReceiveBuff+0x18
02 0d81fec0 00581320 FastBackServer!FX_AGENT_GetData+0xd
03 0d81fef0 0048ca98 FastBackServer!FX_AGENT_Cyclic+0xd0
04 0d81ff48 006693e9 FastBackServer!ORABR_Thread+0xef
05 0d81ff80 754c9564 FastBackServer!_beginthreadex+0xf4
06 0d81ff94 77c3293c KERNEL32!BaseThreadInitThunk+0x24
07 0d81ffdc 77c32910 ntdll!__RtlUserThreadStart+0x2b
08 0d81ffec 00000000 ntdll!_RtlUserThreadStart+0x1b
# Output shows that all the return addresses in the higher part of the call stack reside in FastBackServer
# Use the List Loaded Modules command (lm) to find the location of the executable on disk
lm m fastbackserver
Browse full module list
start    end        module name
00400000 00c0c000   FastBackServer   (coff symbols)         C:\Program Files\Tivoli\TSM\FastBack\server\FastBackServer.exe
# Copy exe to Kali server and load in IDA Pro. Ignore DLL warnings. 
/opt/idafree-7.0/ida64
# Single-step through the return instruction to arrive at the address FastBackServer!FX_AGENT_Receive+0x1e2
p
eax=00000064 ebx=05fecb38 ecx=7bcd602f edx=77c61670 esi=05fecb38 edi=00669360
eip=00581ae8 esp=0d81fb6c ebp=0d81fe94 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
FastBackServer!FX_AGENT_Receive+0x1e2:
00581ae8 8945f8          mov     dword ptr [ebp-8],eax ss:0023:0d81fe8c=00000001
# Search in IDA Pro for the FX_AGENT_Receive function through Jump > Jump to function.... We can right-click any function name to enter a Quick filter with the name of the function we are searching for.
# Double click the function name to land at the function's entry point.
# Follow the functions along until landing in the same memory address as the one shown in WinDBG. 

```
{% endcode %}

### Tracing the input



### Checksum, Please



```
# Find where the data is received
# Find when the data is read
```
