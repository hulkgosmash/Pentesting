# Prototype pollution

## What is prototype pollution?

Prototype pollution is a JavaScript vulnerability that enables an attacker to add arbitrary properties to global object prototypes, which may then be inherited by user-defined objects.&#x20;

<figure><img src="../../../../.gitbook/assets/prototype-pollution-infographic.svg" alt=""><figcaption></figcaption></figure>

Although prototype pollution is often unexploitable as a standalone vulnerability, it lets an attacker control properties of objects that would otherwise be inaccessible. If the application subsequently handles an attacker-controlled property in an unsafe way, this can potentially be chained with other vulnerabilities. In client-side JavaScript, this commonly leads to DOM XSS, while server-side prototype pollution can even result in remote code execution.&#x20;

## How they arise? <a href="#how-do-prototype-pollution-vulnerabilities-arise" id="how-do-prototype-pollution-vulnerabilities-arise"></a>

Prototype pollution vulnerabilities typically arise when a JavaScript function recursively merges an object containing user-controllable properties into an existing object, without first sanitizing the keys. This can allow an attacker to inject a property with a key like `__proto__`, alont with arbitrary nested properties.&#x20;

Due to the special meaning of `__proto__` in a JavaScript context, the merge operation may assign the nested properties to the object's prototype instead of the target object itself. As a result, the attacker can pollute the prototype with properties containing harmful values, which may subsequently be used the the application in a dangerous way.&#x20;

It's possible to pollute any prototype object, but this most commonly occurs with the built-in global `Object.prototype`

Successful exploitation of prototype pollution requires the following key compontents:

* **A prototype pollution source** - This is any input that enables you to poison prototype objects with arbitrary properties.&#x20;
* **A sink** - In other words, a JavaScript function or DOM element that enables arbitrary code execution.&#x20;
* **An exploitable gadget** - This is any property that is passed into a sink without proper filtering or sanitization.&#x20;

## Sources <a href="#prototype-pollution-sources" id="prototype-pollution-sources"></a>

A prototype pollution source is any user-controllable input that enables you to add arbnitrary properties to prototype objects. The most common sources are as follows.:&#x20;

### URL <a href="#prototype-pollution-via-the-url" id="prototype-pollution-via-the-url"></a>

Consider the following URL, which contains an attacker-constructed query string:

`https://vulnerable-website.com/?__proto__[evilProperty]=payload`

When breaking the query string down into `key:value` pairs, a URL parser may interpret `__proto__` as an arbitrary string. But let's look at what happens if these keys and values are subsequently merged into an existing object as properties.&#x20;

You might think that the `__proto__` property, along with its nested `evilProperty`, will just be added to the target object as follows:

```javascript
{
    existingProperty1: 'foo',
    existingProperty2: 'bar',
    __proto__: {
        evilProperty: 'payload'
    }
}
```

However, this isn't the case. At some point, the recursive merge operation may assign the value of `evilProperty` using a statement equivalent to the following:

`targetObject.__proto__.evilProperty = 'payload';`

During this assignment, the JavaScript engine treats `__proto__` as a getter for the prototype. As a result, `evilProperty` is assigned to the returned prototype object rather than the target object itself. Assuming that the target object uses the default `Object.prototype`, all objects in the JavaScript runtime will now inherit `evilProperty`, unless they already have a property of their own with a matching key.&#x20;

In practice, injecting a property called evilProperty is unlikely to have any effect. However, an attacker caqn use the same technique to pollute the prototype with properties that are used by the application, or any imported libraries.&#x20;

### JSON input <a href="#prototype-pollution-via-json-input" id="prototype-pollution-via-json-input"></a>

User-controllable objects are often derived from a JSON string using the `JSON.parse()` method. Interestingly, `JSON.parse()` also treats any key in the JSON object as an arbitrary string, including things like `__proto__`. This provides another potential vector for prototype pollution.&#x20;

Let's say an attacker injects the following malicious JSON, for example, via a web message:&#x20;

```javascript
{
    "__proto__": {
        "evilProperty": "payload"
    }
}
```

If this is converted into a JavaScript object via the `JSON.parse()` method, the resulting object will in fact have a property with the key `__proto__`:

```javascript
const objectLiteral = {__proto__: {evilProperty: 'payload'}};
const objectFromJson = JSON.parse('{"__proto__": {"evilProperty": "payload"}}');

objectLiteral.hasOwnProperty('__proto__');     // false
objectFromJson.hasOwnProperty('__proto__');    // true
```

If the object created via `JSON.parse()` is subsequently merged into an existing object without proper key sanitization, this will also lead to prototype pollution during the assignment, as we say in the URL-based example above.&#x20;

## Prototype pollution sinks <a href="#prototype-pollution-sinks" id="prototype-pollution-sinks"></a>

A prototype pollution sink is essentially just a JavaScript function or DOM element that you're able to access via prototype pollution, which enables you to execute arbitrary JavaScript or system commands. We've covered some client-side sinks extensively in our topic on DOM XSS.&#x20;

As prototype pollution lets you control properties that would otherwise be inaccessible, this potentially enables you to reach a number of additional sinks within the target application. Developers who are unfamiliar with prototype pollution may wrongly, assume that these properties are not user controllable, which means there may be only minimal filtering or sanitization in place.&#x20;

## Prototype pollution gadgets <a href="#prototype-pollution-gadgets" id="prototype-pollution-gadgets"></a>

