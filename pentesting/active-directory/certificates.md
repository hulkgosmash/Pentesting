# Certificates

## Overview

Windows Active Directory (AD) is not just for identity and access management but provides a significant amount of services to help you run and manage your organisation. A lot of these services are less commonly known or used, meaning they are often overlooked when security hardening is performed. One of these services is the Active Directory Certificate Services (AD CS).

When talking about certificates, we usually only think about the most common ones, such as those used to upgrade website traffic to HTTPS. But these are usually only used for applications that the organisation exposes to the internet. What about all those applications running on the internal network? Do we now have to give them internet access to allow them to request a certificate from a trusted Certificate Authority (CA)? Well, not really. Cue AD CS.

AD CS is Microsoft's Public Key Infrastructure (PKI) implementation. Since AD provides a level of trust in an organisation, it can be used as a CA to prove and delegate trust. AD CS is used for several things such as encrypting file systems, creating and verifying digital signatures, and even user authentication, which makes it a promising avenue for attackers. What makes it an even more dangerous attack vector, is that certificates can survive credential rotation, meaning even if a compromised account's password is reset, that would do nothing to invalidate the maliciously generated certificate, providing persistent credential theft for up to 10 years! The diagram below shows what the flow for certificate requests and generation looks like (taken from SpecterOps whitepaper):

<figure><img src="../../.gitbook/assets/6abc4f005b619e77d22020817efcd569 (2).png" alt=""><figcaption></figcaption></figure>

Since AD CS is such a privileged function, it normally runs on selected domain controllers. Meaning normal users can't really interact with the service directly. On the other side of the coin, organisations tend to be too large to have an administrator create and distribute each certificate manually. This is where certificate templates come in. Administrators of AD CS can create several templates that can allow any user with the relevant permissions to request a certificate themselves. These templates have parameters that say which user can request the certificate and what is required. What SpecterOps has found, was that specific combinations of these parameters can be incredibly toxic and be abused for privilege escalation and persistent access!

Before we dive deeper into certificate abuse, some terminology:

* **PKI** - Public Key Infrastructure is a system that manages certificates and public key encryption\

* **AD CS** - Active Directory Certificate Services is Microsoft's PKI implementation which usually runs on domain controllers
* **CA** - Certificate Authority is a PKI that issues certificates\

* **Certificate Template** - a collection of settings and policies that defines how and when a certificate may be issued by a CA
* **CSR** - Certificate Signing Request is a message sent to a CA to request a signed certificate
* **EKU** - Extended/Enhanced Key Usage are object identifiers that define how a generated certificate may be used

## Template Enumeration

```powershell
# Enumerate all templates and store them in a file
certutil -v -template > cert_templates.txt
```
