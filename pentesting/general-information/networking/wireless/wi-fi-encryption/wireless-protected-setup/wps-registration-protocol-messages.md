# WPS Registration Protocol Messages



The M1 to M8 EAP messages are specific to the WPS registration protocol and are created as follow:

1. M1 = Version || N1 || Description || PKE
2. M2 = Version || N1 || N2 || Description || PKR \[ || ConfigData ] || HMACAuthKey( M1 || M2\* )
3. M3 = Version || N2 || E-Hash1 || E-Hash2 || HMACAuthKey( M2 || M3\* )
4. M4 = Version || N1 || R-Hash1 || R-Hash2 || ENCKeyWrapKey(R-S1) || HMACAuthKey( M3 || M4\* )
5. M5 = Version || N2 || ENCKeyWrapKey(E-S1) || HMACAuthKey( M4 || M5\* )
6. M6 = Version || N1 || ENCKeyWrapKey(R-S2) || HMACAuthKey( M5 || M6\* )
7. M7 = Version || N2|| ENCKeyWrapKey(E-S2 \[||ConfigData]) || HMACAuthKey( M6 || M7\* )
8. M8 = Version || N1 || \[ ENCKeyWrapKey(ConfigData) ] || HMACAuthKey( M7 || M8\* )

The following explains the meaning of the different symbols and items used above:

* **||**: concatenation of parameters to form a message
* Subscripts are used in the context of a cryptographic function such as HMACKey. In this case, it refers to the **key** used by that function (**HMAC**)
* When a message is followed by **\***, it is referring to the message minus its HMAC-SHA-256 value
* **Version**: identifies the type of _Registration Protocol_ message
* **N1** and **N2**: 128-bit nonces (random number generated once) generated by the Enrollee and the Registrar respectively
* **Description**: human-readable description of the sending device (UUID, manufacturer, model number, MAC address, etc.) and device capabilities such as supported algorithms, I/O channels, Registration Protocol role, etc. Description data is also included in 802.11 probe request and probe response messages
* **PKE** and **PKR**: Diffie-Hellman public keys of the Enrollee and Registrar, respectively. If support for other cipher suites (such as elliptic curve) is added in the future, a different protocol Version number will be used
* **AuthKey**: authentication key derived from the Diffie-Hellman secret gAB mod p, the nonces _N1_ and _N2_, and the Enrollee’s MAC address. If M1 and M2 are both transported over a channel that is not susceptible to man-in-the-middle attacks, the Enrollee’s device password may be omitted from the key derivation
* **E-Hash1** and **E-Hash2**: pre-commitments made by the Enrollee to prove knowledge of the two halves of its own device password
* **R-Hash1** and **R-Hash2**: pre-commitments made by the Registrar to prove knowledge of the two halves of the Enrollee’s device password
* **ENCKeyWrapKey(...)**: indicates symmetric encryption of the values in parentheses using the key _KeyWrapKey_ with the AES-CBC encryption algorithm per FIPS 197, with PKCS#5 v2.0 padding
* **R-S1** and **R-S2**: secret 128-bit nonces that, together with _R-Hash1_ and _R-Hash2_, can be used by the Enrollee to confirm the Registrar’s knowledge of the first and second half of the Enrollee’s device password, respectively
* **E-S1** and **E-S2**: secret 128-bit nonces that, together with _E-Hash1_ and _E-Hash2_, can be used by the Registrar to confirm the Enrollee’s knowledge of the first and second half of the Enrollee’s device password, respectively
* **HMACAuthKey(...)**: indicates an Authenticator attribute that contains a HMAC keyed hash over the values in parentheses and using the key _AuthKey_. The keyed hash function is HMAC-SHA-256 per FIPS 180-2 and RFC-2104. To reduce message sizes, only 64 bits of the 256-bit HMAC output are included in the Authenticator attribute
* **ConfigData**: WLAN settings and credentials for the Enrollee. Additional settings for other networks and applications may also be included in _ConfigData_. Although it is shown here as always being encrypted, encryption is only mandatory for keys and key bindings and is optional for other configuration data. It is the sender’s decision whether or not to encrypt a given part of the _ConfigData_
