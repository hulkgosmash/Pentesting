# WPA Authentication

The authentication step is only done in WPA Enterprise configurations. It is based on the Extensible Authentication Protocol (EAP) and can be done with the following:

* EAP-TLS with client and server certificates
* EAP-TTLS
* PEAP for hybrid authentication where only the server certificate is required

This authentication is started when the client selects the authentication mode to use. Several EAP messages, depending on the authentication mode, will be exchanged between the authenticator and the supplicant in order to generate a Master Key (MK).

At the end of the procedure, if successful, a "Radius Accept" message is sent to the AP containing the MK and another message, an EAP message sent to the client to indicate success.

**Key Distribution and Verification**

The third phase focuses on the exchange of the different keys used for authentication, message integrity, and message encryption. This is done via the 4-way handshake to exchange the Pairwise Transient Key (PTK) and the current Group Temporal Key (GTK), respectively the keys used for unicast and multicast/broadcast, and then the Group Key handshake to renew the GTK.

This part allows:

* Confirmation of the cipher suite used
* Confirmation of the PMK knowledge by the client
* Installation of the integrity and encryption keys
* Send GTK securely

An illustration of the key distribution and verification phases is shown in Figure 8.

<figure><img src="../../../../../../.gitbook/assets/image (11) (2).png" alt=""><figcaption><p>The key distribution and verification phase</p></figcaption></figure>

**Note:** The authenticator is the AP and the supplicant is the STA.

1. The authenticator sends a nonce to the supplicant, called _ANonce_.
2. The supplicant creates the PTK and sends its nonce, _SNonce_, with the MIC. After the construction of the PTK, it will check if the supplicant has the right PMK. If the MIC check fails, the supplicant has the wrong PMK.
3. The message from the authenticator to the supplicant will contain, when WPA2/3 is used, the current GTK. This key is used to decrypt multicast/broadcast traffic. If that messages fails to be received, it is re-sent. If 802.11w is negotiated, IGTK is included. With WPA1, GTK will be sent in a later exchange.
4. Finally, the supplicant sends an acknowledgement to the authenticator. The supplicant installs the keys and starts encryption.

The group key handshake is much simpler than pairwise keys because it is done after the 4-way handshake (after installing keys) and thus we now have a secure link. It is also done via Extensible Authentication Protocol over LAN (EAPoL) messages but this time, the messages are encrypted. The diagram below illustrates this process.

<figure><img src="../../../../../../.gitbook/assets/image (16) (2).png" alt=""><figcaption><p>The group key handshake process</p></figcaption></figure>

If 802.11w is negotiated, an IGTK is sent along the GTK. The MIC is verified by the STA and acknolwedged in message 2.

This update process happens for the following reasons:

* WPA1, after the 4-way handshake
* A station joins the network
* A station leaves the network
* When a timer expires (controlled by the authenticator, the AP)
* A station can request it by sending an unsolicited confirmation message
* A station can request it by sending an EAPOL-Key frame with both Request and Group Key bits set

**Pairwise Transient Key**

In Figure 10, we have the process to generate the Pairwise Transient Key (PTK), derived from the Pairwise Master Key (PMK).

<figure><img src="../../../../../../.gitbook/assets/image (13) (1).png" alt=""><figcaption><p>The Pairwise Transient Key generation process</p></figcaption></figure>

**Input**

As input, it takes both nonce values, both MAC addresses (supplicant and authenticator), and the PMK. The PMK calculation works as follows:

If the system is WPA Personal, it uses the PBKDF2 function[2](https://portal.offensive-security.com/courses/pen-210/books-and-videos/modal/modules/wi-fi-encryption/wi-fi-protected-access/wpa-authentication#fn2) with the following values to generate the PSK (the PSK is then used as the PMK):

* Password, the passphrase
* SSID (and its length)
* The number of iterations, 4096
* The length of the result key, 256 bits

For WPA Enterprise using a Radius server, the PMK is generated from the Master Key (obtained during the exchange with the server) via the TLS-PRF function.

**Hash Algorithm**

PRF-X using HMAC-SHA1, X being 128, 192, 256, 384, 512 or 704, which indicates the size of the output in bits.

**Output**

The PTK is then divided in different keys. Below are the common parts from TKIP and CCMP:

1. Key Encryption Key (KEK) (128-bit; bits 0-127): used by the AP to encrypt additional data sent to the STA, for example, the RSN IE or the GTK
2. Key Confirmation Key (KCK) (128-bit; bits 128-255): used to compute the MIC on WPA EAPOL Key messages
3. Temporal Key (TK) (128-bit or 256-bit; bits 256-383 or 256-511): used to encrypt/decrypt unicast data packets

The CCMP PTK size is 384 bits, comprised of the three keys shown above. TKIP requires two more keys for message integrity, thus increasing the PTK size to 512 bits:

* MIC TX Key (64-bit; bits 384-447): used to compute MIC on unicast data packets sent by the AP
* MIC RX Key (64-bit; bits 448-511): used to compute MIC on unicast data packets sent by the STA

TK is 128-bit unless the following cipher suites are used:

* WEP-40 (40 bits)
* WEP-104 (104 bits)
* GCMP-256 (256-bits)
* CCMP-256 (256-bits)
* BIP-GMAC-256 (256-bits)
* BIP-CMAC-256 (256-bits)

**Group Temporal Key**

The GTK is used to encrypt and decrypt multicast/broadcast traffic. Its construction takes place according to the following illustration. Note that the GTK is just a random number, which means any pseudorandom function can be used to generate it.

<figure><img src="../../../../../../.gitbook/assets/image (28).png" alt=""><figcaption><p>The GTK construction process</p></figcaption></figure>

**Data Encryption and Integrity**

There are three different algorithms that can be used for data encryption and integrity:

* Temporal Key Integrity Protocol (TKIP)[3](https://portal.offensive-security.com/courses/pen-210/books-and-videos/modal/modules/wi-fi-encryption/wi-fi-protected-access/wpa-authentication#fn3)
* Counter Mode with CBC-MAC (CCMP)[4](https://portal.offensive-security.com/courses/pen-210/books-and-videos/modal/modules/wi-fi-encryption/wi-fi-protected-access/wpa-authentication#fn4)
* Wireless Robust Authenticated Protocol (WRAP)[5](https://portal.offensive-security.com/courses/pen-210/books-and-videos/modal/modules/wi-fi-encryption/wi-fi-protected-access/wpa-authentication#fn5)

These algorithms are far more complex than WEP and will not be detailed here.

**Temporal Key Integrity Protocol**

The following diagram shows the different fields in a TKIP encrypted frame:

<figure><img src="../../../../../../.gitbook/assets/image (4) (1) (3).png" alt=""><figcaption><p>A TKIP encrypted frame</p></figcaption></figure>

**Counter Mode with CBC-MAC**

13 below shows the different fields in a CCMP encrypted frame:

<figure><img src="../../../../../../.gitbook/assets/image (25) (1).png" alt=""><figcaption><p>A CCMP encrypted frame</p></figcaption></figure>

**Wireless Robust Authenticated Protocol**

WRAP is based on AES but uses the Offset Codebook Mode (OCB) cipher and authentication scheme. It was the first to be selected by the 802.11i working group but was abandoned due to intellectual property reasons.
