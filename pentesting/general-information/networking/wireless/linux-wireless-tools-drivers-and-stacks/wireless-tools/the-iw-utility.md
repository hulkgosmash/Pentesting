# The iw Utility

Even though we could still use iwconfig and other tools thanks to a compatibility layer, they are deprecated and we shouldn't use them anymore. The iw utility and its variety of options is the only command we need for configuring a Wi-Fi device.

Assuming the drivers have been loaded properly, running iw list will provide us with lots of detailed information about the wireless devices and their capabilities:

```bash
sudo iw list
```

The listing above shows the card supports a number of modes, including IBSS (ad hoc), monitor mode, managed mode (client), and AP mode. It also lists frequencies allowed. Channel 1 to 13 are allowed 20dBm, and 14 is forbidden.

To get a listing of wireless access points that are within range of our wireless card, we will use iw with the dev wlan0 option, which specifies our device. Next, we'll add the scan parameter. We then pipe this command through grep SSID to filter our output to only wireless network names:

```bash
sudo iw dev wlan0 scan | grep SSID
```

The channel number that a target access point is transmitting is a critical piece of information. The iw dev scan output can be further refined by piping the results with egrep using the logical OR operator (|) to output strings which either contain "DS Parameter set" or "SSID:":

```bash
sudo iw dev wlan0 scan | egrep "DS Parameter set|SSID:"
```

With some of the basic commands out of the way, we will create a new Virtual Interface (VIF) named "wlan0mon" in monitor mode. These iw commands will seem complex but once we break them down a bit, we'll notice that the logic they follow is pretty simple.

We again specify our device with iw dev wlan0. Then we add an interface with the interface option and the add parameter followed by its name (wlan0mon). Lastly the type option with monitor places our new interface in monitor mode:

```bash
sudo iw dev wlan0 interface add wlan0mon type monitor
```

As with many commands, when there is no output displayed, we know the command was successful. With the new interface created, we need to bring it up with ip (newly created interfaces are down by default):

```bash
sudo ip link set wlan0mon up
```

Using the iw dev info command, we will be able to inspect our newly created monitor mode interface:

```bash
sudo iw dev wlan0mon info
```

Let's verify our card is in monitor mode by starting a sniffer, tcpdump, to capture wireless frames:

```bash
sudo tcpdump -i wlan0mon
```

Running this command in our lab environment will display a great deal of traffic on the wlan0mon interface. Pressing C+c will stop the capture.

In the example above, we notice a beacon on channel 3 with the SSID "wifu".

Once we have finished with our VAP, we will want to delete it with the iw command and the del option. Once we've done that, let's confirm it worked with info:

```bash
sudo iw dev wlan0mon interface del
sudo iw dev wlan0mon info
```

Central Regulatory Domain Agent (CRDA), helps radios stay compliant with wireless regulations around the world. It is used by the cfg80211 wireless subsystem to enforce the regulatory domain settings for a given location. Countries' regulations can be fairly complex, and CRDA sets the radio to operate within the regulations of the operating country. Specifically, it enforces transmit power limits on the radio, prevents the radio from transmitting on restricted frequencies, and abides by any other limitation such as DFS. The iw reg command interacts with CRDA to query, and in some cases, change it.

Manufacturers may also set limitations on the hardware of a device depending on where it is sold. For example, Intel wireless cards sold in the US cannot go beyond channel 11. In addition, Mikrotik prevents their international models with greater frequency ranges from being sold in the US.

To display the current regulatory domain, we use iw reg get:

```bash
sudo iw reg get
```

By default, Kali is set to global regulatory domain (00).

To change or set the regulatory domain, we run iw reg set \<COUNTRY> where "COUNTRY" is the 2 letter code (ISO/IEC 3166-1 alpha 2 more precisely) for the country we are currently in. For the US, we would run iw reg set US. The command will not output anything when successful.

The change is not permanent as the setting is only in memory. To make sure it is always set at boot time, edit /etc/default/crda with a text editor, and fill in the _REGDOMAIN_ variable:

<figure><img src="../../../../../../.gitbook/assets/a62db69f531b74faedd47769e3479f69-nano_crda_highlight.png" alt=""><figcaption><p>sudo nano /etc/default/crda</p></figcaption></figure>

After rebooting, let's confirm the regulatory domain has been set with iw reg get again:

```bash
sudo iw reg get
```

In summary, here is what we can learn from the output:

* In the 2.4GHz band, transmitting is allowed between 2.402GHz and 2.472GHz with up to 40MHz channel width and up to 30dBi power.
* In the 5GHz band, 5.170 to 5.250GHz is allowed with up to 80MHz channels at 23dBi, 5.250 to 5330GHz with up to 80MHz channels at 23dBi with DFS, 5.490 to 5.730GHz with up to 160MHz channels at 23dBi and DFS, 5.735 to 5.835 with up to 80MHz channels and up to 30dBi.
* In the 60GHz band, 57.240 to 63.720 GHz is allowed with channels up to 2.160GHz at 40dBi.

The regulatory domain we set can sometimes be overridden. CRDA rules processing is fairly complex, and other factors comes into play to ensure the correct regulatory domain is used. For example, it will be overridden when connecting to an AP that is advertising a country. Some APs allow us to set a country, and will advertise it in their beacons. That may include detailed information on what channels are authorized.

A wireless card can sometimes advertise their regulatory domain through the driver. When plugging in the Alfa AWUS036NHA, it advertises its regulatory domain as GB:

```bash
sudo iw reg get
```

Since our card is 2.4GHz only, the GB's regulatory domain allows 2402 to 2482MHz, which would allow channel 12 and 13, while the US only allows channel 1 to 11. For this reason, the output of iw list shows channels 12 and 13 disabled, following the more restrictive regulation from the US regulatory domain.

```bash
sudo iw list
```
